<!-- HTML generated using hilite.me --><div style="background: #202020; overflow:auto;width:auto;padding:.2em .6em;"><pre style="background: #202020; margin: 0; line-height: 125%">
<span style="color: #6ab825; font-weight: bold">namespace</span> <span style="color: #d0d0d0">Craft;</span>

<span style="color: #40ffff">$request_headers</span>        <span style="color: #d0d0d0">=</span> <span style="color: #24909d">apache_request_headers</span><span style="color: #d0d0d0">();</span>
<span style="color: #40ffff">$http_origin</span> <span style="color: #d0d0d0">=</span><span style="color: #ed9d13">&#39;&#39;</span><span style="color: #d0d0d0">;</span>
<span style="color: #6ab825; font-weight: bold">if</span><span style="color: #d0d0d0">(</span><span style="color: #24909d">array_key_exists</span><span style="color: #d0d0d0">(</span> <span style="color: #ed9d13">&#39;Origin&#39;</span> <span style="color: #d0d0d0">,</span> <span style="color: #40ffff">$request_headers</span> <span style="color: #d0d0d0">))</span> <span style="color: #40ffff">$http_origin</span> <span style="color: #d0d0d0">=</span> <span style="color: #40ffff">$request_headers</span><span style="color: #d0d0d0">[</span><span style="color: #ed9d13">&#39;Origin&#39;</span><span style="color: #d0d0d0">];</span>

<span style="color: #40ffff">$allowed_http_origins</span>   <span style="color: #d0d0d0">=</span> <span style="color: #6ab825; font-weight: bold">array</span><span style="color: #d0d0d0">(</span>
                            <span style="color: #ed9d13">&quot;http://www.infocus.com&quot;</span>   <span style="color: #d0d0d0">,</span>
                            <span style="color: #ed9d13">&quot;http://dev.infocus.com&quot;</span>  <span style="color: #d0d0d0">,</span>
                            <span style="color: #ed9d13">&quot;http://infocuscorp.zendesk.com&quot;</span>  <span style="color: #d0d0d0">,</span>
                            <span style="color: #ed9d13">&quot;https://www.infocus.com&quot;</span>   <span style="color: #d0d0d0">,</span>
                            <span style="color: #ed9d13">&quot;https://dev.infocus.com&quot;</span>  <span style="color: #d0d0d0">,</span>
                            <span style="color: #ed9d13">&quot;https://infocuscorp.zendesk.com&quot;</span>  <span style="color: #d0d0d0">,</span>
                          <span style="color: #d0d0d0">);</span>
<span style="color: #6ab825; font-weight: bold">if</span> <span style="color: #d0d0d0">(</span><span style="color: #24909d">in_array</span><span style="color: #d0d0d0">(</span><span style="color: #40ffff">$http_origin</span><span style="color: #d0d0d0">,</span> <span style="color: #40ffff">$allowed_http_origins</span><span style="color: #d0d0d0">)){</span>  
    <span style="color: #d0d0d0">@header(</span><span style="color: #ed9d13">&quot;Access-Control-Allow-Origin: &quot;</span> <span style="color: #d0d0d0">.</span> <span style="color: #40ffff">$http_origin</span><span style="color: #d0d0d0">);</span>
<span style="color: #d0d0d0">}</span>

    <span style="color: #24909d">define</span><span style="color: #d0d0d0">(</span><span style="color: #ed9d13">&quot;IFCAPIKEY&quot;</span><span style="color: #d0d0d0">,</span> <span style="color: #ed9d13">&quot;918192e2-2367-11e6-ae91-5254004071d9&quot;</span><span style="color: #d0d0d0">);</span>
    <span style="color: #24909d">define</span><span style="color: #d0d0d0">(</span><span style="color: #ed9d13">&quot;ZDAPIKEY&quot;</span><span style="color: #d0d0d0">,</span> <span style="color: #ed9d13">&quot;D0f1VgtLF69RV7QuGOGdt4RbBEVA1irijFGliF5k&quot;</span><span style="color: #d0d0d0">);</span>
    <span style="color: #24909d">define</span><span style="color: #d0d0d0">(</span><span style="color: #ed9d13">&quot;ZDUSER&quot;</span><span style="color: #d0d0d0">,</span> <span style="color: #ed9d13">&quot;administrator@infocus.com&quot;</span><span style="color: #d0d0d0">);</span>
    <span style="color: #24909d">define</span><span style="color: #d0d0d0">(</span><span style="color: #ed9d13">&quot;ZDURL&quot;</span><span style="color: #d0d0d0">,</span> <span style="color: #ed9d13">&quot;https://infocuscorp.zendesk.com/api/v2&quot;</span><span style="color: #d0d0d0">);</span>

<span style="color: #6ab825; font-weight: bold">class</span> <span style="color: #447fcf; text-decoration: underline">Service_ApiController</span> <span style="color: #6ab825; font-weight: bold">extends</span> <span style="color: #d0d0d0">BaseController</span>
<span style="color: #d0d0d0">{</span>
	<span style="color: #6ab825; font-weight: bold">protected</span> <span style="color: #40ffff">$allowAnonymous</span> <span style="color: #d0d0d0">=</span> <span style="color: #6ab825; font-weight: bold">true</span><span style="color: #d0d0d0">;</span>
   	<span style="color: #6ab825; font-weight: bold">private</span> <span style="color: #40ffff">$db</span><span style="color: #d0d0d0">;</span>
   	<span style="color: #6ab825; font-weight: bold">private</span> <span style="color: #40ffff">$mysqli</span><span style="color: #d0d0d0">;</span>
   	<span style="color: #6ab825; font-weight: bold">private</span> <span style="color: #40ffff">$regobj</span><span style="color: #d0d0d0">;</span>

	<span style="color: #6ab825; font-weight: bold">function</span> <span style="color: #447fcf">__construct</span><span style="color: #d0d0d0">(){</span>
		<span style="color: #40ffff">$this</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">db</span> <span style="color: #d0d0d0">=</span> <span style="color: #6ab825; font-weight: bold">include</span> <span style="color: #d0d0d0">CRAFT_CONFIG_PATH</span> <span style="color: #d0d0d0">.</span><span style="color: #ed9d13">&quot;/db.php&quot;</span><span style="color: #d0d0d0">;</span>
		<span style="color: #40ffff">$this</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">mysqli</span> <span style="color: #d0d0d0">=</span> <span style="color: #6ab825; font-weight: bold">new</span> <span style="color: #d0d0d0">\mysqli(</span><span style="color: #40ffff">$this</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">db</span><span style="color: #d0d0d0">[</span><span style="color: #ed9d13">&#39;server&#39;</span><span style="color: #d0d0d0">],</span><span style="color: #40ffff">$this</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">db</span><span style="color: #d0d0d0">[</span><span style="color: #ed9d13">&#39;user&#39;</span><span style="color: #d0d0d0">],</span><span style="color: #40ffff">$this</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">db</span><span style="color: #d0d0d0">[</span><span style="color: #ed9d13">&#39;password&#39;</span><span style="color: #d0d0d0">],</span><span style="color: #ed9d13">&#39;install_base&#39;</span><span style="color: #d0d0d0">);</span>
	<span style="color: #d0d0d0">}</span>

	<span style="color: #6ab825; font-weight: bold">private</span> <span style="color: #6ab825; font-weight: bold">function</span> <span style="color: #447fcf">sanitizeSerial</span><span style="color: #d0d0d0">(</span><span style="color: #40ffff">$serial</span><span style="color: #d0d0d0">){</span>
		<span style="color: #6ab825; font-weight: bold">return</span> <span style="color: #d0d0d0">strtoupper(</span><span style="color: #40ffff">$this</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">mysqli</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">real_escape_string</span><span style="color: #d0d0d0">(</span><span style="color: #24909d">str_replace</span><span style="color: #d0d0d0">(</span><span style="color: #6ab825; font-weight: bold">array</span><span style="color: #d0d0d0">(</span><span style="color: #ed9d13">&quot;-&quot;</span><span style="color: #d0d0d0">,</span><span style="color: #ed9d13">&quot;1S&quot;</span><span style="color: #d0d0d0">,</span><span style="color: #ed9d13">&quot; &quot;</span><span style="color: #d0d0d0">),</span><span style="color: #ed9d13">&quot;&quot;</span><span style="color: #d0d0d0">,</span><span style="color: #40ffff">$serial</span><span style="color: #d0d0d0">)));</span>
	<span style="color: #d0d0d0">}</span>

	<span style="color: #6ab825; font-weight: bold">private</span> <span style="color: #6ab825; font-weight: bold">function</span> <span style="color: #447fcf">curl</span><span style="color: #d0d0d0">(</span><span style="color: #40ffff">$url</span><span style="color: #d0d0d0">,</span> <span style="color: #40ffff">$json</span><span style="color: #d0d0d0">=</span><span style="color: #ed9d13">&#39;&#39;</span><span style="color: #d0d0d0">,</span><span style="color: #40ffff">$request</span><span style="color: #d0d0d0">=</span><span style="color: #ed9d13">&#39;GET&#39;</span><span style="color: #d0d0d0">,</span> <span style="color: #40ffff">$file_tmp</span> <span style="color: #d0d0d0">=</span> <span style="color: #6ab825; font-weight: bold">null</span><span style="color: #d0d0d0">)</span>	<span style="color: #d0d0d0">{</span>
		<span style="color: #40ffff">$ch</span> <span style="color: #d0d0d0">=</span> <span style="color: #24909d">curl_init</span><span style="color: #d0d0d0">();</span>
		<span style="color: #24909d">curl_setopt</span><span style="color: #d0d0d0">(</span><span style="color: #40ffff">$ch</span><span style="color: #d0d0d0">,</span> <span style="color: #d0d0d0">CURLOPT_URL,</span> <span style="color: #d0d0d0">ZDURL.</span><span style="color: #40ffff">$url</span><span style="color: #d0d0d0">);</span>
		<span style="color: #24909d">curl_setopt</span><span style="color: #d0d0d0">(</span><span style="color: #40ffff">$ch</span><span style="color: #d0d0d0">,</span> <span style="color: #d0d0d0">CURLOPT_USERPWD,</span> <span style="color: #d0d0d0">ZDUSER.</span><span style="color: #ed9d13">&quot;/token:&quot;</span><span style="color: #d0d0d0">.ZDAPIKEY);</span>
		<span style="color: #6ab825; font-weight: bold">if</span><span style="color: #d0d0d0">(</span><span style="color: #40ffff">$request</span> <span style="color: #d0d0d0">==</span> <span style="color: #ed9d13">&#39;post&#39;</span><span style="color: #d0d0d0">){</span>
			<span style="color: #24909d">curl_setopt</span><span style="color: #d0d0d0">(</span><span style="color: #40ffff">$ch</span><span style="color: #d0d0d0">,</span> <span style="color: #d0d0d0">CURLOPT_FOLLOWLOCATION,</span> <span style="color: #6ab825; font-weight: bold">true</span> <span style="color: #d0d0d0">);</span>
			<span style="color: #24909d">curl_setopt</span><span style="color: #d0d0d0">(</span><span style="color: #40ffff">$ch</span><span style="color: #d0d0d0">,</span> <span style="color: #d0d0d0">CURLOPT_MAXREDIRS,</span> <span style="color: #3677a9">10</span> <span style="color: #d0d0d0">);</span>
			<span style="color: #24909d">curl_setopt</span><span style="color: #d0d0d0">(</span><span style="color: #40ffff">$ch</span><span style="color: #d0d0d0">,</span> <span style="color: #d0d0d0">CURLOPT_CUSTOMREQUEST,</span> <span style="color: #ed9d13">&quot;POST&quot;</span><span style="color: #d0d0d0">);</span>
			<span style="color: #24909d">curl_setopt</span><span style="color: #d0d0d0">(</span><span style="color: #40ffff">$ch</span><span style="color: #d0d0d0">,</span> <span style="color: #d0d0d0">CURLOPT_HTTPHEADER,</span> <span style="color: #6ab825; font-weight: bold">array</span><span style="color: #d0d0d0">(</span><span style="color: #ed9d13">&#39;Content-type: application/json&#39;</span><span style="color: #d0d0d0">));</span>
			<span style="color: #24909d">curl_setopt</span><span style="color: #d0d0d0">(</span><span style="color: #40ffff">$ch</span><span style="color: #d0d0d0">,</span> <span style="color: #d0d0d0">CURLOPT_USERAGENT,</span> <span style="color: #ed9d13">&quot;MozillaXYZ/1.0&quot;</span><span style="color: #d0d0d0">);</span>
			<span style="color: #6ab825; font-weight: bold">if</span><span style="color: #d0d0d0">(</span><span style="color: #40ffff">$file_tmp</span> <span style="color: #d0d0d0">==</span> <span style="color: #6ab825; font-weight: bold">null</span><span style="color: #d0d0d0">)</span> <span style="color: #24909d">curl_setopt</span><span style="color: #d0d0d0">(</span><span style="color: #40ffff">$ch</span><span style="color: #d0d0d0">,</span> <span style="color: #d0d0d0">CURLOPT_POSTFIELDS,</span> <span style="color: #40ffff">$json</span><span style="color: #d0d0d0">);</span>
				<span style="color: #6ab825; font-weight: bold">else</span><span style="color: #d0d0d0">{</span>
					<span style="color: #24909d">curl_setopt</span><span style="color: #d0d0d0">(</span><span style="color: #40ffff">$ch</span><span style="color: #d0d0d0">,</span> <span style="color: #d0d0d0">CURLOPT_HTTPHEADER,</span> <span style="color: #6ab825; font-weight: bold">array</span><span style="color: #d0d0d0">(</span><span style="color: #ed9d13">&#39;Content-type: application/binary&#39;</span><span style="color: #d0d0d0">));</span>
					<span style="color: #40ffff">$file</span> <span style="color: #d0d0d0">=</span> <span style="color: #24909d">fopen</span><span style="color: #d0d0d0">(</span><span style="color: #40ffff">$file_tmp</span><span style="color: #d0d0d0">,</span> <span style="color: #ed9d13">&#39;r&#39;</span><span style="color: #d0d0d0">);</span>
					<span style="color: #40ffff">$size</span> <span style="color: #d0d0d0">=</span> <span style="color: #24909d">filesize</span><span style="color: #d0d0d0">(</span><span style="color: #40ffff">$file_tmp</span><span style="color: #d0d0d0">);</span>
					<span style="color: #40ffff">$fildata</span> <span style="color: #d0d0d0">=</span> <span style="color: #24909d">fread</span><span style="color: #d0d0d0">(</span><span style="color: #40ffff">$file</span><span style="color: #d0d0d0">,</span><span style="color: #40ffff">$size</span><span style="color: #d0d0d0">);</span>
					<span style="color: #24909d">curl_setopt</span><span style="color: #d0d0d0">(</span><span style="color: #40ffff">$ch</span><span style="color: #d0d0d0">,</span> <span style="color: #d0d0d0">CURLOPT_POSTFIELDS,</span> <span style="color: #40ffff">$fildata</span><span style="color: #d0d0d0">);</span>
					<span style="color: #24909d">curl_setopt</span><span style="color: #d0d0d0">(</span><span style="color: #40ffff">$ch</span><span style="color: #d0d0d0">,</span> <span style="color: #d0d0d0">CURLOPT_INFILE,</span> <span style="color: #40ffff">$file</span><span style="color: #d0d0d0">);</span>
					<span style="color: #24909d">curl_setopt</span><span style="color: #d0d0d0">(</span><span style="color: #40ffff">$ch</span><span style="color: #d0d0d0">,</span> <span style="color: #d0d0d0">CURLOPT_INFILESIZE,</span> <span style="color: #40ffff">$size</span><span style="color: #d0d0d0">);</span>
					<span style="color: #24909d">curl_setopt</span><span style="color: #d0d0d0">(</span><span style="color: #40ffff">$ch</span><span style="color: #d0d0d0">,</span> <span style="color: #d0d0d0">CURLOPT_VERBOSE,</span> <span style="color: #6ab825; font-weight: bold">true</span><span style="color: #d0d0d0">);</span>
				<span style="color: #d0d0d0">}</span>
			<span style="color: #24909d">curl_setopt</span><span style="color: #d0d0d0">(</span><span style="color: #40ffff">$ch</span><span style="color: #d0d0d0">,</span> <span style="color: #d0d0d0">CURLOPT_TIMEOUT,</span> <span style="color: #3677a9">10</span><span style="color: #d0d0d0">);</span>
		<span style="color: #d0d0d0">}</span>
		<span style="color: #6ab825; font-weight: bold">else</span> <span style="color: #24909d">curl_setopt</span><span style="color: #d0d0d0">(</span><span style="color: #40ffff">$ch</span><span style="color: #d0d0d0">,</span> <span style="color: #d0d0d0">CURLOPT_CUSTOMREQUEST,</span> <span style="color: #40ffff">$request</span><span style="color: #d0d0d0">);</span>
		<span style="color: #24909d">curl_setopt</span><span style="color: #d0d0d0">(</span><span style="color: #40ffff">$ch</span><span style="color: #d0d0d0">,</span> <span style="color: #d0d0d0">CURLOPT_RETURNTRANSFER,</span> <span style="color: #6ab825; font-weight: bold">true</span><span style="color: #d0d0d0">);</span>
		<span style="color: #40ffff">$output</span> <span style="color: #d0d0d0">=</span> <span style="color: #24909d">curl_exec</span><span style="color: #d0d0d0">(</span><span style="color: #40ffff">$ch</span><span style="color: #d0d0d0">);</span>
		<span style="color: #40ffff">$info</span> <span style="color: #d0d0d0">=</span> <span style="color: #24909d">curl_getinfo</span><span style="color: #d0d0d0">(</span><span style="color: #40ffff">$ch</span><span style="color: #d0d0d0">);</span>
		<span style="color: #24909d">curl_close</span><span style="color: #d0d0d0">(</span><span style="color: #40ffff">$ch</span><span style="color: #d0d0d0">);</span>
		<span style="color: #40ffff">$decoded</span> <span style="color: #d0d0d0">=</span> <span style="color: #24909d">json_decode</span><span style="color: #d0d0d0">(</span><span style="color: #40ffff">$output</span><span style="color: #d0d0d0">);</span>
		<span style="color: #6ab825; font-weight: bold">return</span> <span style="color: #40ffff">$decoded</span><span style="color: #d0d0d0">;</span>
	<span style="color: #d0d0d0">}</span>

   <span style="color: #6ab825; font-weight: bold">public</span> <span style="color: #6ab825; font-weight: bold">function</span> <span style="color: #447fcf">actionSubmitAxTransaction</span><span style="color: #d0d0d0">()</span>
    <span style="color: #d0d0d0">{</span>
    	<span style="color: #999999; font-style: italic">//$this-&gt;requireLogin();</span>
		<span style="color: #40ffff">$this</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">mysqli</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">select_db</span><span style="color: #d0d0d0">(</span><span style="color: #ed9d13">&#39;infocus_internal&#39;</span><span style="color: #d0d0d0">);</span>
		<span style="color: #40ffff">$id</span> <span style="color: #d0d0d0">=</span> <span style="color: #d0d0d0">craft()-&gt;</span><span style="color: #bbbbbb">request</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">getPost</span><span style="color: #d0d0d0">(</span><span style="color: #ed9d13">&#39;ID&#39;</span><span style="color: #d0d0d0">);</span>
		<span style="color: #6ab825; font-weight: bold">if</span><span style="color: #d0d0d0">(!</span><span style="color: #40ffff">$id</span> <span style="color: #6ab825; font-weight: bold">OR</span> <span style="color: #40ffff">$id</span> <span style="color: #d0d0d0">==</span> <span style="color: #ed9d13">&quot;ZDCase# &quot;</span><span style="color: #d0d0d0">)</span> <span style="color: #40ffff">$this</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">returnJson</span><span style="color: #d0d0d0">(</span><span style="color: #ed9d13">&quot;Unique ID required to submit AX Transaction&quot;</span><span style="color: #d0d0d0">);</span>
		<span style="color: #6ab825; font-weight: bold">if</span><span style="color: #d0d0d0">(!craft()-&gt;</span><span style="color: #bbbbbb">request</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">getPost</span><span style="color: #d0d0d0">(</span><span style="color: #ed9d13">&#39;productout&#39;</span><span style="color: #d0d0d0">)</span> <span style="color: #6ab825; font-weight: bold">OR</span> <span style="color: #d0d0d0">craft()-&gt;</span><span style="color: #bbbbbb">request</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">getPost</span><span style="color: #d0d0d0">(</span><span style="color: #ed9d13">&#39;productout&#39;</span><span style="color: #d0d0d0">)</span> <span style="color: #d0d0d0">==</span> <span style="color: #ed9d13">&quot;&quot;</span><span style="color: #d0d0d0">)</span> <span style="color: #40ffff">$this</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">returnJson</span><span style="color: #d0d0d0">(</span><span style="color: #ed9d13">&quot;outbound product required to submit AX Transaction&quot;</span><span style="color: #d0d0d0">);</span>

		<span style="color: #6ab825; font-weight: bold">if</span><span style="color: #d0d0d0">(craft()-&gt;</span><span style="color: #bbbbbb">request</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">getPost</span><span style="color: #d0d0d0">(</span><span style="color: #ed9d13">&#39;orderpool&#39;</span><span style="color: #d0d0d0">)</span> <span style="color: #d0d0d0">==</span> <span style="color: #ed9d13">&quot;NCO SVC&quot;</span> <span style="color: #6ab825; font-weight: bold">or</span> <span style="color: #d0d0d0">craft()-&gt;</span><span style="color: #bbbbbb">request</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">getPost</span><span style="color: #d0d0d0">(</span><span style="color: #ed9d13">&#39;orderpool&#39;</span><span style="color: #d0d0d0">)</span> <span style="color: #d0d0d0">==</span> <span style="color: #ed9d13">&quot;STANDARD&quot;</span><span style="color: #d0d0d0">)</span> <span style="color: #40ffff">$qty</span> <span style="color: #d0d0d0">=</span> <span style="color: #3677a9">1</span><span style="color: #d0d0d0">;</span>
			<span style="color: #6ab825; font-weight: bold">else</span> <span style="color: #40ffff">$qty</span> <span style="color: #d0d0d0">=</span> <span style="color: #d0d0d0">-</span><span style="color: #3677a9">1</span><span style="color: #d0d0d0">;</span>

		<span style="color: #40ffff">$sql</span> <span style="color: #d0d0d0">=</span> <span style="color: #ed9d13">&quot;SELECT id, rma, sales_order FROM ax_transactions WHERE `id` = &#39;$id&#39; AND (`status` = &#39;Closed&#39; OR `status` = &#39;Processed&#39;)&quot;</span><span style="color: #d0d0d0">;</span>
		<span style="color: #40ffff">$result</span> <span style="color: #d0d0d0">=</span> <span style="color: #40ffff">$this</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">mysqli</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">query</span><span style="color: #d0d0d0">(</span><span style="color: #40ffff">$sql</span><span style="color: #d0d0d0">);</span>

		<span style="color: #6ab825; font-weight: bold">if</span><span style="color: #d0d0d0">(</span><span style="color: #40ffff">$result</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">num_rows</span><span style="color: #d0d0d0">&gt;</span><span style="color: #3677a9">0</span><span style="color: #d0d0d0">){</span>
			<span style="color: #40ffff">$response</span> <span style="color: #d0d0d0">=</span> <span style="color: #ed9d13">&quot;Changes cannot be made to Completed Orders.&lt; br&gt;&quot;</span><span style="color: #d0d0d0">;</span>
			<span style="color: #6ab825; font-weight: bold">while</span><span style="color: #d0d0d0">(</span><span style="color: #40ffff">$row</span> <span style="color: #d0d0d0">=</span> <span style="color: #40ffff">$result</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">fetch_assoc</span><span style="color: #d0d0d0">())</span>
			<span style="color: #d0d0d0">{</span>
				<span style="color: #40ffff">$response</span> <span style="color: #d0d0d0">.=</span>  <span style="color: #ed9d13">&quot;RMA:&quot;</span> <span style="color: #d0d0d0">.</span> <span style="color: #40ffff">$row</span><span style="color: #d0d0d0">[</span><span style="color: #ed9d13">&#39;rma&#39;</span><span style="color: #d0d0d0">]</span> <span style="color: #d0d0d0">.</span> <span style="color: #ed9d13">&quot;&lt; br&gt;&quot;</span><span style="color: #d0d0d0">;</span>
				<span style="color: #40ffff">$response</span> <span style="color: #d0d0d0">.=</span>  <span style="color: #ed9d13">&quot;SO:&quot;</span> <span style="color: #d0d0d0">.</span> <span style="color: #40ffff">$row</span><span style="color: #d0d0d0">[</span><span style="color: #ed9d13">&#39;sales_order&#39;</span><span style="color: #d0d0d0">]</span> <span style="color: #d0d0d0">.</span> <span style="color: #ed9d13">&quot;&lt; br&gt;&quot;</span><span style="color: #d0d0d0">;</span>
			<span style="color: #d0d0d0">}</span>
			<span style="color: #40ffff">$this</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">returnJson</span><span style="color: #d0d0d0">(</span><span style="color: #40ffff">$response</span><span style="color: #d0d0d0">);</span>
		<span style="color: #d0d0d0">}</span>

		<span style="color: #40ffff">$sql</span> <span style="color: #d0d0d0">=</span> <span style="color: #ed9d13">&quot;SELECT id FROM ax_transactions WHERE `id` = &#39;$id&#39; AND `status` = &#39;Processing&#39;&quot;</span><span style="color: #d0d0d0">;</span>
		<span style="color: #40ffff">$result</span> <span style="color: #d0d0d0">=</span> <span style="color: #40ffff">$this</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">mysqli</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">query</span><span style="color: #d0d0d0">(</span><span style="color: #40ffff">$sql</span><span style="color: #d0d0d0">);</span>

		<span style="color: #6ab825; font-weight: bold">if</span><span style="color: #d0d0d0">(</span><span style="color: #40ffff">$result</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">num_rows</span><span style="color: #d0d0d0">&gt;</span><span style="color: #3677a9">0</span><span style="color: #d0d0d0">)</span> <span style="color: #40ffff">$this</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">returnJson</span><span style="color: #d0d0d0">(</span><span style="color: #ed9d13">&quot;Row already exists and is in &#39;Processing&#39; status.  No changes can be made.&quot;</span><span style="color: #d0d0d0">);</span>

		<span style="color: #40ffff">$sql</span> <span style="color: #d0d0d0">=</span> <span style="color: #ed9d13">&quot;SELECT id FROM ax_transactions WHERE `id` = &#39;$id&#39;&quot;</span><span style="color: #d0d0d0">;</span>
		<span style="color: #40ffff">$result</span> <span style="color: #d0d0d0">=</span> <span style="color: #40ffff">$this</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">mysqli</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">query</span><span style="color: #d0d0d0">(</span><span style="color: #40ffff">$sql</span><span style="color: #d0d0d0">);</span>

		<span style="color: #6ab825; font-weight: bold">if</span><span style="color: #d0d0d0">(</span><span style="color: #40ffff">$result</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">num_rows</span><span style="color: #d0d0d0">==</span><span style="color: #3677a9">0</span><span style="color: #d0d0d0">){</span>
			<span style="color: #6ab825; font-weight: bold">if</span><span style="color: #d0d0d0">(</span><span style="color: #24909d">strlen</span><span style="color: #d0d0d0">(craft()-&gt;</span><span style="color: #bbbbbb">request</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">getPost</span><span style="color: #d0d0d0">(</span><span style="color: #ed9d13">&#39;Org&#39;</span><span style="color: #d0d0d0">))&gt;</span><span style="color: #3677a9">1</span> <span style="color: #6ab825; font-weight: bold">AND</span> <span style="color: #24909d">strlen</span><span style="color: #d0d0d0">(craft()-&gt;</span><span style="color: #bbbbbb">request</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">getPost</span><span style="color: #d0d0d0">(</span><span style="color: #ed9d13">&#39;Accnt&#39;</span><span style="color: #d0d0d0">))</span> <span style="color: #d0d0d0">&lt;</span> <span style="color: #3677a9">3</span><span style="color: #d0d0d0">)</span>	<span style="color: #d0d0d0">{</span>
				<span style="color: #40ffff">$sql</span> <span style="color: #d0d0d0">=</span> <span style="color: #ed9d13">&quot;SELECT id FROM ax_transactions WHERE `org` = &#39;&quot;</span> <span style="color: #d0d0d0">.</span> <span style="color: #d0d0d0">craft()-&gt;</span><span style="color: #bbbbbb">request</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">getPost</span><span style="color: #d0d0d0">(</span><span style="color: #ed9d13">&#39;Org&#39;</span><span style="color: #d0d0d0">)</span> <span style="color: #d0d0d0">.</span> <span style="color: #ed9d13">&quot;&#39;&quot;</span><span style="color: #d0d0d0">;}</span>
			<span style="color: #6ab825; font-weight: bold">elseif</span><span style="color: #d0d0d0">(</span><span style="color: #24909d">strlen</span><span style="color: #d0d0d0">(craft()-&gt;</span><span style="color: #bbbbbb">request</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">getPost</span><span style="color: #d0d0d0">(</span><span style="color: #ed9d13">&#39;Accnt&#39;</span><span style="color: #d0d0d0">))</span> <span style="color: #d0d0d0">&lt;</span> <span style="color: #3677a9">3</span><span style="color: #d0d0d0">){</span>
			<span style="color: #40ffff">$sql</span> <span style="color: #d0d0d0">=</span> <span style="color: #ed9d13">&#39;SELECT id FROM ax_transactions WHERE `first_name` = &quot;&#39;</span> <span style="color: #d0d0d0">.</span> <span style="color: #d0d0d0">craft()-&gt;</span><span style="color: #bbbbbb">request</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">getPost</span><span style="color: #d0d0d0">(</span><span style="color: #ed9d13">&#39;FName&#39;</span><span style="color: #d0d0d0">)</span> <span style="color: #d0d0d0">.</span> <span style="color: #ed9d13">&#39;&quot; AND `last_name` = &quot;&#39;</span> <span style="color: #d0d0d0">.</span> <span style="color: #d0d0d0">craft()-&gt;</span><span style="color: #bbbbbb">request</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">getPost</span><span style="color: #d0d0d0">(</span><span style="color: #ed9d13">&#39;LName&#39;</span><span style="color: #d0d0d0">)</span> <span style="color: #d0d0d0">.</span> <span style="color: #ed9d13">&#39;&quot;&#39;</span><span style="color: #d0d0d0">;}</span>
			<span style="color: #6ab825; font-weight: bold">else</span> <span style="color: #40ffff">$sql</span> <span style="color: #d0d0d0">=</span> <span style="color: #ed9d13">&quot;&quot;</span><span style="color: #d0d0d0">;</span>

			<span style="color: #6ab825; font-weight: bold">if</span><span style="color: #d0d0d0">(</span><span style="color: #40ffff">$sql</span> <span style="color: #d0d0d0">!=</span> <span style="color: #ed9d13">&quot;&quot;</span><span style="color: #d0d0d0">){</span>
				<span style="color: #40ffff">$result</span> <span style="color: #d0d0d0">=</span> <span style="color: #40ffff">$this</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">mysqli</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">query</span><span style="color: #d0d0d0">(</span><span style="color: #40ffff">$sql</span><span style="color: #d0d0d0">);</span>

				<span style="color: #6ab825; font-weight: bold">if</span><span style="color: #d0d0d0">(</span><span style="color: #40ffff">$result</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">num_rows</span><span style="color: #d0d0d0">&gt;</span><span style="color: #3677a9">0</span><span style="color: #d0d0d0">){</span>
					<span style="color: #40ffff">$this</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">returnJson</span><span style="color: #d0d0d0">(</span><span style="color: #ed9d13">&quot;Row already exists for this customer without an account number listed.  Processing multiple orders for a single account without an account number will create duplicate records.  Either wait until the account is created automatically (and look up the new account number), or manually create the account and input account numbers for your order.&quot;</span><span style="color: #d0d0d0">);</span>
				<span style="color: #d0d0d0">}</span>
			<span style="color: #d0d0d0">}</span>
		<span style="color: #d0d0d0">}</span>

		<span style="color: #40ffff">$serial</span> <span style="color: #d0d0d0">=</span> <span style="color: #40ffff">$this</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">sanitizeSerial</span><span style="color: #d0d0d0">(craft()-&gt;</span><span style="color: #bbbbbb">request</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">getPost</span><span style="color: #d0d0d0">(</span><span style="color: #ed9d13">&#39;serial&#39;</span><span style="color: #d0d0d0">));</span>
		<span style="color: #40ffff">$postParams</span> <span style="color: #d0d0d0">=</span> <span style="color: #d0d0d0">craft()-&gt;</span><span style="color: #bbbbbb">request</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">getPost</span><span style="color: #d0d0d0">();</span>

		<span style="color: #6ab825; font-weight: bold">foreach</span><span style="color: #d0d0d0">(</span><span style="color: #40ffff">$postParams</span> <span style="color: #6ab825; font-weight: bold">as</span> <span style="color: #d0d0d0">&amp;</span><span style="color: #40ffff">$subValue</span><span style="color: #d0d0d0">)</span> <span style="color: #40ffff">$subValue</span> <span style="color: #d0d0d0">=</span> <span style="color: #40ffff">$this</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">mysqli</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">real_escape_string</span><span style="color: #d0d0d0">(</span><span style="color: #40ffff">$subValue</span><span style="color: #d0d0d0">);</span>

		<span style="color: #6ab825; font-weight: bold">if</span><span style="color: #d0d0d0">(</span><span style="color: #6ab825; font-weight: bold">empty</span><span style="color: #d0d0d0">(</span><span style="color: #40ffff">$postParams</span><span style="color: #d0d0d0">[</span><span style="color: #ed9d13">&#39;country&#39;</span><span style="color: #d0d0d0">])</span> <span style="color: #6ab825; font-weight: bold">OR</span> <span style="color: #40ffff">$postParams</span><span style="color: #d0d0d0">[</span><span style="color: #ed9d13">&#39;country&#39;</span><span style="color: #d0d0d0">]</span> <span style="color: #d0d0d0">==</span> <span style="color: #ed9d13">&quot;&quot;</span><span style="color: #d0d0d0">)</span> <span style="color: #40ffff">$postParams</span><span style="color: #d0d0d0">[</span><span style="color: #ed9d13">&#39;country&#39;</span><span style="color: #d0d0d0">]</span> <span style="color: #d0d0d0">=</span> <span style="color: #ed9d13">&quot;US&quot;</span><span style="color: #d0d0d0">;</span>

		<span style="color: #6ab825; font-weight: bold">if</span><span style="color: #d0d0d0">(</span><span style="color: #6ab825; font-weight: bold">empty</span><span style="color: #d0d0d0">(</span><span style="color: #40ffff">$postParams</span><span style="color: #d0d0d0">[</span><span style="color: #ed9d13">&#39;salesunit&#39;</span><span style="color: #d0d0d0">])</span> <span style="color: #6ab825; font-weight: bold">OR</span> <span style="color: #40ffff">$postParams</span><span style="color: #d0d0d0">[</span><span style="color: #ed9d13">&#39;salesunit&#39;</span><span style="color: #d0d0d0">]</span> <span style="color: #d0d0d0">==</span> <span style="color: #ed9d13">&quot;&quot;</span><span style="color: #d0d0d0">)</span> <span style="color: #40ffff">$postParams</span><span style="color: #d0d0d0">[</span><span style="color: #ed9d13">&#39;salesunit&#39;</span><span style="color: #d0d0d0">]</span> <span style="color: #d0d0d0">=</span> <span style="color: #ed9d13">&quot;ABU&quot;</span><span style="color: #d0d0d0">;</span>

		<span style="color: #6ab825; font-weight: bold">if</span><span style="color: #d0d0d0">(</span><span style="color: #6ab825; font-weight: bold">empty</span><span style="color: #d0d0d0">(</span><span style="color: #40ffff">$postParams</span><span style="color: #d0d0d0">[</span><span style="color: #ed9d13">&#39;Org&#39;</span><span style="color: #d0d0d0">])</span> <span style="color: #6ab825; font-weight: bold">OR</span> <span style="color: #40ffff">$postParams</span><span style="color: #d0d0d0">[</span><span style="color: #ed9d13">&#39;Org&#39;</span><span style="color: #d0d0d0">]</span> <span style="color: #d0d0d0">==</span> <span style="color: #ed9d13">&quot;&quot;</span><span style="color: #d0d0d0">)</span> <span style="color: #40ffff">$postParams</span><span style="color: #d0d0d0">[</span><span style="color: #ed9d13">&#39;Org&#39;</span><span style="color: #d0d0d0">]</span> <span style="color: #d0d0d0">=</span> <span style="color: #ed9d13">&quot;{</span><span style="color: #40ffff">$postParams</span><span style="color: #d0d0d0">[</span><span style="color: #ed9d13">&#39;FName&#39;</span><span style="color: #d0d0d0">]</span><span style="color: #ed9d13">} {</span><span style="color: #40ffff">$postParams</span><span style="color: #d0d0d0">[</span><span style="color: #ed9d13">&#39;LName&#39;</span><span style="color: #d0d0d0">]</span><span style="color: #ed9d13">}&quot;</span><span style="color: #d0d0d0">;</span>

		<span style="color: #40ffff">$fields_basic</span> <span style="color: #d0d0d0">=</span> <span style="color: #ed9d13">&quot;first_name = &#39;{</span><span style="color: #40ffff">$postParams</span><span style="color: #d0d0d0">[</span><span style="color: #ed9d13">&#39;FName&#39;</span><span style="color: #d0d0d0">]</span><span style="color: #ed9d13">}&#39;,</span>
<span style="color: #ed9d13">		last_name = &#39;{</span><span style="color: #40ffff">$postParams</span><span style="color: #d0d0d0">[</span><span style="color: #ed9d13">&#39;LName&#39;</span><span style="color: #d0d0d0">]</span><span style="color: #ed9d13">}&#39;,</span>
<span style="color: #ed9d13">		org = &#39;{</span><span style="color: #40ffff">$postParams</span><span style="color: #d0d0d0">[</span><span style="color: #ed9d13">&#39;Org&#39;</span><span style="color: #d0d0d0">]</span><span style="color: #ed9d13">}&#39;,</span>
<span style="color: #ed9d13">		email = &#39;{</span><span style="color: #40ffff">$postParams</span><span style="color: #d0d0d0">[</span><span style="color: #ed9d13">&#39;email&#39;</span><span style="color: #d0d0d0">]</span><span style="color: #ed9d13">}&#39;,</span>
<span style="color: #ed9d13">		address = &#39;{</span><span style="color: #40ffff">$postParams</span><span style="color: #d0d0d0">[</span><span style="color: #ed9d13">&#39;address&#39;</span><span style="color: #d0d0d0">]</span><span style="color: #ed9d13">}&#39;,</span>
<span style="color: #ed9d13">		city = &#39;{</span><span style="color: #40ffff">$postParams</span><span style="color: #d0d0d0">[</span><span style="color: #ed9d13">&#39;city&#39;</span><span style="color: #d0d0d0">]</span><span style="color: #ed9d13">}&#39;,</span>
<span style="color: #ed9d13">		state = &#39;{</span><span style="color: #40ffff">$postParams</span><span style="color: #d0d0d0">[</span><span style="color: #ed9d13">&#39;state&#39;</span><span style="color: #d0d0d0">]</span><span style="color: #ed9d13">}&#39;,</span>
<span style="color: #ed9d13">		zip = &#39;{</span><span style="color: #40ffff">$postParams</span><span style="color: #d0d0d0">[</span><span style="color: #ed9d13">&#39;zip&#39;</span><span style="color: #d0d0d0">]</span><span style="color: #ed9d13">}&#39;,</span>
<span style="color: #ed9d13">		country = &#39;{</span><span style="color: #40ffff">$postParams</span><span style="color: #d0d0d0">[</span><span style="color: #ed9d13">&#39;country&#39;</span><span style="color: #d0d0d0">]</span><span style="color: #ed9d13">}&#39;,</span>
<span style="color: #ed9d13">		&quot;</span><span style="color: #d0d0d0">;</span>

		<span style="color: #40ffff">$fields_extended</span> <span style="color: #d0d0d0">=</span> <span style="color: #ed9d13">&quot;`account` = &#39;{</span><span style="color: #40ffff">$postParams</span><span style="color: #d0d0d0">[</span><span style="color: #ed9d13">&#39;Accnt&#39;</span><span style="color: #d0d0d0">]</span><span style="color: #ed9d13">}&#39;,</span>
<span style="color: #ed9d13">		`serial_number` = &#39;$serial&#39;,</span>
<span style="color: #ed9d13">		`qty` = $qty,</span>
<span style="color: #ed9d13">		`price` = &#39;{</span><span style="color: #40ffff">$postParams</span><span style="color: #d0d0d0">[</span><span style="color: #ed9d13">&#39;Price&#39;</span><span style="color: #d0d0d0">]</span><span style="color: #ed9d13">}&#39;,</span>
<span style="color: #ed9d13">		`ccid` = &#39;{</span><span style="color: #40ffff">$postParams</span><span style="color: #d0d0d0">[</span><span style="color: #ed9d13">&#39;ccid&#39;</span><span style="color: #d0d0d0">]</span><span style="color: #ed9d13">}&#39;,</span>
<span style="color: #ed9d13">		`symptom` = &#39;{</span><span style="color: #40ffff">$postParams</span><span style="color: #d0d0d0">[</span><span style="color: #ed9d13">&#39;symptom&#39;</span><span style="color: #d0d0d0">]</span><span style="color: #ed9d13">}&#39;,</span>
<span style="color: #ed9d13">		`symptom_notes` = &#39;{</span><span style="color: #40ffff">$postParams</span><span style="color: #d0d0d0">[</span><span style="color: #ed9d13">&#39;symptomnotes&#39;</span><span style="color: #d0d0d0">]</span><span style="color: #ed9d13">}&#39;,</span>
<span style="color: #ed9d13">		`order_pool` = &#39;{</span><span style="color: #40ffff">$postParams</span><span style="color: #d0d0d0">[</span><span style="color: #ed9d13">&#39;orderpool&#39;</span><span style="color: #d0d0d0">]</span><span style="color: #ed9d13">}&#39;,</span>
<span style="color: #ed9d13">		`warehouse_in` = &#39;{</span><span style="color: #40ffff">$postParams</span><span style="color: #d0d0d0">[</span><span style="color: #ed9d13">&#39;recWarehouse&#39;</span><span style="color: #d0d0d0">]</span><span style="color: #ed9d13">}&#39;,</span>
<span style="color: #ed9d13">		`warehouse_out` = &#39;{</span><span style="color: #40ffff">$postParams</span><span style="color: #d0d0d0">[</span><span style="color: #ed9d13">&#39;ShipWarehouse&#39;</span><span style="color: #d0d0d0">]</span><span style="color: #ed9d13">}&#39;,</span>
<span style="color: #ed9d13">		`delivery_mode` = &#39;{</span><span style="color: #40ffff">$postParams</span><span style="color: #d0d0d0">[</span><span style="color: #ed9d13">&#39;shipmethod&#39;</span><span style="color: #d0d0d0">]</span><span style="color: #ed9d13">}&#39;,</span>
<span style="color: #ed9d13">		`sales_unit` = &#39;{</span><span style="color: #40ffff">$postParams</span><span style="color: #d0d0d0">[</span><span style="color: #ed9d13">&#39;salesunit&#39;</span><span style="color: #d0d0d0">]</span><span style="color: #ed9d13">}&#39;,</span>
<span style="color: #ed9d13">		`customer_group` = &#39;Standard&#39;,</span>
<span style="color: #ed9d13">		`owner` = &#39;{</span><span style="color: #40ffff">$postParams</span><span style="color: #d0d0d0">[</span><span style="color: #ed9d13">&#39;Owner&#39;</span><span style="color: #d0d0d0">]</span><span style="color: #ed9d13">}&#39;,</span>
<span style="color: #ed9d13">		`location_in` = &#39;{</span><span style="color: #40ffff">$postParams</span><span style="color: #d0d0d0">[</span><span style="color: #ed9d13">&#39;InboundInv&#39;</span><span style="color: #d0d0d0">]</span><span style="color: #ed9d13">}&#39;,</span>
<span style="color: #ed9d13">		`product_in` = &#39;{</span><span style="color: #40ffff">$postParams</span><span style="color: #d0d0d0">[</span><span style="color: #ed9d13">&#39;productin&#39;</span><span style="color: #d0d0d0">]</span><span style="color: #ed9d13">}&#39;,</span>
<span style="color: #ed9d13">		`product_out` = &#39;{</span><span style="color: #40ffff">$postParams</span><span style="color: #d0d0d0">[</span><span style="color: #ed9d13">&#39;productout&#39;</span><span style="color: #d0d0d0">]</span><span style="color: #ed9d13">}&#39;,</span>
<span style="color: #ed9d13">		`location_out` = &#39;{</span><span style="color: #40ffff">$postParams</span><span style="color: #d0d0d0">[</span><span style="color: #ed9d13">&#39;inventory&#39;</span><span style="color: #d0d0d0">]</span><span style="color: #ed9d13">}&#39;,</span>
<span style="color: #ed9d13">		`frt_payment` = &#39;Frt Exp&#39;,</span>
<span style="color: #ed9d13">		`inco` = &#39;DDP&#39;,&quot;</span><span style="color: #d0d0d0">;</span>

		<span style="color: #6ab825; font-weight: bold">if</span><span style="color: #d0d0d0">(craft()-&gt;</span><span style="color: #bbbbbb">request</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">getPost</span><span style="color: #d0d0d0">(</span><span style="color: #ed9d13">&#39;orderpool&#39;</span><span style="color: #d0d0d0">)</span> <span style="color: #d0d0d0">!=</span> <span style="color: #ed9d13">&quot;NCO SVC&quot;</span> <span style="color: #6ab825; font-weight: bold">AND</span> <span style="color: #d0d0d0">craft()-&gt;</span><span style="color: #bbbbbb">request</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">getPost</span><span style="color: #d0d0d0">(</span><span style="color: #ed9d13">&#39;orderpool&#39;</span><span style="color: #d0d0d0">)</span> <span style="color: #d0d0d0">!=</span> <span style="color: #ed9d13">&quot;STANDARD&quot;</span><span style="color: #d0d0d0">){</span>
			<span style="color: #40ffff">$sql</span> <span style="color: #d0d0d0">=</span> <span style="color: #ed9d13">&quot;SELECT serial_number, registered FROM install_base.install_base WHERE `serial_number` = &#39;$serial&#39;&quot;</span><span style="color: #d0d0d0">;</span>
			<span style="color: #40ffff">$result</span> <span style="color: #d0d0d0">=</span> <span style="color: #40ffff">$this</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">mysqli</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">query</span><span style="color: #d0d0d0">(</span><span style="color: #40ffff">$sql</span><span style="color: #d0d0d0">);</span>

			<span style="color: #6ab825; font-weight: bold">if</span><span style="color: #d0d0d0">(</span><span style="color: #40ffff">$result</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">num_rows</span><span style="color: #d0d0d0">==</span><span style="color: #3677a9">0</span><span style="color: #d0d0d0">)</span> <span style="color: #40ffff">$this</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">returnJson</span><span style="color: #d0d0d0">(</span><span style="color: #ed9d13">&quot;Serial Number does not exist in the Install Base.  Confirm SN with customer with invoice and|or picture and register the serial number before re-submitting.&quot;</span><span style="color: #d0d0d0">);</span>

			<span style="color: #6ab825; font-weight: bold">while</span><span style="color: #d0d0d0">(</span><span style="color: #40ffff">$row</span> <span style="color: #d0d0d0">=</span> <span style="color: #40ffff">$result</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">fetch_assoc</span><span style="color: #d0d0d0">())</span>
			<span style="color: #d0d0d0">{</span>
				<span style="color: #6ab825; font-weight: bold">if</span><span style="color: #d0d0d0">(</span><span style="color: #40ffff">$row</span><span style="color: #d0d0d0">[</span><span style="color: #ed9d13">&#39;registered&#39;</span><span style="color: #d0d0d0">]</span> <span style="color: #d0d0d0">!=</span> <span style="color: #ed9d13">&quot;TRUE&quot;</span><span style="color: #d0d0d0">){</span>
					<span style="color: #40ffff">$sql</span> <span style="color: #d0d0d0">=</span> <span style="color: #ed9d13">&quot;UPDATE install_base.install_base SET &quot;</span> <span style="color: #d0d0d0">.</span> <span style="color: #40ffff">$fields_basic</span> <span style="color: #d0d0d0">.</span> <span style="color: #ed9d13">&quot; reg_country = &#39;{</span><span style="color: #40ffff">$postParams</span><span style="color: #d0d0d0">[</span><span style="color: #ed9d13">&#39;country&#39;</span><span style="color: #d0d0d0">]</span><span style="color: #ed9d13">}&#39; WHERE serial_number = &#39;$serial&#39;&quot;</span><span style="color: #d0d0d0">;</span>
					<span style="color: #40ffff">$this</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">mysqli</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">query</span><span style="color: #d0d0d0">(</span><span style="color: #40ffff">$sql</span><span style="color: #d0d0d0">);</span>
				<span style="color: #d0d0d0">}</span>
			<span style="color: #d0d0d0">}</span>
		<span style="color: #d0d0d0">}</span>

		<span style="color: #40ffff">$sql</span> <span style="color: #d0d0d0">=</span> <span style="color: #ed9d13">&quot;INSERT INTO ax_transactions SET `id` = &#39;$id&#39;, &quot;</span> <span style="color: #d0d0d0">.</span> <span style="color: #40ffff">$fields_basic</span> <span style="color: #d0d0d0">.</span> <span style="color: #40ffff">$fields_extended</span> <span style="color: #d0d0d0">.</span> <span style="color: #ed9d13">&quot; `status` = &#39;Created&#39; </span>
<span style="color: #ed9d13">			ON DUPLICATE KEY UPDATE &quot;</span> <span style="color: #d0d0d0">.</span> <span style="color: #40ffff">$fields_basic</span> <span style="color: #d0d0d0">.</span> <span style="color: #40ffff">$fields_extended</span> <span style="color: #d0d0d0">.</span> <span style="color: #ed9d13">&quot; `status` = &#39;Updated&#39;&quot;</span> <span style="color: #d0d0d0">;</span>
		<span style="color: #40ffff">$result</span> <span style="color: #d0d0d0">=</span> <span style="color: #40ffff">$this</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">mysqli</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">query</span><span style="color: #d0d0d0">(</span><span style="color: #40ffff">$sql</span><span style="color: #d0d0d0">);</span>

		<span style="color: #40ffff">$this</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">returnJson</span><span style="color: #d0d0d0">(</span><span style="color: #ed9d13">&quot;Transaction submitted&quot;</span><span style="color: #d0d0d0">);</span>
    <span style="color: #d0d0d0">}</span>

   <span style="color: #6ab825; font-weight: bold">public</span> <span style="color: #6ab825; font-weight: bold">function</span> <span style="color: #447fcf">actionUpdateAxTransactions</span><span style="color: #d0d0d0">()</span>
	<span style="color: #d0d0d0">{</span>
		<span style="color: #40ffff">$this</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">mysqli</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">select_db</span><span style="color: #d0d0d0">(</span><span style="color: #ed9d13">&#39;infocus_internal&#39;</span><span style="color: #d0d0d0">);</span>
		<span style="color: #40ffff">$data</span> <span style="color: #d0d0d0">=</span> <span style="color: #d0d0d0">craft()-&gt;</span><span style="color: #bbbbbb">request</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">getParam</span><span style="color: #d0d0d0">(</span><span style="color: #ed9d13">&#39;data&#39;</span><span style="color: #d0d0d0">);</span>
		<span style="color: #40ffff">$fields</span> <span style="color: #d0d0d0">=</span> <span style="color: #d0d0d0">craft()-&gt;</span><span style="color: #bbbbbb">request</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">getParam</span><span style="color: #d0d0d0">(</span><span style="color: #ed9d13">&#39;fields&#39;</span><span style="color: #d0d0d0">);</span>
		<span style="color: #6ab825; font-weight: bold">foreach</span><span style="color: #d0d0d0">(</span><span style="color: #40ffff">$data</span> <span style="color: #6ab825; font-weight: bold">as</span> <span style="color: #40ffff">$row</span><span style="color: #d0d0d0">){</span>
			<span style="color: #40ffff">$sql</span> <span style="color: #d0d0d0">=</span> <span style="color: #ed9d13">&quot;UPDATE ax_transactions SET &quot;</span><span style="color: #d0d0d0">;</span>
			<span style="color: #6ab825; font-weight: bold">for</span> <span style="color: #d0d0d0">(</span><span style="color: #40ffff">$i</span><span style="color: #d0d0d0">=</span><span style="color: #3677a9">0</span><span style="color: #d0d0d0">;</span> <span style="color: #40ffff">$i</span> <span style="color: #d0d0d0">&lt;</span> <span style="color: #24909d">count</span><span style="color: #d0d0d0">(</span><span style="color: #40ffff">$row</span><span style="color: #d0d0d0">);</span> <span style="color: #40ffff">$i</span><span style="color: #d0d0d0">++)</span> <span style="color: #d0d0d0">{</span> 
				<span style="color: #6ab825; font-weight: bold">if</span><span style="color: #d0d0d0">(</span><span style="color: #40ffff">$fields</span><span style="color: #d0d0d0">[</span><span style="color: #40ffff">$i</span><span style="color: #d0d0d0">]</span> <span style="color: #d0d0d0">!=</span> <span style="color: #ed9d13">&quot;id&quot;</span> <span style="color: #6ab825; font-weight: bold">AND</span> <span style="color: #40ffff">$fields</span><span style="color: #d0d0d0">[</span><span style="color: #40ffff">$i</span><span style="color: #d0d0d0">]</span> <span style="color: #d0d0d0">!=</span> <span style="color: #ed9d13">&quot;status&quot;</span> <span style="color: #6ab825; font-weight: bold">AND</span> <span style="color: #40ffff">$fields</span><span style="color: #d0d0d0">[</span><span style="color: #40ffff">$i</span><span style="color: #d0d0d0">]</span> <span style="color: #d0d0d0">!=</span> <span style="color: #ed9d13">&quot;note&quot;</span><span style="color: #d0d0d0">){</span>
					<span style="color: #40ffff">$row</span><span style="color: #d0d0d0">[</span><span style="color: #40ffff">$i</span><span style="color: #d0d0d0">]</span> <span style="color: #d0d0d0">=</span> <span style="color: #40ffff">$this</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">mysqli</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">real_escape_string</span><span style="color: #d0d0d0">(</span><span style="color: #40ffff">$row</span><span style="color: #d0d0d0">[</span><span style="color: #40ffff">$i</span><span style="color: #d0d0d0">]);</span>
					<span style="color: #40ffff">$sql</span> <span style="color: #d0d0d0">.=</span> <span style="color: #ed9d13">&quot;`{</span><span style="color: #40ffff">$fields</span><span style="color: #d0d0d0">[</span><span style="color: #40ffff">$i</span><span style="color: #d0d0d0">]</span><span style="color: #ed9d13">}` = &#39;{</span><span style="color: #40ffff">$row</span><span style="color: #d0d0d0">[</span><span style="color: #40ffff">$i</span><span style="color: #d0d0d0">]</span><span style="color: #ed9d13">}&#39;,&quot;</span><span style="color: #d0d0d0">;</span>
				<span style="color: #d0d0d0">}</span>
				<span style="color: #6ab825; font-weight: bold">elseif</span><span style="color: #d0d0d0">(</span><span style="color: #40ffff">$fields</span><span style="color: #d0d0d0">[</span><span style="color: #40ffff">$i</span><span style="color: #d0d0d0">]</span> <span style="color: #d0d0d0">==</span> <span style="color: #ed9d13">&quot;id&quot;</span><span style="color: #d0d0d0">){</span><span style="color: #40ffff">$id</span> <span style="color: #d0d0d0">=</span> <span style="color: #40ffff">$row</span><span style="color: #d0d0d0">[</span><span style="color: #40ffff">$i</span><span style="color: #d0d0d0">];}</span>
			<span style="color: #d0d0d0">}</span>
			<span style="color: #40ffff">$sql</span> <span style="color: #d0d0d0">.=</span> <span style="color: #ed9d13">&#39;`note` = &quot;&quot;,&#39;</span><span style="color: #d0d0d0">;</span> 
			<span style="color: #40ffff">$sql</span> <span style="color: #d0d0d0">.=</span> <span style="color: #ed9d13">&#39;`status` = &quot;Updated&quot;&#39;</span><span style="color: #d0d0d0">;</span> 
			<span style="color: #40ffff">$sql</span> <span style="color: #d0d0d0">.=</span> <span style="color: #ed9d13">&#39; WHERE id = &quot;&#39;</span> <span style="color: #d0d0d0">.</span> <span style="color: #40ffff">$id</span> <span style="color: #d0d0d0">.</span> <span style="color: #ed9d13">&#39;&quot;&#39;</span><span style="color: #d0d0d0">;</span>
			<span style="color: #40ffff">$result</span> <span style="color: #d0d0d0">=</span> <span style="color: #40ffff">$this</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">mysqli</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">query</span><span style="color: #d0d0d0">(</span><span style="color: #40ffff">$sql</span><span style="color: #d0d0d0">);</span>
		<span style="color: #d0d0d0">}</span>
			<span style="color: #40ffff">$this</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">returnJson</span><span style="color: #d0d0d0">(</span><span style="color: #ed9d13">&quot;success&quot;</span><span style="color: #d0d0d0">);</span>
	<span style="color: #d0d0d0">}</span>

   <span style="color: #6ab825; font-weight: bold">public</span> <span style="color: #6ab825; font-weight: bold">function</span> <span style="color: #447fcf">actionGetAxTransactions</span><span style="color: #d0d0d0">()</span>
   <span style="color: #d0d0d0">{</span>
		<span style="color: #40ffff">$this</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">mysqli</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">select_db</span><span style="color: #d0d0d0">(</span><span style="color: #ed9d13">&#39;infocus_internal&#39;</span><span style="color: #d0d0d0">);</span>
		<span style="color: #40ffff">$sql</span> <span style="color: #d0d0d0">=</span> <span style="color: #ed9d13">&quot;SELECT `id`, `owner`, `status`,`first_name`,`last_name`, `note`,`rma`,`sales_order`, `phone`, `org`, `account`, `email`, `product_in`, `qty`, `serial_number`, `product_out`, `symptom`, `symptom_notes`, `address`, `city`, `state`, `zip`, `country`, `delivery_mode`, `location_in`, `warehouse_in`, `location_out`, `warehouse_out`, `ccid`, `order_pool` FROM `ax_transactions` WHERE `status` NOT IN(&#39;Closed&#39;,&#39;Canceled&#39;)&quot;</span><span style="color: #d0d0d0">;</span>
		<span style="color: #40ffff">$result</span> <span style="color: #d0d0d0">=</span> <span style="color: #40ffff">$this</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">mysqli</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">query</span><span style="color: #d0d0d0">(</span><span style="color: #40ffff">$sql</span><span style="color: #d0d0d0">);</span>
		<span style="color: #6ab825; font-weight: bold">if</span><span style="color: #d0d0d0">(</span><span style="color: #40ffff">$result</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">num_rows</span> <span style="color: #d0d0d0">==</span> <span style="color: #3677a9">0</span><span style="color: #d0d0d0">)</span> <span style="color: #40ffff">$this</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">returnJson</span><span style="color: #d0d0d0">(</span><span style="color: #ed9d13">&quot;No records&quot;</span><span style="color: #d0d0d0">);</span>
		<span style="color: #6ab825; font-weight: bold">for</span> <span style="color: #d0d0d0">(</span><span style="color: #40ffff">$i</span><span style="color: #d0d0d0">=</span><span style="color: #3677a9">0</span><span style="color: #d0d0d0">;</span> <span style="color: #40ffff">$i</span> <span style="color: #d0d0d0">&lt;</span> <span style="color: #40ffff">$result</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">field_count</span><span style="color: #d0d0d0">;</span> <span style="color: #40ffff">$i</span><span style="color: #d0d0d0">++)</span> <span style="color: #d0d0d0">{</span> 
		    <span style="color: #40ffff">$fieldNames</span><span style="color: #d0d0d0">[</span><span style="color: #40ffff">$i</span><span style="color: #d0d0d0">]</span> <span style="color: #d0d0d0">=</span> <span style="color: #40ffff">$result</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">fetch_field_direct</span><span style="color: #d0d0d0">(</span><span style="color: #40ffff">$i</span><span style="color: #d0d0d0">)-&gt;</span><span style="color: #bbbbbb">name</span><span style="color: #d0d0d0">;</span>
		    <span style="color: #40ffff">$colNames</span><span style="color: #d0d0d0">[</span><span style="color: #40ffff">$i</span><span style="color: #d0d0d0">]</span> <span style="color: #d0d0d0">=</span> <span style="color: #d0d0d0">ucfirst(</span><span style="color: #24909d">str_replace</span><span style="color: #d0d0d0">(</span><span style="color: #ed9d13">&quot;_&quot;</span><span style="color: #d0d0d0">,</span><span style="color: #ed9d13">&quot; &quot;</span><span style="color: #d0d0d0">,</span><span style="color: #40ffff">$result</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">fetch_field_direct</span><span style="color: #d0d0d0">(</span><span style="color: #40ffff">$i</span><span style="color: #d0d0d0">)-&gt;</span><span style="color: #bbbbbb">name</span><span style="color: #d0d0d0">));</span>
		<span style="color: #d0d0d0">}</span>

		<span style="color: #6ab825; font-weight: bold">while</span><span style="color: #d0d0d0">(</span><span style="color: #40ffff">$row</span> <span style="color: #d0d0d0">=</span> <span style="color: #40ffff">$result</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">fetch_assoc</span><span style="color: #d0d0d0">())</span> <span style="color: #40ffff">$rows</span><span style="color: #d0d0d0">[]</span> <span style="color: #d0d0d0">=</span> <span style="color: #24909d">array_map</span><span style="color: #d0d0d0">(</span><span style="color: #ed9d13">&#39;utf8_encode&#39;</span><span style="color: #d0d0d0">,</span><span style="color: #40ffff">$row</span><span style="color: #d0d0d0">);</span>
		<span style="color: #40ffff">$this</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">returnJson</span><span style="color: #d0d0d0">(</span><span style="color: #6ab825; font-weight: bold">array</span><span style="color: #d0d0d0">(</span><span style="color: #ed9d13">&quot;fields&quot;</span><span style="color: #d0d0d0">=&gt;</span><span style="color: #40ffff">$fieldNames</span><span style="color: #d0d0d0">,</span><span style="color: #ed9d13">&quot;columns&quot;</span><span style="color: #d0d0d0">=&gt;</span><span style="color: #40ffff">$colNames</span><span style="color: #d0d0d0">,</span><span style="color: #ed9d13">&quot;rows&quot;</span><span style="color: #d0d0d0">=&gt;</span><span style="color: #40ffff">$rows</span><span style="color: #d0d0d0">));</span>
   <span style="color: #d0d0d0">}</span>

   <span style="color: #6ab825; font-weight: bold">public</span> <span style="color: #6ab825; font-weight: bold">function</span> <span style="color: #447fcf">actionCancelAxTransaction</span><span style="color: #d0d0d0">()</span>
   <span style="color: #d0d0d0">{</span>
		<span style="color: #40ffff">$this</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">mysqli</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">select_db</span><span style="color: #d0d0d0">(</span><span style="color: #ed9d13">&#39;infocus_internal&#39;</span><span style="color: #d0d0d0">);</span>
		<span style="color: #40ffff">$id</span> <span style="color: #d0d0d0">=</span> <span style="color: #d0d0d0">craft()-&gt;</span><span style="color: #bbbbbb">request</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">getPost</span><span style="color: #d0d0d0">(</span><span style="color: #ed9d13">&#39;id&#39;</span><span style="color: #d0d0d0">);</span>
		<span style="color: #40ffff">$sql</span> <span style="color: #d0d0d0">=</span> <span style="color: #ed9d13">&quot;UPDATE `ax_transactions` SET `status` =&#39;Canceled&#39;  WHERE `status` IN(&#39;Updated&#39;,&#39;Error&#39;,&#39;Created&#39;) AND id = &#39;$id&#39;&quot;</span><span style="color: #d0d0d0">;</span>
		<span style="color: #40ffff">$result</span> <span style="color: #d0d0d0">=</span> <span style="color: #40ffff">$this</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">mysqli</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">query</span><span style="color: #d0d0d0">(</span><span style="color: #40ffff">$sql</span><span style="color: #d0d0d0">);</span>
		<span style="color: #40ffff">$this</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">returnJson</span><span style="color: #d0d0d0">(</span><span style="color: #ed9d13">&#39;success&#39;</span><span style="color: #d0d0d0">);</span>
   <span style="color: #d0d0d0">}</span>

   <span style="color: #6ab825; font-weight: bold">private</span> <span style="color: #6ab825; font-weight: bold">function</span> <span style="color: #447fcf">keyType</span><span style="color: #d0d0d0">(</span><span style="color: #40ffff">$type</span><span style="color: #d0d0d0">){</span>

   		<span style="color: #6ab825; font-weight: bold">if</span><span style="color: #d0d0d0">(</span><span style="color: #40ffff">$type</span> <span style="color: #d0d0d0">==</span> <span style="color: #ed9d13">&quot;all&quot;</span> <span style="color: #6ab825; font-weight: bold">OR</span> <span style="color: #40ffff">$type</span> <span style="color: #d0d0d0">==</span> <span style="color: #6ab825; font-weight: bold">NULL</span><span style="color: #d0d0d0">)</span> <span style="color: #6ab825; font-weight: bold">return</span><span style="color: #d0d0d0">;</span>
   		<span style="color: #6ab825; font-weight: bold">elseif</span><span style="color: #d0d0d0">(</span><span style="color: #40ffff">$type</span> <span style="color: #d0d0d0">==</span> <span style="color: #ed9d13">&quot;training&quot;</span><span style="color: #d0d0d0">)</span> <span style="color: #6ab825; font-weight: bold">return</span> <span style="color: #ed9d13">&quot;AND `type` IN(&#39;Train&#39;,NULL)&quot;</span><span style="color: #d0d0d0">;</span>
   		<span style="color: #6ab825; font-weight: bold">elseif</span><span style="color: #d0d0d0">(</span><span style="color: #40ffff">$type</span> <span style="color: #d0d0d0">==</span> <span style="color: #ed9d13">&quot;service&quot;</span><span style="color: #d0d0d0">)</span> <span style="color: #6ab825; font-weight: bold">return</span> <span style="color: #ed9d13">&quot;AND `type` IN(&#39;Service&#39;,NULL)&quot;</span><span style="color: #d0d0d0">;</span>
   		<span style="color: #6ab825; font-weight: bold">elseif</span><span style="color: #d0d0d0">(</span><span style="color: #40ffff">$type</span> <span style="color: #d0d0d0">==</span> <span style="color: #ed9d13">&quot;hardware&quot;</span><span style="color: #d0d0d0">)</span> <span style="color: #6ab825; font-weight: bold">return</span> <span style="color: #ed9d13">&quot;AND `type` IN(&#39;Hard&#39;,&#39;Both&#39;,NULL)&quot;</span><span style="color: #d0d0d0">;</span>
   		<span style="color: #6ab825; font-weight: bold">elseif</span><span style="color: #d0d0d0">(</span><span style="color: #40ffff">$type</span> <span style="color: #d0d0d0">==</span> <span style="color: #ed9d13">&quot;software&quot;</span><span style="color: #d0d0d0">)</span> <span style="color: #6ab825; font-weight: bold">return</span> <span style="color: #ed9d13">&quot;AND `type` IN(&#39;Soft&#39;,&#39;Both&#39;,NULL)&quot;</span><span style="color: #d0d0d0">;</span>
   <span style="color: #d0d0d0">}</span>

   <span style="color: #6ab825; font-weight: bold">public</span> <span style="color: #6ab825; font-weight: bold">function</span> <span style="color: #447fcf">actionValidateKey</span><span style="color: #d0d0d0">()</span>
    <span style="color: #d0d0d0">{</span>
		<span style="color: #40ffff">$key</span> <span style="color: #d0d0d0">=</span> <span style="color: #d0d0d0">strtoupper(craft()-&gt;</span><span style="color: #bbbbbb">request</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">getPost</span><span style="color: #d0d0d0">(</span><span style="color: #ed9d13">&#39;key&#39;</span><span style="color: #d0d0d0">));</span>
		<span style="color: #40ffff">$type</span> <span style="color: #d0d0d0">=</span> <span style="color: #d0d0d0">strtolower(craft()-&gt;</span><span style="color: #bbbbbb">request</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">getPost</span><span style="color: #d0d0d0">(</span><span style="color: #ed9d13">&#39;type&#39;</span><span style="color: #d0d0d0">));</span>
		<span style="color: #40ffff">$type</span> <span style="color: #d0d0d0">=</span> <span style="color: #40ffff">$this</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">keyType</span><span style="color: #d0d0d0">(</span><span style="color: #40ffff">$type</span><span style="color: #d0d0d0">);</span>
		<span style="color: #40ffff">$response</span><span style="color: #d0d0d0">[</span><span style="color: #ed9d13">&#39;key&#39;</span><span style="color: #d0d0d0">]</span> <span style="color: #d0d0d0">=</span> <span style="color: #40ffff">$key</span><span style="color: #d0d0d0">;</span>
		<span style="color: #40ffff">$sql</span> <span style="color: #d0d0d0">=</span> <span style="color: #ed9d13">&quot;SELECT * FROM `contracts_view` WHERE REPLACE(`key`,&#39;-&#39;,&#39;&#39;) = REPLACE(&#39;$key&#39;,&#39;-&#39;,&#39;&#39;) $type&quot;</span><span style="color: #d0d0d0">;</span>
		<span style="color: #40ffff">$result</span> <span style="color: #d0d0d0">=</span> <span style="color: #40ffff">$this</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">mysqli</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">query</span><span style="color: #d0d0d0">(</span><span style="color: #40ffff">$sql</span><span style="color: #d0d0d0">);</span>

		<span style="color: #6ab825; font-weight: bold">if</span><span style="color: #d0d0d0">(</span><span style="color: #40ffff">$result</span> <span style="color: #d0d0d0">==</span> <span style="color: #6ab825; font-weight: bold">false</span><span style="color: #d0d0d0">){</span>
			<span style="color: #40ffff">$response</span><span style="color: #d0d0d0">[</span><span style="color: #ed9d13">&#39;status&#39;</span><span style="color: #d0d0d0">]</span> <span style="color: #d0d0d0">=</span>  <span style="color: #ed9d13">&quot;Invalid&quot;</span><span style="color: #d0d0d0">;</span>
			<span style="color: #40ffff">$this</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">returnJson</span><span style="color: #d0d0d0">(</span><span style="color: #40ffff">$response</span><span style="color: #d0d0d0">);</span>
			<span style="color: #6ab825; font-weight: bold">exit</span><span style="color: #d0d0d0">();</span>
		<span style="color: #d0d0d0">}</span>

		<span style="color: #6ab825; font-weight: bold">if</span><span style="color: #d0d0d0">(</span><span style="color: #40ffff">$result</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">num_rows</span><span style="color: #d0d0d0">&gt;</span><span style="color: #3677a9">0</span><span style="color: #d0d0d0">){</span>
			<span style="color: #6ab825; font-weight: bold">while</span><span style="color: #d0d0d0">(</span><span style="color: #40ffff">$row</span> <span style="color: #d0d0d0">=</span> <span style="color: #40ffff">$result</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">fetch_assoc</span><span style="color: #d0d0d0">()){</span>
				<span style="color: #6ab825; font-weight: bold">if</span><span style="color: #d0d0d0">(</span><span style="color: #40ffff">$row</span><span style="color: #d0d0d0">[</span><span style="color: #ed9d13">&#39;redeemed&#39;</span><span style="color: #d0d0d0">]</span> <span style="color: #d0d0d0">==</span> <span style="color: #6ab825; font-weight: bold">NULL</span> <span style="color: #6ab825; font-weight: bold">AND</span> <span style="color: #40ffff">$row</span><span style="color: #d0d0d0">[</span><span style="color: #ed9d13">&#39;computer_id&#39;</span><span style="color: #d0d0d0">]</span> <span style="color: #d0d0d0">==</span> <span style="color: #6ab825; font-weight: bold">NULL</span><span style="color: #d0d0d0">){</span><span style="color: #40ffff">$response</span><span style="color: #d0d0d0">[</span><span style="color: #ed9d13">&#39;status&#39;</span><span style="color: #d0d0d0">]</span> <span style="color: #d0d0d0">=</span> <span style="color: #ed9d13">&quot;Valid&quot;</span><span style="color: #d0d0d0">;</span><span style="color: #40ffff">$response</span><span style="color: #d0d0d0">[</span><span style="color: #ed9d13">&#39;part_number&#39;</span><span style="color: #d0d0d0">]=</span><span style="color: #40ffff">$row</span><span style="color: #d0d0d0">[</span><span style="color: #ed9d13">&#39;part_number&#39;</span><span style="color: #d0d0d0">];}</span>
					<span style="color: #6ab825; font-weight: bold">else</span> <span style="color: #d0d0d0">{</span>
						<span style="color: #40ffff">$response</span><span style="color: #d0d0d0">[</span><span style="color: #ed9d13">&#39;status&#39;</span><span style="color: #d0d0d0">]</span> <span style="color: #d0d0d0">=</span> <span style="color: #ed9d13">&quot;Redeemed&quot;</span><span style="color: #d0d0d0">;</span>
						<span style="color: #40ffff">$response</span><span style="color: #d0d0d0">[</span><span style="color: #ed9d13">&#39;part_number&#39;</span><span style="color: #d0d0d0">]=</span><span style="color: #40ffff">$row</span><span style="color: #d0d0d0">[</span><span style="color: #ed9d13">&#39;part_number&#39;</span><span style="color: #d0d0d0">];</span>
						<span style="color: #40ffff">$response</span><span style="color: #d0d0d0">[</span><span style="color: #ed9d13">&#39;serial_number&#39;</span><span style="color: #d0d0d0">]=</span><span style="color: #40ffff">$row</span><span style="color: #d0d0d0">[</span><span style="color: #ed9d13">&#39;serial_number&#39;</span><span style="color: #d0d0d0">];</span>
						<span style="color: #40ffff">$response</span><span style="color: #d0d0d0">[</span><span style="color: #ed9d13">&#39;contract_length&#39;</span><span style="color: #d0d0d0">]=</span><span style="color: #40ffff">$row</span><span style="color: #d0d0d0">[</span><span style="color: #ed9d13">&#39;contract_length&#39;</span><span style="color: #d0d0d0">];</span>
						<span style="color: #40ffff">$response</span><span style="color: #d0d0d0">[</span><span style="color: #ed9d13">&#39;start_date&#39;</span><span style="color: #d0d0d0">]=</span><span style="color: #40ffff">$row</span><span style="color: #d0d0d0">[</span><span style="color: #ed9d13">&#39;start_date&#39;</span><span style="color: #d0d0d0">];</span>
						<span style="color: #40ffff">$response</span><span style="color: #d0d0d0">[</span><span style="color: #ed9d13">&#39;redeemed&#39;</span><span style="color: #d0d0d0">]=</span><span style="color: #40ffff">$row</span><span style="color: #d0d0d0">[</span><span style="color: #ed9d13">&#39;redeemed&#39;</span><span style="color: #d0d0d0">];</span>
					<span style="color: #d0d0d0">}</span>
			<span style="color: #d0d0d0">}</span>
		<span style="color: #d0d0d0">}</span>
		<span style="color: #6ab825; font-weight: bold">else</span> <span style="color: #40ffff">$response</span><span style="color: #d0d0d0">[</span><span style="color: #ed9d13">&#39;status&#39;</span><span style="color: #d0d0d0">]</span> <span style="color: #d0d0d0">=</span> <span style="color: #ed9d13">&quot;Invalid&quot;</span><span style="color: #d0d0d0">;</span>

		<span style="color: #40ffff">$this</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">returnJson</span><span style="color: #d0d0d0">(</span><span style="color: #40ffff">$response</span><span style="color: #d0d0d0">);</span>
    <span style="color: #d0d0d0">}</span>

   <span style="color: #6ab825; font-weight: bold">public</span> <span style="color: #6ab825; font-weight: bold">function</span> <span style="color: #447fcf">actionConsumeKey</span><span style="color: #d0d0d0">()</span>
    <span style="color: #d0d0d0">{</span>
		<span style="color: #40ffff">$key</span> <span style="color: #d0d0d0">=</span> <span style="color: #d0d0d0">strtoupper(craft()-&gt;</span><span style="color: #bbbbbb">request</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">getPost</span><span style="color: #d0d0d0">(</span><span style="color: #ed9d13">&#39;key&#39;</span><span style="color: #d0d0d0">));</span>
    	<span style="color: #40ffff">$serial</span> <span style="color: #d0d0d0">=</span> <span style="color: #40ffff">$this</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">sanitizeSerial</span><span style="color: #d0d0d0">(craft()-&gt;</span><span style="color: #bbbbbb">request</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">getPost</span><span style="color: #d0d0d0">(</span><span style="color: #ed9d13">&#39;serial&#39;</span><span style="color: #d0d0d0">));</span>
		<span style="color: #40ffff">$email</span> <span style="color: #d0d0d0">=</span> <span style="color: #d0d0d0">strtolower(craft()-&gt;</span><span style="color: #bbbbbb">request</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">getPost</span><span style="color: #d0d0d0">(</span><span style="color: #ed9d13">&#39;email&#39;</span><span style="color: #d0d0d0">));</span>
		<span style="color: #40ffff">$start</span> <span style="color: #d0d0d0">=</span> <span style="color: #d0d0d0">strtolower(craft()-&gt;</span><span style="color: #bbbbbb">request</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">getPost</span><span style="color: #d0d0d0">(</span><span style="color: #ed9d13">&#39;start_date&#39;</span><span style="color: #d0d0d0">));</span>
		<span style="color: #40ffff">$note</span> <span style="color: #d0d0d0">=</span> <span style="color: #d0d0d0">craft()-&gt;</span><span style="color: #bbbbbb">request</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">getPost</span><span style="color: #d0d0d0">(</span><span style="color: #ed9d13">&#39;note&#39;</span><span style="color: #d0d0d0">);</span>
		<span style="color: #40ffff">$response</span><span style="color: #d0d0d0">[</span><span style="color: #ed9d13">&#39;key&#39;</span><span style="color: #d0d0d0">]</span> <span style="color: #d0d0d0">=</span> <span style="color: #40ffff">$key</span><span style="color: #d0d0d0">;</span>
		<span style="color: #40ffff">$type</span> <span style="color: #d0d0d0">=</span> <span style="color: #d0d0d0">strtolower(craft()-&gt;</span><span style="color: #bbbbbb">request</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">getPost</span><span style="color: #d0d0d0">(</span><span style="color: #ed9d13">&#39;type&#39;</span><span style="color: #d0d0d0">));</span>
		<span style="color: #40ffff">$type</span> <span style="color: #d0d0d0">=</span> <span style="color: #40ffff">$this</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">keyType</span><span style="color: #d0d0d0">(</span><span style="color: #40ffff">$type</span><span style="color: #d0d0d0">);</span>
		<span style="color: #40ffff">$sql</span> <span style="color: #d0d0d0">=</span> <span style="color: #ed9d13">&quot;SELECT redeemed FROM `contracts_view` WHERE REPLACE(`key`,&#39;-&#39;,&#39;&#39;) = REPLACE(&#39;$key&#39;,&#39;-&#39;,&#39;&#39;) $type&quot;</span><span style="color: #d0d0d0">;</span>
		<span style="color: #40ffff">$result</span> <span style="color: #d0d0d0">=</span> <span style="color: #40ffff">$this</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">mysqli</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">query</span><span style="color: #d0d0d0">(</span><span style="color: #40ffff">$sql</span><span style="color: #d0d0d0">);</span>

		<span style="color: #6ab825; font-weight: bold">if</span><span style="color: #d0d0d0">(</span><span style="color: #40ffff">$result</span> <span style="color: #d0d0d0">==</span> <span style="color: #6ab825; font-weight: bold">false</span><span style="color: #d0d0d0">){</span>
			<span style="color: #40ffff">$response</span><span style="color: #d0d0d0">[</span><span style="color: #ed9d13">&#39;status&#39;</span><span style="color: #d0d0d0">]</span> <span style="color: #d0d0d0">=</span>  <span style="color: #ed9d13">&quot;Invalid Key&quot;</span><span style="color: #d0d0d0">;</span>
			<span style="color: #40ffff">$this</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">returnJson</span><span style="color: #d0d0d0">(</span><span style="color: #40ffff">$response</span><span style="color: #d0d0d0">);</span>
			<span style="color: #6ab825; font-weight: bold">exit</span><span style="color: #d0d0d0">();</span>
		<span style="color: #d0d0d0">}</span>

		<span style="color: #6ab825; font-weight: bold">if</span><span style="color: #d0d0d0">(</span><span style="color: #40ffff">$result</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">num_rows</span><span style="color: #d0d0d0">&gt;</span><span style="color: #3677a9">0</span><span style="color: #d0d0d0">){</span>
			<span style="color: #6ab825; font-weight: bold">while</span><span style="color: #d0d0d0">(</span><span style="color: #40ffff">$row</span> <span style="color: #d0d0d0">=</span> <span style="color: #40ffff">$result</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">fetch_assoc</span><span style="color: #d0d0d0">()){</span>
				<span style="color: #6ab825; font-weight: bold">if</span><span style="color: #d0d0d0">(</span><span style="color: #40ffff">$row</span><span style="color: #d0d0d0">[</span><span style="color: #ed9d13">&#39;redeemed&#39;</span><span style="color: #d0d0d0">]</span> <span style="color: #d0d0d0">==</span> <span style="color: #6ab825; font-weight: bold">NULL</span><span style="color: #d0d0d0">){</span>
					<span style="color: #40ffff">$sql</span> <span style="color: #d0d0d0">=</span> <span style="color: #ed9d13">&quot;UPDATE `contracts` SET redeemed = NOW(), serial_number = &#39;$serial&#39;, email = &#39;$email&#39;, start_date = &#39;$start&#39;, notes = &#39;$note&#39; WHERE REPLACE(`key`,&#39;-&#39;,&#39;&#39;) = REPLACE(&#39;$key&#39;,&#39;-&#39;,&#39;&#39;)&quot;</span><span style="color: #d0d0d0">;</span>
					<span style="color: #40ffff">$this</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">mysqli</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">query</span><span style="color: #d0d0d0">(</span><span style="color: #40ffff">$sql</span><span style="color: #d0d0d0">);</span>
					<span style="color: #40ffff">$response</span><span style="color: #d0d0d0">[</span><span style="color: #ed9d13">&#39;status&#39;</span><span style="color: #d0d0d0">]</span> <span style="color: #d0d0d0">=</span> <span style="color: #ed9d13">&quot;Redeemed&quot;</span><span style="color: #d0d0d0">;</span>
				<span style="color: #d0d0d0">}</span>
				<span style="color: #6ab825; font-weight: bold">else</span> <span style="color: #40ffff">$response</span><span style="color: #d0d0d0">[</span><span style="color: #ed9d13">&#39;status&#39;</span><span style="color: #d0d0d0">]</span> <span style="color: #d0d0d0">=</span> <span style="color: #ed9d13">&quot;Invalid Key&quot;</span><span style="color: #d0d0d0">;</span>
			<span style="color: #d0d0d0">}</span>
		<span style="color: #d0d0d0">}</span>
		<span style="color: #6ab825; font-weight: bold">else</span> <span style="color: #40ffff">$response</span><span style="color: #d0d0d0">[</span><span style="color: #ed9d13">&#39;status&#39;</span><span style="color: #d0d0d0">]</span> <span style="color: #d0d0d0">=</span> <span style="color: #ed9d13">&quot;Invalid Key&quot;</span><span style="color: #d0d0d0">;</span>

		<span style="color: #40ffff">$this</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">returnJson</span><span style="color: #d0d0d0">(</span><span style="color: #40ffff">$response</span><span style="color: #d0d0d0">);</span>
    <span style="color: #d0d0d0">}</span>

   <span style="color: #6ab825; font-weight: bold">public</span> <span style="color: #6ab825; font-weight: bold">function</span> <span style="color: #447fcf">actionCheckSerial</span><span style="color: #d0d0d0">()</span>
    <span style="color: #d0d0d0">{</span>
		<span style="color: #999999; font-style: italic">//header(&#39;Access-Control-Allow-Origin: https://infocuscorp.zendesk.com&#39;);</span>

    	<span style="color: #40ffff">$serial</span> <span style="color: #d0d0d0">=</span> <span style="color: #40ffff">$this</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">sanitizeSerial</span><span style="color: #d0d0d0">(craft()-&gt;</span><span style="color: #bbbbbb">request</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">getPost</span><span style="color: #d0d0d0">(</span><span style="color: #ed9d13">&#39;serial&#39;</span><span style="color: #d0d0d0">));</span>
		<span style="color: #40ffff">$sql</span> <span style="color: #d0d0d0">=</span> <span style="color: #ed9d13">&quot;SELECT * FROM install_base ib </span>
<span style="color: #ed9d13">		LEFT JOIN (</span>
<span style="color: #ed9d13">		SELECT CONCAT(\&quot;{\\\&quot;</span><span style="color: #d0d0d0">contracts\\\</span><span style="color: #ed9d13">&quot;:[\&quot;,</span>
<span style="color: #ed9d13">				GROUP_CONCAT(</span>
<span style="color: #ed9d13">					CONCAT(\&quot;{\\\&quot;</span><span style="color: #d0d0d0">part\\\</span><span style="color: #ed9d13">&quot;:\\\&quot;\&quot;,c.part_number,\&quot;\\\&quot;,\\\&quot;desc\\\&quot;:\\\&quot;\&quot;,REPLACE(IF(cd.description IS NULL,\&quot;\&quot;,cd.description),\&quot;\\\&quot;\&quot;,\&quot;&amp;Prime;\&quot;),\&quot;\\\&quot;}\&quot;)</span>
<span style="color: #ed9d13">                    )</span>
<span style="color: #ed9d13">				,\&quot;]}\&quot;) as c_group, c.serial_number FROM contracts c LEFT JOIN contract_data cd ON c.part_number = cd.part_number WHERE c.serial_number = &#39;$serial&#39; GROUP BY c.serial_number) as contract_group  ON contract_group.serial_number = ib.serial_number</span>
<span style="color: #ed9d13">	    WHERE ib.serial_number = &#39;$serial&#39;&quot;</span><span style="color: #d0d0d0">;</span>
		<span style="color: #40ffff">$result</span> <span style="color: #d0d0d0">=</span> <span style="color: #40ffff">$this</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">mysqli</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">query</span><span style="color: #d0d0d0">(</span><span style="color: #40ffff">$sql</span><span style="color: #d0d0d0">);</span>

		<span style="color: #6ab825; font-weight: bold">while</span><span style="color: #d0d0d0">(</span><span style="color: #40ffff">$row</span> <span style="color: #d0d0d0">=</span> <span style="color: #40ffff">$result</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">fetch_assoc</span><span style="color: #d0d0d0">())</span>
		  <span style="color: #d0d0d0">{</span>
			<span style="color: #6ab825; font-weight: bold">if</span><span style="color: #d0d0d0">(</span><span style="color: #40ffff">$row</span><span style="color: #d0d0d0">[</span><span style="color: #ed9d13">&#39;registered&#39;</span><span style="color: #d0d0d0">]</span> <span style="color: #d0d0d0">==</span> <span style="color: #ed9d13">&quot;TRUE&quot;</span><span style="color: #d0d0d0">){</span>
				<span style="color: #40ffff">$response</span><span style="color: #d0d0d0">[</span><span style="color: #ed9d13">&#39;registered&#39;</span><span style="color: #d0d0d0">]</span> <span style="color: #d0d0d0">=</span> <span style="color: #6ab825; font-weight: bold">true</span><span style="color: #d0d0d0">;</span>
				<span style="color: #40ffff">$response</span><span style="color: #d0d0d0">[</span><span style="color: #ed9d13">&#39;first_name&#39;</span><span style="color: #d0d0d0">]</span> <span style="color: #d0d0d0">=</span> <span style="color: #40ffff">$row</span><span style="color: #d0d0d0">[</span><span style="color: #ed9d13">&#39;first_name&#39;</span><span style="color: #d0d0d0">];</span>
				<span style="color: #40ffff">$response</span><span style="color: #d0d0d0">[</span><span style="color: #ed9d13">&#39;last_name&#39;</span><span style="color: #d0d0d0">]</span> <span style="color: #d0d0d0">=</span> <span style="color: #40ffff">$row</span><span style="color: #d0d0d0">[</span><span style="color: #ed9d13">&#39;last_name&#39;</span><span style="color: #d0d0d0">];</span>
				<span style="color: #40ffff">$response</span><span style="color: #d0d0d0">[</span><span style="color: #ed9d13">&#39;org&#39;</span><span style="color: #d0d0d0">]</span> <span style="color: #d0d0d0">=</span> <span style="color: #40ffff">$row</span><span style="color: #d0d0d0">[</span><span style="color: #ed9d13">&#39;org&#39;</span><span style="color: #d0d0d0">];</span>
			<span style="color: #d0d0d0">}</span>
			<span style="color: #6ab825; font-weight: bold">else</span> <span style="color: #40ffff">$response</span><span style="color: #d0d0d0">[</span><span style="color: #ed9d13">&#39;registered&#39;</span><span style="color: #d0d0d0">]</span> <span style="color: #d0d0d0">=</span> <span style="color: #6ab825; font-weight: bold">false</span><span style="color: #d0d0d0">;</span>

				<span style="color: #40ffff">$response</span><span style="color: #d0d0d0">[</span><span style="color: #ed9d13">&#39;factory_start&#39;</span><span style="color: #d0d0d0">]</span> <span style="color: #d0d0d0">=</span> <span style="color: #40ffff">$row</span><span style="color: #d0d0d0">[</span><span style="color: #ed9d13">&#39;from_date&#39;</span><span style="color: #d0d0d0">];</span>
				<span style="color: #40ffff">$response</span><span style="color: #d0d0d0">[</span><span style="color: #ed9d13">&#39;factory_end&#39;</span><span style="color: #d0d0d0">]</span> <span style="color: #d0d0d0">=</span> <span style="color: #40ffff">$row</span><span style="color: #d0d0d0">[</span><span style="color: #ed9d13">&#39;to_date&#39;</span><span style="color: #d0d0d0">];</span>
				<span style="color: #6ab825; font-weight: bold">if</span><span style="color: #d0d0d0">(</span><span style="color: #40ffff">$row</span><span style="color: #d0d0d0">[</span><span style="color: #ed9d13">&#39;c_group&#39;</span><span style="color: #d0d0d0">]</span> <span style="color: #d0d0d0">!=</span> <span style="color: #6ab825; font-weight: bold">null</span><span style="color: #d0d0d0">)</span>
				<span style="color: #d0d0d0">{</span>
				<span style="color: #40ffff">$response</span><span style="color: #d0d0d0">[</span><span style="color: #ed9d13">&#39;contracts&#39;</span><span style="color: #d0d0d0">]</span> <span style="color: #d0d0d0">=</span> <span style="color: #24909d">json_decode</span><span style="color: #d0d0d0">(</span><span style="color: #40ffff">$row</span><span style="color: #d0d0d0">[</span><span style="color: #ed9d13">&#39;c_group&#39;</span><span style="color: #d0d0d0">]);</span>
				<span style="color: #40ffff">$response</span><span style="color: #d0d0d0">[</span><span style="color: #ed9d13">&#39;contracts&#39;</span><span style="color: #d0d0d0">]</span> <span style="color: #d0d0d0">=</span> <span style="color: #40ffff">$response</span><span style="color: #d0d0d0">[</span><span style="color: #ed9d13">&#39;contracts&#39;</span><span style="color: #d0d0d0">]-&gt;</span><span style="color: #bbbbbb">contracts</span><span style="color: #d0d0d0">;</span>
				<span style="color: #d0d0d0">}</span>
				<span style="color: #40ffff">$this</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">returnJson</span><span style="color: #d0d0d0">(</span><span style="color: #40ffff">$response</span><span style="color: #d0d0d0">);</span>
			<span style="color: #d0d0d0">}</span>


		<span style="color: #40ffff">$sql</span> <span style="color: #d0d0d0">=</span> <span style="color: #ed9d13">&quot;SELECT * FROM sn_prefix p WHERE LEFT(&#39;$serial&#39;,3) = p.prefix&quot;</span><span style="color: #d0d0d0">;</span> 
		<span style="color: #40ffff">$result</span> <span style="color: #d0d0d0">=</span> <span style="color: #40ffff">$this</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">mysqli</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">query</span><span style="color: #d0d0d0">(</span><span style="color: #40ffff">$sql</span><span style="color: #d0d0d0">);</span>
		 <span style="color: #40ffff">$response</span><span style="color: #d0d0d0">[</span><span style="color: #ed9d13">&#39;results&#39;</span><span style="color: #d0d0d0">]</span> <span style="color: #d0d0d0">=</span> <span style="color: #ed9d13">&quot;Prefix Match&quot;</span><span style="color: #d0d0d0">;</span>

		<span style="color: #6ab825; font-weight: bold">while</span><span style="color: #d0d0d0">(</span><span style="color: #40ffff">$row</span> <span style="color: #d0d0d0">=</span> <span style="color: #40ffff">$result</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">fetch_assoc</span><span style="color: #d0d0d0">())</span>
		  <span style="color: #d0d0d0">{</span>
		  	<span style="color: #40ffff">$firstShip</span> <span style="color: #d0d0d0">=</span> <span style="color: #40ffff">$row</span><span style="color: #d0d0d0">[</span><span style="color: #ed9d13">&#39;first_ship&#39;</span><span style="color: #d0d0d0">];</span>
			<span style="color: #24909d">preg_match_all</span><span style="color: #d0d0d0">(</span><span style="color: #ed9d13">&quot;/[0-9]/&quot;</span><span style="color: #d0d0d0">,</span> <span style="color: #40ffff">$serial</span><span style="color: #d0d0d0">,</span> <span style="color: #40ffff">$matches</span><span style="color: #d0d0d0">);</span>

			<span style="color: #6ab825; font-weight: bold">if</span> <span style="color: #d0d0d0">(</span><span style="color: #40ffff">$matches</span><span style="color: #d0d0d0">[</span><span style="color: #3677a9">0</span><span style="color: #d0d0d0">][</span><span style="color: #3677a9">0</span><span style="color: #d0d0d0">]</span> <span style="color: #d0d0d0">&lt;</span> <span style="color: #d0d0d0">(substr(</span><span style="color: #40ffff">$firstShip</span><span style="color: #d0d0d0">,-</span><span style="color: #3677a9">1</span><span style="color: #d0d0d0">)-</span><span style="color: #3677a9">1</span><span style="color: #d0d0d0">))</span> <span style="color: #40ffff">$firstShip</span> <span style="color: #d0d0d0">=</span> <span style="color: #40ffff">$firstShip</span><span style="color: #d0d0d0">+</span><span style="color: #3677a9">10</span><span style="color: #d0d0d0">;</span>

			<span style="color: #40ffff">$year</span> <span style="color: #d0d0d0">=</span> <span style="color: #d0d0d0">substr(</span><span style="color: #40ffff">$firstShip</span><span style="color: #d0d0d0">,</span><span style="color: #3677a9">0</span><span style="color: #d0d0d0">,</span><span style="color: #3677a9">3</span><span style="color: #d0d0d0">).</span><span style="color: #40ffff">$matches</span><span style="color: #d0d0d0">[</span><span style="color: #3677a9">0</span><span style="color: #d0d0d0">][</span><span style="color: #3677a9">0</span><span style="color: #d0d0d0">];</span>
			<span style="color: #40ffff">$week</span> <span style="color: #d0d0d0">=</span> <span style="color: #40ffff">$matches</span><span style="color: #d0d0d0">[</span><span style="color: #3677a9">0</span><span style="color: #d0d0d0">][</span><span style="color: #3677a9">1</span><span style="color: #d0d0d0">].</span><span style="color: #40ffff">$matches</span><span style="color: #d0d0d0">[</span><span style="color: #3677a9">0</span><span style="color: #d0d0d0">][</span><span style="color: #3677a9">2</span><span style="color: #d0d0d0">];</span>
			<span style="color: #40ffff">$start</span> <span style="color: #d0d0d0">=</span> <span style="color: #24909d">date</span><span style="color: #d0d0d0">(</span><span style="color: #ed9d13">&quot;M jS, Y&quot;</span><span style="color: #d0d0d0">,</span> <span style="color: #24909d">strtotime</span><span style="color: #d0d0d0">(</span><span style="color: #ed9d13">&quot;01 Jan &quot;</span><span style="color: #d0d0d0">.</span><span style="color: #40ffff">$year</span><span style="color: #d0d0d0">.</span><span style="color: #ed9d13">&quot; 00:00:00 GMT + &quot;</span><span style="color: #d0d0d0">.</span><span style="color: #40ffff">$week</span><span style="color: #d0d0d0">.</span><span style="color: #ed9d13">&quot; weeks&quot;</span><span style="color: #d0d0d0">));</span>
			<span style="color: #40ffff">$response</span><span style="color: #d0d0d0">[</span><span style="color: #ed9d13">&#39;likely_start&#39;</span><span style="color: #d0d0d0">]</span> <span style="color: #d0d0d0">=</span> <span style="color: #40ffff">$start</span><span style="color: #d0d0d0">;</span>
			<span style="color: #40ffff">$this</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">returnJson</span><span style="color: #d0d0d0">(</span><span style="color: #40ffff">$response</span><span style="color: #d0d0d0">);</span>
			<span style="color: #6ab825; font-weight: bold">exit</span><span style="color: #d0d0d0">();</span>
			<span style="color: #d0d0d0">}</span>

		<span style="color: #40ffff">$response</span><span style="color: #d0d0d0">[</span><span style="color: #ed9d13">&#39;results&#39;</span><span style="color: #d0d0d0">]</span> <span style="color: #d0d0d0">=</span> <span style="color: #ed9d13">&quot;No Results&quot;</span><span style="color: #d0d0d0">;</span>
		<span style="color: #40ffff">$this</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">returnJson</span><span style="color: #d0d0d0">(</span><span style="color: #40ffff">$response</span><span style="color: #d0d0d0">);</span>
    <span style="color: #d0d0d0">}</span>

   <span style="color: #6ab825; font-weight: bold">public</span> <span style="color: #6ab825; font-weight: bold">function</span> <span style="color: #447fcf">actionCheckSerialBasic</span><span style="color: #d0d0d0">()</span>
    <span style="color: #d0d0d0">{</span>

    	<span style="color: #40ffff">$serials</span> <span style="color: #d0d0d0">=</span> <span style="color: #d0d0d0">craft()-&gt;</span><span style="color: #bbbbbb">request</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">getPost</span><span style="color: #d0d0d0">(</span><span style="color: #ed9d13">&#39;serial&#39;</span><span style="color: #d0d0d0">);</span>
    	<span style="color: #40ffff">$response</span><span style="color: #d0d0d0">=[];</span>
    	<span style="color: #6ab825; font-weight: bold">foreach</span><span style="color: #d0d0d0">(</span><span style="color: #40ffff">$serials</span> <span style="color: #6ab825; font-weight: bold">as</span> <span style="color: #40ffff">$serial</span><span style="color: #d0d0d0">)</span> <span style="color: #d0d0d0">{</span> 
    	<span style="color: #40ffff">$returnData</span> <span style="color: #d0d0d0">=</span> <span style="color: #d0d0d0">[];</span>
		<span style="color: #40ffff">$returnData</span><span style="color: #d0d0d0">[</span><span style="color: #40ffff">$serial</span><span style="color: #d0d0d0">]</span> <span style="color: #d0d0d0">=</span> <span style="color: #ed9d13">&quot;&quot;</span><span style="color: #d0d0d0">;</span>

		<span style="color: #40ffff">$sql</span> <span style="color: #d0d0d0">=</span> <span style="color: #ed9d13">&quot;SELECT * FROM install_base ib  WHERE serial_number = &#39;$serial&#39;&quot;</span><span style="color: #d0d0d0">;</span>
		<span style="color: #40ffff">$result</span> <span style="color: #d0d0d0">=</span> <span style="color: #40ffff">$this</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">mysqli</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">query</span><span style="color: #d0d0d0">(</span><span style="color: #40ffff">$sql</span><span style="color: #d0d0d0">);</span>
		<span style="color: #6ab825; font-weight: bold">while</span><span style="color: #d0d0d0">(</span><span style="color: #40ffff">$row</span> <span style="color: #d0d0d0">=</span> <span style="color: #40ffff">$result</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">fetch_assoc</span><span style="color: #d0d0d0">())</span> <span style="color: #6ab825; font-weight: bold">if</span><span style="color: #d0d0d0">(</span><span style="color: #40ffff">$row</span><span style="color: #d0d0d0">[</span><span style="color: #ed9d13">&#39;registered&#39;</span><span style="color: #d0d0d0">]</span> <span style="color: #d0d0d0">==</span> <span style="color: #ed9d13">&quot;TRUE&quot;</span><span style="color: #d0d0d0">)</span> <span style="color: #40ffff">$returnData</span><span style="color: #d0d0d0">[</span><span style="color: #40ffff">$serial</span><span style="color: #d0d0d0">]</span> <span style="color: #d0d0d0">=</span> <span style="color: #ed9d13">&#39;Registered&#39;</span><span style="color: #d0d0d0">;</span>
		<span style="color: #6ab825; font-weight: bold">if</span><span style="color: #d0d0d0">(</span><span style="color: #40ffff">$result</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">num_rows</span> <span style="color: #d0d0d0">==</span> <span style="color: #3677a9">0</span><span style="color: #d0d0d0">)</span> <span style="color: #40ffff">$returnData</span><span style="color: #d0d0d0">[</span><span style="color: #40ffff">$serial</span><span style="color: #d0d0d0">]</span> <span style="color: #d0d0d0">=</span> <span style="color: #ed9d13">&quot;Not in IB&quot;</span><span style="color: #d0d0d0">;</span>

		<span style="color: #40ffff">$sql</span> <span style="color: #d0d0d0">=</span> <span style="color: #ed9d13">&quot;SELECT * FROM sn_prefix p WHERE LEFT(&#39;$serial&#39;,3) = p.prefix&quot;</span><span style="color: #d0d0d0">;</span> 
		<span style="color: #40ffff">$result</span> <span style="color: #d0d0d0">=</span> <span style="color: #40ffff">$this</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">mysqli</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">query</span><span style="color: #d0d0d0">(</span><span style="color: #40ffff">$sql</span><span style="color: #d0d0d0">);</span>
		<span style="color: #6ab825; font-weight: bold">if</span><span style="color: #d0d0d0">(</span><span style="color: #40ffff">$result</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">num_rows</span> <span style="color: #d0d0d0">==</span> <span style="color: #3677a9">0</span><span style="color: #d0d0d0">)</span> <span style="color: #40ffff">$returnData</span><span style="color: #d0d0d0">[</span><span style="color: #40ffff">$serial</span><span style="color: #d0d0d0">]</span> <span style="color: #d0d0d0">=</span> <span style="color: #ed9d13">&quot;No Prefix&quot;</span><span style="color: #d0d0d0">;</span>
		<span style="color: #40ffff">$response</span><span style="color: #d0d0d0">[]=</span><span style="color: #40ffff">$returnData</span><span style="color: #d0d0d0">;</span>
    	<span style="color: #d0d0d0">}</span>

		<span style="color: #40ffff">$this</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">returnJson</span><span style="color: #d0d0d0">(</span><span style="color: #40ffff">$response</span><span style="color: #d0d0d0">);</span>
    <span style="color: #d0d0d0">}</span>

   <span style="color: #6ab825; font-weight: bold">public</span> <span style="color: #6ab825; font-weight: bold">function</span> <span style="color: #447fcf">actionGetRegistration</span><span style="color: #d0d0d0">()</span>
    <span style="color: #d0d0d0">{</span>
    	<span style="color: #40ffff">$serial</span> <span style="color: #d0d0d0">=</span> <span style="color: #40ffff">$this</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">sanitizeSerial</span><span style="color: #d0d0d0">(strtoupper(craft()-&gt;</span><span style="color: #bbbbbb">request</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">getPost</span><span style="color: #d0d0d0">(</span><span style="color: #ed9d13">&#39;serial&#39;</span><span style="color: #d0d0d0">)));</span>
		<span style="color: #40ffff">$email</span> <span style="color: #d0d0d0">=</span> <span style="color: #d0d0d0">craft()-&gt;</span><span style="color: #bbbbbb">request</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">getPost</span><span style="color: #d0d0d0">(</span><span style="color: #ed9d13">&#39;email&#39;</span><span style="color: #d0d0d0">);</span>
		<span style="color: #6ab825; font-weight: bold">if</span><span style="color: #d0d0d0">(</span><span style="color: #40ffff">$email</span><span style="color: #d0d0d0">)</span>
		<span style="color: #d0d0d0">{</span>
			<span style="color: #40ffff">$sql</span> <span style="color: #d0d0d0">=</span> <span style="color: #ed9d13">&quot;SELECT * FROM install_base ib </span>
<span style="color: #ed9d13">		    WHERE ib.serial_number = &#39;$serial&#39; AND (email = &#39;$email&#39; OR secondary_email = &#39;$email&#39;)&quot;</span><span style="color: #d0d0d0">;</span>
			<span style="color: #40ffff">$result</span> <span style="color: #d0d0d0">=</span> <span style="color: #40ffff">$this</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">mysqli</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">query</span><span style="color: #d0d0d0">(</span><span style="color: #40ffff">$sql</span><span style="color: #d0d0d0">);</span>

			<span style="color: #6ab825; font-weight: bold">while</span><span style="color: #d0d0d0">(</span><span style="color: #40ffff">$row</span> <span style="color: #d0d0d0">=</span> <span style="color: #40ffff">$result</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">fetch_assoc</span><span style="color: #d0d0d0">())</span> <span style="color: #40ffff">$this</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">returnJson</span><span style="color: #d0d0d0">(</span><span style="color: #40ffff">$row</span><span style="color: #d0d0d0">);</span>
			
			<span style="color: #40ffff">$this</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">returnJson</span><span style="color: #d0d0d0">(</span><span style="color: #ed9d13">&quot;No match&quot;</span><span style="color: #d0d0d0">);</span>
		<span style="color: #d0d0d0">}</span>
		<span style="color: #6ab825; font-weight: bold">else</span>
		<span style="color: #d0d0d0">{</span>
			<span style="color: #40ffff">$sql</span> <span style="color: #d0d0d0">=</span> <span style="color: #ed9d13">&quot;SELECT * FROM install_base ib </span>
<span style="color: #ed9d13">		    WHERE ib.serial_number = &#39;$serial&#39;&quot;</span><span style="color: #d0d0d0">;</span>
			<span style="color: #40ffff">$result</span> <span style="color: #d0d0d0">=</span> <span style="color: #40ffff">$this</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">mysqli</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">query</span><span style="color: #d0d0d0">(</span><span style="color: #40ffff">$sql</span><span style="color: #d0d0d0">);</span>

			<span style="color: #6ab825; font-weight: bold">while</span><span style="color: #d0d0d0">(</span><span style="color: #40ffff">$row</span> <span style="color: #d0d0d0">=</span> <span style="color: #40ffff">$result</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">fetch_assoc</span><span style="color: #d0d0d0">())</span> <span style="color: #6ab825; font-weight: bold">if</span><span style="color: #d0d0d0">(</span><span style="color: #40ffff">$row</span><span style="color: #d0d0d0">[</span><span style="color: #ed9d13">&#39;registered&#39;</span><span style="color: #d0d0d0">]</span> <span style="color: #d0d0d0">==</span> <span style="color: #ed9d13">&quot;TRUE&quot;</span><span style="color: #d0d0d0">)</span> <span style="color: #40ffff">$this</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">returnJson</span><span style="color: #d0d0d0">(</span><span style="color: #ed9d13">&quot;Registered&quot;</span><span style="color: #d0d0d0">);</span>
			<span style="color: #40ffff">$this</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">returnJson</span><span style="color: #d0d0d0">(</span><span style="color: #ed9d13">&quot;Not registered&quot;</span><span style="color: #d0d0d0">);</span>
		<span style="color: #d0d0d0">}</span>
    <span style="color: #d0d0d0">}</span>

   <span style="color: #6ab825; font-weight: bold">public</span> <span style="color: #6ab825; font-weight: bold">function</span> <span style="color: #447fcf">actionGetRegistrationInternal</span><span style="color: #d0d0d0">()</span>
    <span style="color: #d0d0d0">{</span>
    	<span style="color: #40ffff">$this</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">allowAnonymous</span> <span style="color: #d0d0d0">=</span> <span style="color: #6ab825; font-weight: bold">false</span><span style="color: #d0d0d0">;</span>

		<span style="color: #40ffff">$serial</span> <span style="color: #d0d0d0">=</span> <span style="color: #d0d0d0">strtoupper(craft()-&gt;</span><span style="color: #bbbbbb">request</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">getPost</span><span style="color: #d0d0d0">(</span><span style="color: #ed9d13">&#39;serial_number&#39;</span><span style="color: #d0d0d0">));</span>
    	<span style="color: #40ffff">$serial</span> <span style="color: #d0d0d0">=</span> <span style="color: #40ffff">$this</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">sanitizeSerial</span><span style="color: #d0d0d0">(</span><span style="color: #40ffff">$serial</span><span style="color: #d0d0d0">);</span>
		<span style="color: #40ffff">$sql</span> <span style="color: #d0d0d0">=</span> <span style="color: #ed9d13">&quot;SELECT * FROM install_base ib </span>
<span style="color: #ed9d13">	    WHERE ib.serial_number = &#39;$serial&#39;&quot;</span><span style="color: #d0d0d0">;</span>
		<span style="color: #40ffff">$result</span> <span style="color: #d0d0d0">=</span> <span style="color: #40ffff">$this</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">mysqli</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">query</span><span style="color: #d0d0d0">(</span><span style="color: #40ffff">$sql</span><span style="color: #d0d0d0">);</span>

		<span style="color: #6ab825; font-weight: bold">while</span><span style="color: #d0d0d0">(</span><span style="color: #40ffff">$row</span> <span style="color: #d0d0d0">=</span> <span style="color: #40ffff">$result</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">fetch_assoc</span><span style="color: #d0d0d0">())</span> <span style="color: #40ffff">$this</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">returnJson</span><span style="color: #d0d0d0">(</span><span style="color: #40ffff">$row</span><span style="color: #d0d0d0">);</span>

		<span style="color: #40ffff">$response</span><span style="color: #d0d0d0">[</span><span style="color: #ed9d13">&#39;results&#39;</span><span style="color: #d0d0d0">]</span> <span style="color: #d0d0d0">=</span> <span style="color: #ed9d13">&quot;No Results&quot;</span><span style="color: #d0d0d0">;</span>
		<span style="color: #40ffff">$this</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">returnJson</span><span style="color: #d0d0d0">(</span><span style="color: #40ffff">$response</span><span style="color: #d0d0d0">);</span>
    <span style="color: #d0d0d0">}</span>

   <span style="color: #6ab825; font-weight: bold">public</span> <span style="color: #6ab825; font-weight: bold">function</span> <span style="color: #447fcf">actionUpdateRegistrationInternal</span><span style="color: #d0d0d0">()</span>
    <span style="color: #d0d0d0">{</span>
		<span style="color: #40ffff">$data</span> <span style="color: #d0d0d0">=</span> <span style="color: #d0d0d0">craft()-&gt;</span><span style="color: #bbbbbb">request</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">getParam</span><span style="color: #d0d0d0">(</span><span style="color: #ed9d13">&#39;data&#39;</span><span style="color: #d0d0d0">);</span>
		<span style="color: #40ffff">$fields</span> <span style="color: #d0d0d0">=</span> <span style="color: #d0d0d0">craft()-&gt;</span><span style="color: #bbbbbb">request</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">getParam</span><span style="color: #d0d0d0">(</span><span style="color: #ed9d13">&#39;fields&#39;</span><span style="color: #d0d0d0">);</span>
		<span style="color: #40ffff">$testArray</span><span style="color: #d0d0d0">=[];</span>
		<span style="color: #6ab825; font-weight: bold">foreach</span><span style="color: #d0d0d0">(</span><span style="color: #40ffff">$data</span> <span style="color: #6ab825; font-weight: bold">as</span> <span style="color: #40ffff">$row</span><span style="color: #d0d0d0">){</span>
		<span style="color: #40ffff">$sqlArray</span> <span style="color: #d0d0d0">=</span> <span style="color: #d0d0d0">[];</span>
		<span style="color: #40ffff">$id</span> <span style="color: #d0d0d0">=</span> <span style="color: #ed9d13">&#39;&#39;</span><span style="color: #d0d0d0">;</span>
			<span style="color: #6ab825; font-weight: bold">for</span> <span style="color: #d0d0d0">(</span><span style="color: #40ffff">$i</span><span style="color: #d0d0d0">=</span><span style="color: #3677a9">0</span><span style="color: #d0d0d0">;</span> <span style="color: #40ffff">$i</span> <span style="color: #d0d0d0">&lt;</span> <span style="color: #24909d">count</span><span style="color: #d0d0d0">(</span><span style="color: #40ffff">$row</span><span style="color: #d0d0d0">);</span> <span style="color: #40ffff">$i</span><span style="color: #d0d0d0">++)</span> <span style="color: #d0d0d0">{</span> 
				<span style="color: #6ab825; font-weight: bold">if</span><span style="color: #d0d0d0">(</span><span style="color: #40ffff">$fields</span><span style="color: #d0d0d0">[</span><span style="color: #40ffff">$i</span><span style="color: #d0d0d0">]</span> <span style="color: #d0d0d0">!=</span> <span style="color: #ed9d13">&quot;old_serial&quot;</span><span style="color: #d0d0d0">){</span>
					<span style="color: #40ffff">$row</span><span style="color: #d0d0d0">[</span><span style="color: #40ffff">$i</span><span style="color: #d0d0d0">]</span> <span style="color: #d0d0d0">=</span> <span style="color: #40ffff">$this</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">mysqli</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">real_escape_string</span><span style="color: #d0d0d0">(</span><span style="color: #40ffff">$row</span><span style="color: #d0d0d0">[</span><span style="color: #40ffff">$i</span><span style="color: #d0d0d0">]);</span>
					<span style="color: #40ffff">$sqlArray</span><span style="color: #d0d0d0">[]=</span> <span style="color: #ed9d13">&quot;`{</span><span style="color: #40ffff">$fields</span><span style="color: #d0d0d0">[</span><span style="color: #40ffff">$i</span><span style="color: #d0d0d0">]</span><span style="color: #ed9d13">}` = &#39;{</span><span style="color: #40ffff">$row</span><span style="color: #d0d0d0">[</span><span style="color: #40ffff">$i</span><span style="color: #d0d0d0">]</span><span style="color: #ed9d13">}&#39;&quot;</span><span style="color: #d0d0d0">;</span>
				<span style="color: #d0d0d0">}</span>
				<span style="color: #6ab825; font-weight: bold">else</span> <span style="color: #40ffff">$id</span> <span style="color: #d0d0d0">=</span> <span style="color: #40ffff">$row</span><span style="color: #d0d0d0">[</span><span style="color: #40ffff">$i</span><span style="color: #d0d0d0">];</span>
			<span style="color: #d0d0d0">}</span>
			<span style="color: #6ab825; font-weight: bold">if</span><span style="color: #d0d0d0">(!</span><span style="color: #40ffff">$id</span><span style="color: #d0d0d0">)</span> <span style="color: #40ffff">$id</span> <span style="color: #d0d0d0">=</span> <span style="color: #40ffff">$row</span><span style="color: #d0d0d0">[</span><span style="color: #3677a9">0</span><span style="color: #d0d0d0">];</span>
			<span style="color: #40ffff">$sql</span> <span style="color: #d0d0d0">=</span> <span style="color: #ed9d13">&quot;UPDATE ib_pending SET &quot;</span> <span style="color: #d0d0d0">.</span> <span style="color: #24909d">implode</span><span style="color: #d0d0d0">(</span><span style="color: #ed9d13">&quot;,&quot;</span><span style="color: #d0d0d0">,</span><span style="color: #40ffff">$sqlArray</span><span style="color: #d0d0d0">)</span> <span style="color: #d0d0d0">.</span> <span style="color: #ed9d13">&quot; WHERE serial_number = &#39;$id&#39;&quot;</span><span style="color: #d0d0d0">;</span>
			<span style="color: #40ffff">$testArray</span><span style="color: #d0d0d0">[]</span> <span style="color: #d0d0d0">=</span> <span style="color: #40ffff">$sql</span><span style="color: #d0d0d0">;</span>
			<span style="color: #40ffff">$result</span> <span style="color: #d0d0d0">=</span> <span style="color: #40ffff">$this</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">mysqli</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">query</span><span style="color: #d0d0d0">(</span><span style="color: #40ffff">$sql</span><span style="color: #d0d0d0">);</span>
		<span style="color: #d0d0d0">}</span>
			<span style="color: #40ffff">$this</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">returnJson</span><span style="color: #d0d0d0">(</span><span style="color: #ed9d13">&quot;success&quot;</span><span style="color: #d0d0d0">);</span>
    <span style="color: #d0d0d0">}</span>

   <span style="color: #6ab825; font-weight: bold">public</span> <span style="color: #6ab825; font-weight: bold">function</span> <span style="color: #447fcf">actionRegister</span><span style="color: #d0d0d0">()</span>
    <span style="color: #d0d0d0">{</span>
    	<span style="color: #999999; font-style: italic">//craft()-&gt;allowAnonymous = true;</span>
    	<span style="color: #6ab825; font-weight: bold">require_once</span><span style="color: #d0d0d0">(CRAFT_BASE_PATH</span> <span style="color: #d0d0d0">.</span><span style="color: #ed9d13">&quot;/app/etc/web/UploadedFile.php&quot;</span><span style="color: #d0d0d0">);</span>

	   	<span style="color: #40ffff">$file_tmp</span> <span style="color: #d0d0d0">=</span><span style="color: #ed9d13">&#39;&#39;</span><span style="color: #d0d0d0">;</span>
	   	<span style="color: #40ffff">$file</span> <span style="color: #d0d0d0">=</span> <span style="color: #d0d0d0">UploadedFile::</span><span style="color: #bbbbbb">getInstanceByName</span><span style="color: #d0d0d0">(</span><span style="color: #ed9d13">&#39;pop&#39;</span><span style="color: #d0d0d0">);</span>
		<span style="color: #6ab825; font-weight: bold">if</span><span style="color: #d0d0d0">(</span><span style="color: #40ffff">$file</span><span style="color: #d0d0d0">)</span> <span style="color: #40ffff">$file_tmp</span> <span style="color: #d0d0d0">=</span> <span style="color: #40ffff">$file</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">getTempName</span><span style="color: #d0d0d0">();</span>


    	<span style="color: #40ffff">$regdata</span> <span style="color: #d0d0d0">=</span> <span style="color: #6ab825; font-weight: bold">new</span> <span style="color: #d0d0d0">\stdClass();</span>
		<span style="color: #40ffff">$regdata</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">serial</span> <span style="color: #d0d0d0">=</span> <span style="color: #40ffff">$this</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">sanitizeSerial</span><span style="color: #d0d0d0">(craft()-&gt;</span><span style="color: #bbbbbb">request</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">getPost</span><span style="color: #d0d0d0">(</span><span style="color: #ed9d13">&#39;serial_number&#39;</span><span style="color: #d0d0d0">));</span>
		<span style="color: #40ffff">$regdata</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">first</span> <span style="color: #d0d0d0">=</span> <span style="color: #40ffff">$this</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">mysqli</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">real_escape_string</span><span style="color: #d0d0d0">(craft()-&gt;</span><span style="color: #bbbbbb">request</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">getPost</span><span style="color: #d0d0d0">(</span><span style="color: #ed9d13">&#39;first_name&#39;</span><span style="color: #d0d0d0">));</span>
		<span style="color: #40ffff">$regdata</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">last</span> <span style="color: #d0d0d0">=</span> <span style="color: #40ffff">$this</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">mysqli</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">real_escape_string</span><span style="color: #d0d0d0">(craft()-&gt;</span><span style="color: #bbbbbb">request</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">getPost</span><span style="color: #d0d0d0">(</span><span style="color: #ed9d13">&#39;last_name&#39;</span><span style="color: #d0d0d0">));</span>
		<span style="color: #40ffff">$regdata</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">org</span> <span style="color: #d0d0d0">=</span> <span style="color: #40ffff">$this</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">mysqli</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">real_escape_string</span><span style="color: #d0d0d0">(craft()-&gt;</span><span style="color: #bbbbbb">request</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">getPost</span><span style="color: #d0d0d0">(</span><span style="color: #ed9d13">&#39;org&#39;</span><span style="color: #d0d0d0">));</span>
		<span style="color: #40ffff">$regdata</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">email</span> <span style="color: #d0d0d0">=</span> <span style="color: #40ffff">$this</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">mysqli</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">real_escape_string</span><span style="color: #d0d0d0">(craft()-&gt;</span><span style="color: #bbbbbb">request</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">getPost</span><span style="color: #d0d0d0">(</span><span style="color: #ed9d13">&#39;email&#39;</span><span style="color: #d0d0d0">));</span>
		<span style="color: #40ffff">$regdata</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">reg_country</span> <span style="color: #d0d0d0">=</span> <span style="color: #40ffff">$this</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">mysqli</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">real_escape_string</span><span style="color: #d0d0d0">(craft()-&gt;</span><span style="color: #bbbbbb">request</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">getPost</span><span style="color: #d0d0d0">(</span><span style="color: #ed9d13">&#39;country&#39;</span><span style="color: #d0d0d0">));</span>
		<span style="color: #40ffff">$regdata</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">country</span> <span style="color: #d0d0d0">=</span> <span style="color: #40ffff">$regdata</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">reg_country</span><span style="color: #d0d0d0">;</span>
		<span style="color: #40ffff">$regdata</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">phone</span> <span style="color: #d0d0d0">=</span> <span style="color: #40ffff">$this</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">mysqli</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">real_escape_string</span><span style="color: #d0d0d0">(craft()-&gt;</span><span style="color: #bbbbbb">request</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">getPost</span><span style="color: #d0d0d0">(</span><span style="color: #ed9d13">&#39;phone&#39;</span><span style="color: #d0d0d0">));</span>
		<span style="color: #40ffff">$regdata</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">address</span> <span style="color: #d0d0d0">=</span> <span style="color: #40ffff">$this</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">mysqli</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">real_escape_string</span><span style="color: #d0d0d0">(craft()-&gt;</span><span style="color: #bbbbbb">request</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">getPost</span><span style="color: #d0d0d0">(</span><span style="color: #ed9d13">&#39;address&#39;</span><span style="color: #d0d0d0">));</span>
		<span style="color: #40ffff">$regdata</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">city</span> <span style="color: #d0d0d0">=</span> <span style="color: #40ffff">$this</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">mysqli</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">real_escape_string</span><span style="color: #d0d0d0">(craft()-&gt;</span><span style="color: #bbbbbb">request</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">getPost</span><span style="color: #d0d0d0">(</span><span style="color: #ed9d13">&#39;city&#39;</span><span style="color: #d0d0d0">));</span>
		<span style="color: #40ffff">$regdata</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">state</span> <span style="color: #d0d0d0">=</span> <span style="color: #40ffff">$this</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">mysqli</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">real_escape_string</span><span style="color: #d0d0d0">(craft()-&gt;</span><span style="color: #bbbbbb">request</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">getPost</span><span style="color: #d0d0d0">(</span><span style="color: #ed9d13">&#39;state&#39;</span><span style="color: #d0d0d0">));</span>
		<span style="color: #40ffff">$regdata</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">zip</span> <span style="color: #d0d0d0">=</span> <span style="color: #40ffff">$this</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">mysqli</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">real_escape_string</span><span style="color: #d0d0d0">(craft()-&gt;</span><span style="color: #bbbbbb">request</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">getPost</span><span style="color: #d0d0d0">(</span><span style="color: #ed9d13">&#39;zip&#39;</span><span style="color: #d0d0d0">));</span>
		<span style="color: #40ffff">$regdata</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">product</span> <span style="color: #d0d0d0">=</span> <span style="color: #40ffff">$this</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">mysqli</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">real_escape_string</span><span style="color: #d0d0d0">(craft()-&gt;</span><span style="color: #bbbbbb">request</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">getPost</span><span style="color: #d0d0d0">(</span><span style="color: #ed9d13">&#39;part_number&#39;</span><span style="color: #d0d0d0">));</span>
		<span style="color: #40ffff">$regdata</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">second_name</span> <span style="color: #d0d0d0">=</span> <span style="color: #40ffff">$this</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">mysqli</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">real_escape_string</span><span style="color: #d0d0d0">(craft()-&gt;</span><span style="color: #bbbbbb">request</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">getPost</span><span style="color: #d0d0d0">(</span><span style="color: #ed9d13">&#39;secondary_name&#39;</span><span style="color: #d0d0d0">));</span>
		<span style="color: #40ffff">$regdata</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">second_email</span> <span style="color: #d0d0d0">=</span> <span style="color: #40ffff">$this</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">mysqli</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">real_escape_string</span><span style="color: #d0d0d0">(craft()-&gt;</span><span style="color: #bbbbbb">request</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">getPost</span><span style="color: #d0d0d0">(</span><span style="color: #ed9d13">&#39;secondary_email&#39;</span><span style="color: #d0d0d0">));</span>
		<span style="color: #40ffff">$regdata</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">ewCode</span> <span style="color: #d0d0d0">=</span> <span style="color: #d0d0d0">craft()-&gt;</span><span style="color: #bbbbbb">request</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">getPost</span><span style="color: #d0d0d0">(</span><span style="color: #ed9d13">&#39;ewCode&#39;</span><span style="color: #d0d0d0">);</span>
		<span style="color: #40ffff">$regdata</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">to</span> <span style="color: #d0d0d0">=</span> <span style="color: #ed9d13">&#39;&#39;</span><span style="color: #d0d0d0">;</span>

		<span style="color: #40ffff">$result</span> <span style="color: #d0d0d0">=</span> <span style="color: #40ffff">$this</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">mysqli</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">query</span><span style="color: #d0d0d0">(</span><span style="color: #ed9d13">&quot;SELECT * FROM install_base WHERE serial_number = &#39;$regdata-&gt;serial&#39;&quot;</span><span style="color: #d0d0d0">);</span>
		<span style="color: #999999; font-style: italic">//Pull prefix and associated company/group/form</span>
		<span style="color: #40ffff">$prefix_result</span> <span style="color: #d0d0d0">=</span> <span style="color: #40ffff">$this</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">mysqli</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">query</span><span style="color: #d0d0d0">(</span><span style="color: #ed9d13">&#39;SELECT * FROM sn_prefix WHERE prefix = &quot;&#39;</span> <span style="color: #d0d0d0">.</span> <span style="color: #d0d0d0">substr(</span><span style="color: #40ffff">$regdata</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">serial</span><span style="color: #d0d0d0">,</span><span style="color: #3677a9">0</span><span style="color: #d0d0d0">,</span><span style="color: #3677a9">3</span><span style="color: #d0d0d0">)</span> <span style="color: #d0d0d0">.</span> <span style="color: #ed9d13">&#39;&quot;&#39;</span> <span style="color: #d0d0d0">);</span>

		<span style="color: #999999; font-style: italic">//If no results default to InFocus form and group</span>
		<span style="color: #40ffff">$group</span> <span style="color: #d0d0d0">=</span> <span style="color: #3677a9">22386119</span><span style="color: #d0d0d0">;</span>
		<span style="color: #40ffff">$formnum</span> <span style="color: #d0d0d0">=</span> <span style="color: #3677a9">42349</span><span style="color: #d0d0d0">;</span>
		<span style="color: #40ffff">$brand</span> <span style="color: #d0d0d0">=</span> <span style="color: #3677a9">211259</span><span style="color: #d0d0d0">;</span>
		<span style="color: #40ffff">$companySwitch</span><span style="color: #d0d0d0">=</span><span style="color: #6ab825; font-weight: bold">false</span><span style="color: #d0d0d0">;</span>

		<span style="color: #999999; font-style: italic">//Assign specific or Default forms and groups</span>
		<span style="color: #6ab825; font-weight: bold">while</span><span style="color: #d0d0d0">(</span><span style="color: #40ffff">$row</span> <span style="color: #d0d0d0">=</span> <span style="color: #40ffff">$prefix_result</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">fetch_assoc</span> <span style="color: #d0d0d0">()){</span>
			<span style="color: #6ab825; font-weight: bold">if</span><span style="color: #d0d0d0">(</span><span style="color: #40ffff">$row</span><span style="color: #d0d0d0">[</span><span style="color: #ed9d13">&#39;company&#39;</span><span style="color: #d0d0d0">]</span> <span style="color: #d0d0d0">==</span> <span style="color: #ed9d13">&#39;Kangaroo&#39;</span><span style="color: #d0d0d0">)</span> <span style="color: #d0d0d0">{</span><span style="color: #40ffff">$companySwitch</span><span style="color: #d0d0d0">=</span><span style="color: #6ab825; font-weight: bold">true</span><span style="color: #d0d0d0">;</span><span style="color: #40ffff">$group</span> <span style="color: #d0d0d0">=</span> <span style="color: #3677a9">23244493</span><span style="color: #d0d0d0">;</span><span style="color: #40ffff">$formnum</span> <span style="color: #d0d0d0">=</span> <span style="color: #3677a9">42349</span><span style="color: #d0d0d0">;</span><span style="color: #40ffff">$brand</span> <span style="color: #d0d0d0">=</span> <span style="color: #3677a9">3314026</span><span style="color: #d0d0d0">;}</span>
			<span style="color: #6ab825; font-weight: bold">if</span><span style="color: #d0d0d0">(</span><span style="color: #40ffff">$row</span><span style="color: #d0d0d0">[</span><span style="color: #ed9d13">&#39;zd_group&#39;</span><span style="color: #d0d0d0">]!=</span> <span style="color: #6ab825; font-weight: bold">null</span><span style="color: #d0d0d0">)</span> <span style="color: #40ffff">$group</span> <span style="color: #d0d0d0">=</span> <span style="color: #40ffff">$row</span><span style="color: #d0d0d0">[</span><span style="color: #ed9d13">&#39;zd_group&#39;</span><span style="color: #d0d0d0">];</span>
			<span style="color: #6ab825; font-weight: bold">if</span><span style="color: #d0d0d0">(</span><span style="color: #40ffff">$row</span><span style="color: #d0d0d0">[</span><span style="color: #ed9d13">&#39;zd_form&#39;</span><span style="color: #d0d0d0">]!=</span> <span style="color: #6ab825; font-weight: bold">null</span><span style="color: #d0d0d0">)</span> <span style="color: #40ffff">$formnum</span> <span style="color: #d0d0d0">=</span> <span style="color: #40ffff">$row</span><span style="color: #d0d0d0">[</span><span style="color: #ed9d13">&#39;zd_form&#39;</span><span style="color: #d0d0d0">];</span>
			<span style="color: #40ffff">$regdata</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">product</span> <span style="color: #d0d0d0">=</span> <span style="color: #40ffff">$row</span><span style="color: #d0d0d0">[</span><span style="color: #ed9d13">&#39;part_number&#39;</span><span style="color: #d0d0d0">];</span>
			<span style="color: #d0d0d0">}</span>

	    <span style="color: #40ffff">$sql</span><span style="color: #d0d0d0">=</span><span style="color: #ed9d13">&quot; modified = CURDATE(),</span>
<span style="color: #ed9d13">	    first_name = &#39;$regdata-&gt;first&#39;,</span>
<span style="color: #ed9d13">	    last_name = &#39;$regdata-&gt;last&#39;,</span>
<span style="color: #ed9d13">	    org = &#39;$regdata-&gt;org&#39;,&quot;</span><span style="color: #d0d0d0">;</span>

		<span style="color: #999999; font-style: italic">//Check for existing record and pull available purchase data.</span>
	    <span style="color: #6ab825; font-weight: bold">if</span><span style="color: #d0d0d0">(</span><span style="color: #40ffff">$result</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">num_rows</span><span style="color: #d0d0d0">&gt;</span><span style="color: #3677a9">0</span><span style="color: #d0d0d0">){</span>
			<span style="color: #6ab825; font-weight: bold">while</span><span style="color: #d0d0d0">(</span><span style="color: #40ffff">$row</span> <span style="color: #d0d0d0">=</span> <span style="color: #40ffff">$result</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">fetch_assoc</span> <span style="color: #d0d0d0">()){</span>
				<span style="color: #40ffff">$regdata</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">product</span> <span style="color: #d0d0d0">=</span> <span style="color: #40ffff">$row</span><span style="color: #d0d0d0">[</span><span style="color: #ed9d13">&#39;part_number&#39;</span><span style="color: #d0d0d0">];</span>
				<span style="color: #40ffff">$regdata</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">inventdimid</span> <span style="color: #d0d0d0">=</span> <span style="color: #40ffff">$row</span><span style="color: #d0d0d0">[</span><span style="color: #ed9d13">&#39;INVENTDIMID&#39;</span><span style="color: #d0d0d0">];</span>
				<span style="color: #40ffff">$regdata</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">from</span> <span style="color: #d0d0d0">=</span> <span style="color: #40ffff">$row</span><span style="color: #d0d0d0">[</span><span style="color: #ed9d13">&#39;from_date&#39;</span><span style="color: #d0d0d0">];</span>
				<span style="color: #999999; font-style: italic">// `to_date` = &quot;&#39;. $row[&#39;to_date&#39;] . &#39;&quot;,</span>
				<span style="color: #40ffff">$regdata</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">sale</span> <span style="color: #d0d0d0">=</span> <span style="color: #40ffff">$row</span><span style="color: #d0d0d0">[</span><span style="color: #ed9d13">&#39;sales_id&#39;</span><span style="color: #d0d0d0">];</span>
				<span style="color: #40ffff">$regdata</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">reseller</span> <span style="color: #d0d0d0">=</span> <span style="color: #40ffff">$row</span><span style="color: #d0d0d0">[</span><span style="color: #ed9d13">&#39;name&#39;</span><span style="color: #d0d0d0">];</span>
				<span style="color: #40ffff">$regdata</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">country</span> <span style="color: #d0d0d0">=</span> <span style="color: #40ffff">$row</span><span style="color: #d0d0d0">[</span><span style="color: #ed9d13">&#39;country&#39;</span><span style="color: #d0d0d0">];</span>
				<span style="color: #999999; font-style: italic">// `status` = &quot;&#39;. $row[&#39;status&#39;] . &#39;&quot;,</span>
				<span style="color: #d0d0d0">}</span>
			<span style="color: #d0d0d0">}</span>

	    <span style="color: #40ffff">$regdata</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">optin</span> <span style="color: #d0d0d0">=</span> <span style="color: #d0d0d0">craft()-&gt;</span><span style="color: #bbbbbb">request</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">getPost</span><span style="color: #d0d0d0">(</span><span style="color: #ed9d13">&#39;optin&#39;</span><span style="color: #d0d0d0">);</span>

		<span style="color: #999999; font-style: italic">//If SN does not exist, file is attached, or eu warranty is true process into &quot;Pending&quot; IB and create ticket</span>
		<span style="color: #6ab825; font-weight: bold">if</span><span style="color: #d0d0d0">(</span><span style="color: #40ffff">$result</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">num_rows</span><span style="color: #d0d0d0">==</span><span style="color: #3677a9">0</span> <span style="color: #6ab825; font-weight: bold">OR</span> <span style="color: #40ffff">$file_tmp</span> <span style="color: #6ab825; font-weight: bold">OR</span> <span style="color: #d0d0d0">craft()-&gt;</span><span style="color: #bbbbbb">request</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">getParam</span><span style="color: #d0d0d0">(</span><span style="color: #ed9d13">&#39;euwar&#39;</span><span style="color: #d0d0d0">)</span> <span style="color: #d0d0d0">==</span> <span style="color: #3677a9">1</span><span style="color: #d0d0d0">){</span>

			<span style="color: #40ffff">$subject</span> <span style="color: #d0d0d0">=</span> <span style="color: #ed9d13">&quot;Registration Review&quot;</span><span style="color: #d0d0d0">;</span>
			<span style="color: #6ab825; font-weight: bold">if</span><span style="color: #d0d0d0">(craft()-&gt;</span><span style="color: #bbbbbb">request</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">getParam</span><span style="color: #d0d0d0">(</span><span style="color: #ed9d13">&#39;euwar&#39;</span><span style="color: #d0d0d0">)</span> <span style="color: #d0d0d0">==</span> <span style="color: #3677a9">1</span><span style="color: #d0d0d0">){</span><span style="color: #40ffff">$subject</span> <span style="color: #d0d0d0">=</span> <span style="color: #ed9d13">&quot;EMEA warranty promo&quot;</span><span style="color: #d0d0d0">;}</span>
			<span style="color: #40ffff">$type</span> <span style="color: #d0d0d0">=</span> <span style="color: #ed9d13">&#39;Question&#39;</span><span style="color: #d0d0d0">;</span>
		    <span style="color: #40ffff">$channel</span> <span style="color: #d0d0d0">=</span> <span style="color: #ed9d13">&quot;web&quot;</span><span style="color: #d0d0d0">;</span>
		    <span style="color: #40ffff">$name</span> <span style="color: #d0d0d0">=</span> <span style="color: #40ffff">$regdata</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">first</span> <span style="color: #d0d0d0">.</span> <span style="color: #ed9d13">&#39; &#39;</span> <span style="color: #d0d0d0">.</span> <span style="color: #40ffff">$regdata</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">last</span><span style="color: #d0d0d0">;</span>
		    <span style="color: #40ffff">$description</span> <span style="color: #d0d0d0">=</span> <span style="color: #ed9d13">&quot;Registration request submitted with the following information:&quot;</span><span style="color: #d0d0d0">;</span>
		    <span style="color: #40ffff">$description</span> <span style="color: #d0d0d0">.=</span> <span style="color: #ed9d13">&quot;\n    Name: $name&quot;</span><span style="color: #d0d0d0">;</span>
		    <span style="color: #40ffff">$description</span> <span style="color: #d0d0d0">.=</span> <span style="color: #ed9d13">&quot;\n    Organization: $regdata-&gt;org&quot;</span><span style="color: #d0d0d0">;</span>
		    <span style="color: #40ffff">$description</span> <span style="color: #d0d0d0">.=</span> <span style="color: #ed9d13">&quot;\n    Email: $regdata-&gt;email&quot;</span><span style="color: #d0d0d0">;</span>
		    <span style="color: #40ffff">$description</span> <span style="color: #d0d0d0">.=</span> <span style="color: #ed9d13">&quot;\n    Phone: $regdata-&gt;phone&quot;</span><span style="color: #d0d0d0">;</span>
		    <span style="color: #40ffff">$description</span> <span style="color: #d0d0d0">.=</span> <span style="color: #ed9d13">&quot;\n    Address: $regdata-&gt;address&quot;</span><span style="color: #d0d0d0">;</span>
		    <span style="color: #40ffff">$description</span> <span style="color: #d0d0d0">.=</span> <span style="color: #ed9d13">&quot;\n    City: $regdata-&gt;city&quot;</span><span style="color: #d0d0d0">;</span>
		    <span style="color: #40ffff">$description</span> <span style="color: #d0d0d0">.=</span> <span style="color: #ed9d13">&quot;\n    State: $regdata-&gt;state&quot;</span><span style="color: #d0d0d0">;</span>
		    <span style="color: #40ffff">$description</span> <span style="color: #d0d0d0">.=</span> <span style="color: #ed9d13">&quot;\n    Zip: $regdata-&gt;zip&quot;</span><span style="color: #d0d0d0">;</span>
		    <span style="color: #40ffff">$description</span> <span style="color: #d0d0d0">.=</span> <span style="color: #ed9d13">&quot;\n    Country: $regdata-&gt;country&quot;</span><span style="color: #d0d0d0">;</span>

			<span style="color: #6ab825; font-weight: bold">if</span><span style="color: #d0d0d0">(</span><span style="color: #40ffff">$regdata</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">ewCode</span><span style="color: #d0d0d0">)</span> <span style="color: #40ffff">$description</span><span style="color: #d0d0d0">.=</span> <span style="color: #ed9d13">&quot;\n    EW Code(s): &quot;</span> <span style="color: #d0d0d0">.</span> <span style="color: #24909d">implode</span><span style="color: #d0d0d0">(</span><span style="color: #ed9d13">&quot;, &quot;</span><span style="color: #d0d0d0">,</span><span style="color: #40ffff">$regdata</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">ewCode</span><span style="color: #d0d0d0">);</span>

			<span style="color: #999999; font-style: italic">//Check if user email exists in ZD system</span>
			<span style="color: #40ffff">$results</span> <span style="color: #d0d0d0">=</span> <span style="color: #40ffff">$this</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">curl</span><span style="color: #d0d0d0">(</span><span style="color: #ed9d13">&#39;/search.json?query=&#39;</span> <span style="color: #d0d0d0">.</span> <span style="color: #24909d">urlencode</span><span style="color: #d0d0d0">(</span><span style="color: #ed9d13">&quot;type:user email:$regdata-&gt;email&quot;</span><span style="color: #d0d0d0">));</span>
		    <span style="color: #6ab825; font-weight: bold">if</span><span style="color: #d0d0d0">(</span><span style="color: #24909d">is_object</span><span style="color: #d0d0d0">(</span><span style="color: #40ffff">$results</span><span style="color: #d0d0d0">))</span> <span style="color: #6ab825; font-weight: bold">if</span><span style="color: #d0d0d0">(</span><span style="color: #24909d">property_exists</span><span style="color: #d0d0d0">(</span><span style="color: #40ffff">$results</span><span style="color: #d0d0d0">,</span> <span style="color: #ed9d13">&quot;results&quot;</span><span style="color: #d0d0d0">))</span> <span style="color: #40ffff">$results</span> <span style="color: #d0d0d0">=</span> <span style="color: #40ffff">$results</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">results</span><span style="color: #d0d0d0">;</span>
		    <span style="color: #6ab825; font-weight: bold">if</span><span style="color: #d0d0d0">(!</span><span style="color: #6ab825; font-weight: bold">empty</span><span style="color: #d0d0d0">(</span><span style="color: #40ffff">$results</span><span style="color: #d0d0d0">[</span><span style="color: #3677a9">0</span><span style="color: #d0d0d0">]-&gt;</span><span style="color: #bbbbbb">id</span><span style="color: #d0d0d0">)){</span><span style="color: #40ffff">$uid</span> <span style="color: #d0d0d0">=</span> <span style="color: #40ffff">$results</span><span style="color: #d0d0d0">[</span><span style="color: #3677a9">0</span><span style="color: #d0d0d0">]-&gt;</span><span style="color: #bbbbbb">id</span><span style="color: #d0d0d0">;}</span>

			<span style="color: #40ffff">$replace</span> <span style="color: #d0d0d0">=</span> <span style="color: #6ab825; font-weight: bold">array</span><span style="color: #d0d0d0">(</span><span style="color: #ed9d13">&quot;-&quot;</span><span style="color: #d0d0d0">,</span><span style="color: #ed9d13">&quot;)&quot;</span><span style="color: #d0d0d0">,</span><span style="color: #ed9d13">&quot;(&quot;</span><span style="color: #d0d0d0">,</span><span style="color: #ed9d13">&quot;+&quot;</span><span style="color: #d0d0d0">);</span>
		    <span style="color: #40ffff">$regdata</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">phone</span> <span style="color: #d0d0d0">=</span> <span style="color: #24909d">str_replace</span><span style="color: #d0d0d0">(</span><span style="color: #40ffff">$replace</span><span style="color: #d0d0d0">,</span><span style="color: #ed9d13">&quot;&quot;</span><span style="color: #d0d0d0">,</span><span style="color: #40ffff">$regdata</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">phone</span><span style="color: #d0d0d0">);</span>

		    <span style="color: #6ab825; font-weight: bold">if</span><span style="color: #d0d0d0">(</span><span style="color: #6ab825; font-weight: bold">empty</span><span style="color: #d0d0d0">(</span><span style="color: #40ffff">$uid</span><span style="color: #d0d0d0">)){</span>
				<span style="color: #999999; font-style: italic">//If email address was not found check for exact user name match</span>
				<span style="color: #40ffff">$results</span> <span style="color: #d0d0d0">=</span> <span style="color: #40ffff">$this</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">curl</span><span style="color: #d0d0d0">(</span><span style="color: #ed9d13">&#39;/search.json?query=&#39;</span> <span style="color: #d0d0d0">.</span> <span style="color: #24909d">urlencode</span><span style="color: #d0d0d0">(</span><span style="color: #ed9d13">&quot;type:user name:$name&quot;</span><span style="color: #d0d0d0">));</span>
				<span style="color: #40ffff">$results</span> <span style="color: #d0d0d0">=</span> <span style="color: #40ffff">$results</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">results</span><span style="color: #d0d0d0">;</span>
				<span style="color: #999999; font-style: italic">//Verify if phone AND name matches</span>
				<span style="color: #6ab825; font-weight: bold">foreach</span><span style="color: #d0d0d0">(</span><span style="color: #40ffff">$results</span> <span style="color: #6ab825; font-weight: bold">as</span> <span style="color: #40ffff">$value</span><span style="color: #d0d0d0">){</span><span style="color: #6ab825; font-weight: bold">if</span><span style="color: #d0d0d0">(</span><span style="color: #ed9d13">&#39;+&#39;</span> <span style="color: #d0d0d0">.</span><span style="color: #40ffff">$regdata</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">phone</span> <span style="color: #d0d0d0">==</span>  <span style="color: #40ffff">$value</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">phone</span> <span style="color: #6ab825; font-weight: bold">OR</span> <span style="color: #ed9d13">&#39;+1&#39;</span> <span style="color: #d0d0d0">.</span><span style="color: #40ffff">$phone</span> <span style="color: #d0d0d0">==</span>  <span style="color: #40ffff">$value</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">phone</span><span style="color: #d0d0d0">)</span> <span style="color: #40ffff">$uid</span> <span style="color: #d0d0d0">=</span> <span style="color: #40ffff">$value</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">id</span><span style="color: #d0d0d0">;}</span>
				<span style="color: #d0d0d0">}</span>

			<span style="color: #999999; font-style: italic">//Create user if no user was found</span>
		    <span style="color: #6ab825; font-weight: bold">if</span><span style="color: #d0d0d0">(</span><span style="color: #6ab825; font-weight: bold">empty</span><span style="color: #d0d0d0">(</span><span style="color: #40ffff">$uid</span><span style="color: #d0d0d0">)){</span>
		    <span style="color: #40ffff">$create</span> <span style="color: #d0d0d0">=</span> <span style="color: #24909d">json_encode</span><span style="color: #d0d0d0">(</span><span style="color: #6ab825; font-weight: bold">array</span><span style="color: #d0d0d0">(</span><span style="color: #ed9d13">&#39;user&#39;</span> <span style="color: #d0d0d0">=&gt;</span> <span style="color: #6ab825; font-weight: bold">array</span><span style="color: #d0d0d0">(</span>
		    <span style="color: #ed9d13">&#39;name&#39;</span> <span style="color: #d0d0d0">=&gt;</span> <span style="color: #40ffff">$name</span><span style="color: #d0d0d0">,</span>
		    <span style="color: #ed9d13">&#39;email&#39;</span> <span style="color: #d0d0d0">=&gt;</span> <span style="color: #40ffff">$regdata</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">email</span><span style="color: #d0d0d0">,</span>
		    <span style="color: #ed9d13">&#39;phone&#39;</span> <span style="color: #d0d0d0">=&gt;</span> <span style="color: #40ffff">$regdata</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">phone</span><span style="color: #d0d0d0">,</span>
		    <span style="color: #ed9d13">&#39;user_fields&#39;</span> <span style="color: #d0d0d0">=&gt;</span> <span style="color: #6ab825; font-weight: bold">array</span><span style="color: #d0d0d0">(</span>
	    					<span style="color: #ed9d13">&quot;first_name&quot;</span><span style="color: #d0d0d0">=&gt;</span> <span style="color: #40ffff">$regdata</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">first</span><span style="color: #d0d0d0">,</span>
	    					<span style="color: #ed9d13">&quot;last_name&quot;</span><span style="color: #d0d0d0">=&gt;</span> <span style="color: #40ffff">$regdata</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">last</span><span style="color: #d0d0d0">,</span>
	    					<span style="color: #ed9d13">&quot;organization&quot;</span><span style="color: #d0d0d0">=&gt;</span> <span style="color: #40ffff">$regdata</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">org</span><span style="color: #d0d0d0">,</span>
	    					<span style="color: #ed9d13">&quot;shipping_address&quot;</span><span style="color: #d0d0d0">=&gt;</span> <span style="color: #40ffff">$regdata</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">address</span><span style="color: #d0d0d0">,</span>
	    					<span style="color: #ed9d13">&quot;city&quot;</span><span style="color: #d0d0d0">=&gt;</span> <span style="color: #40ffff">$regdata</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">city</span><span style="color: #d0d0d0">,</span>
	    					<span style="color: #ed9d13">&quot;state&quot;</span><span style="color: #d0d0d0">=&gt;</span> <span style="color: #40ffff">$regdata</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">state</span><span style="color: #d0d0d0">,</span>
	    					<span style="color: #ed9d13">&quot;country&quot;</span><span style="color: #d0d0d0">=&gt;</span> <span style="color: #40ffff">$regdata</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">country</span><span style="color: #d0d0d0">,</span>
	    					<span style="color: #ed9d13">&quot;zip_code&quot;</span><span style="color: #d0d0d0">=&gt;</span> <span style="color: #40ffff">$regdata</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">zip</span><span style="color: #d0d0d0">))));</span>
		    <span style="color: #40ffff">$return</span> <span style="color: #d0d0d0">=</span> <span style="color: #40ffff">$this</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">curl</span><span style="color: #d0d0d0">(</span><span style="color: #ed9d13">&quot;/users.json&quot;</span><span style="color: #d0d0d0">,</span> <span style="color: #40ffff">$create</span><span style="color: #d0d0d0">,</span><span style="color: #ed9d13">&#39;post&#39;</span><span style="color: #d0d0d0">);</span>
		    <span style="color: #40ffff">$decoded</span> <span style="color: #d0d0d0">=</span> <span style="color: #40ffff">$return</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">user</span><span style="color: #d0d0d0">;</span>
		    <span style="color: #40ffff">$uid</span> <span style="color: #d0d0d0">=</span> <span style="color: #40ffff">$decoded</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">id</span><span style="color: #d0d0d0">;</span>
		    <span style="color: #d0d0d0">}</span>

		    <span style="color: #40ffff">$ftoken</span> <span style="color: #d0d0d0">=</span> <span style="color: #ed9d13">&#39;&#39;</span><span style="color: #d0d0d0">;</span>
			<span style="color: #999999; font-style: italic">//Post files if exist and attach file token to ticket</span>
		    <span style="color: #6ab825; font-weight: bold">if</span><span style="color: #d0d0d0">(</span><span style="color: #40ffff">$file_tmp</span><span style="color: #d0d0d0">){</span>
			    <span style="color: #40ffff">$output</span> <span style="color: #d0d0d0">=</span> <span style="color: #40ffff">$this</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">curl</span><span style="color: #d0d0d0">(</span><span style="color: #ed9d13">&quot;/uploads.json?filename=&quot;</span> <span style="color: #d0d0d0">.</span> <span style="color: #24909d">urlencode</span><span style="color: #d0d0d0">(</span><span style="color: #40ffff">$file</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">getName</span><span style="color: #d0d0d0">()),</span><span style="color: #ed9d13">&#39;&#39;</span><span style="color: #d0d0d0">,</span><span style="color: #ed9d13">&#39;post&#39;</span><span style="color: #d0d0d0">,</span><span style="color: #40ffff">$file_tmp</span><span style="color: #d0d0d0">);</span>
			    <span style="color: #999999; font-style: italic">//$output = json_decode($output);</span>
			    <span style="color: #40ffff">$ftoken</span> <span style="color: #d0d0d0">=</span> <span style="color: #40ffff">$output</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">upload</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">token</span><span style="color: #d0d0d0">;</span>
		    <span style="color: #d0d0d0">}</span>

			<span style="color: #999999; font-style: italic">//If somehow a user still was not created (post error maybe?) assign a generic requestor</span>
		    <span style="color: #6ab825; font-weight: bold">if</span><span style="color: #d0d0d0">(</span><span style="color: #6ab825; font-weight: bold">empty</span><span style="color: #d0d0d0">(</span><span style="color: #40ffff">$uid</span><span style="color: #d0d0d0">))</span><span style="color: #40ffff">$uid</span><span style="color: #d0d0d0">=</span><span style="color: #6ab825; font-weight: bold">array</span><span style="color: #d0d0d0">(</span><span style="color: #ed9d13">&#39;name&#39;</span> <span style="color: #d0d0d0">=&gt;</span> <span style="color: #40ffff">$regdata</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">first</span> <span style="color: #d0d0d0">.</span> <span style="color: #ed9d13">&#39; &#39;</span> <span style="color: #d0d0d0">.</span> <span style="color: #40ffff">$regdata</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">last</span><span style="color: #d0d0d0">,</span> <span style="color: #ed9d13">&#39;email&#39;</span> <span style="color: #d0d0d0">=&gt;</span> <span style="color: #40ffff">$regdata</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">email</span><span style="color: #d0d0d0">);</span>

			<span style="color: #999999; font-style: italic">//Create ticket</span>
			<span style="color: #40ffff">$create</span> <span style="color: #d0d0d0">=</span> <span style="color: #6ab825; font-weight: bold">array</span><span style="color: #d0d0d0">(</span><span style="color: #ed9d13">&#39;ticket&#39;</span> <span style="color: #d0d0d0">=&gt;</span> <span style="color: #6ab825; font-weight: bold">array</span><span style="color: #d0d0d0">(</span>
		    <span style="color: #ed9d13">&#39;type&#39;</span> <span style="color: #d0d0d0">=&gt;</span> <span style="color: #40ffff">$type</span><span style="color: #d0d0d0">,</span>
		    <span style="color: #ed9d13">&#39;subject&#39;</span> <span style="color: #d0d0d0">=&gt;</span> <span style="color: #40ffff">$subject</span><span style="color: #d0d0d0">,</span>
		    <span style="color: #ed9d13">&#39;status&#39;</span> <span style="color: #d0d0d0">=&gt;</span> <span style="color: #ed9d13">&#39;new&#39;</span><span style="color: #d0d0d0">,</span>
		    <span style="color: #ed9d13">&#39;group_id&#39;</span> <span style="color: #d0d0d0">=&gt;</span> <span style="color: #40ffff">$group</span><span style="color: #d0d0d0">,</span>
		    <span style="color: #ed9d13">&#39;brand_id&#39;</span> <span style="color: #d0d0d0">=&gt;</span> <span style="color: #40ffff">$brand</span><span style="color: #d0d0d0">,</span>
		    <span style="color: #ed9d13">&#39;comment&#39;</span> <span style="color: #d0d0d0">=&gt;</span> <span style="color: #6ab825; font-weight: bold">array</span><span style="color: #d0d0d0">(</span> <span style="color: #ed9d13">&quot;value&quot;</span><span style="color: #d0d0d0">=&gt;</span> <span style="color: #40ffff">$description</span><span style="color: #d0d0d0">,</span>
			<span style="color: #ed9d13">&quot;uploads&quot;</span> <span style="color: #d0d0d0">=&gt;</span> <span style="color: #6ab825; font-weight: bold">array</span><span style="color: #d0d0d0">(</span><span style="color: #40ffff">$ftoken</span><span style="color: #d0d0d0">)),</span>
		    <span style="color: #ed9d13">&#39;tags&#39;</span> <span style="color: #d0d0d0">=&gt;</span> <span style="color: #ed9d13">&quot;regreview&quot;</span><span style="color: #d0d0d0">,</span>
		    <span style="color: #ed9d13">&#39;requester_id&#39;</span> <span style="color: #d0d0d0">=&gt;</span> <span style="color: #40ffff">$uid</span><span style="color: #d0d0d0">,</span>
		    <span style="color: #ed9d13">&#39;via&#39;</span> <span style="color: #d0d0d0">=&gt;</span>  <span style="color: #6ab825; font-weight: bold">array</span><span style="color: #d0d0d0">(</span><span style="color: #ed9d13">&quot;channel&quot;</span><span style="color: #d0d0d0">=&gt;</span> <span style="color: #40ffff">$channel</span><span style="color: #d0d0d0">),</span>
		    <span style="color: #ed9d13">&#39;custom_fields&#39;</span> <span style="color: #d0d0d0">=&gt;</span> 	<span style="color: #6ab825; font-weight: bold">array</span><span style="color: #d0d0d0">(</span> <span style="color: #6ab825; font-weight: bold">array</span><span style="color: #d0d0d0">(</span><span style="color: #ed9d13">&quot;id&quot;</span><span style="color: #d0d0d0">=&gt;</span> <span style="color: #3677a9">23473115</span><span style="color: #d0d0d0">,</span> <span style="color: #ed9d13">&quot;value&quot;</span><span style="color: #d0d0d0">=&gt;</span> <span style="color: #40ffff">$regdata</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">org</span><span style="color: #d0d0d0">),</span>
		    					<span style="color: #6ab825; font-weight: bold">array</span><span style="color: #d0d0d0">(</span><span style="color: #ed9d13">&quot;id&quot;</span><span style="color: #d0d0d0">=&gt;</span> <span style="color: #3677a9">23278985</span><span style="color: #d0d0d0">,</span> <span style="color: #ed9d13">&quot;value&quot;</span><span style="color: #d0d0d0">=&gt;</span> <span style="color: #40ffff">$regdata</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">serial</span><span style="color: #d0d0d0">),</span>
		    					<span style="color: #6ab825; font-weight: bold">array</span><span style="color: #d0d0d0">(</span><span style="color: #ed9d13">&quot;id&quot;</span><span style="color: #d0d0d0">=&gt;</span> <span style="color: #3677a9">23415649</span><span style="color: #d0d0d0">,</span> <span style="color: #ed9d13">&quot;value&quot;</span><span style="color: #d0d0d0">=&gt;</span> <span style="color: #40ffff">$regdata</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">product</span><span style="color: #d0d0d0">),</span> <span style="color: #d0d0d0">)));</span>
		    <span style="color: #40ffff">$create</span> <span style="color: #d0d0d0">=</span> <span style="color: #24909d">json_encode</span><span style="color: #d0d0d0">(</span><span style="color: #40ffff">$create</span><span style="color: #d0d0d0">);</span>


		    <span style="color: #40ffff">$return</span> <span style="color: #d0d0d0">=</span> <span style="color: #40ffff">$this</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">curl</span><span style="color: #d0d0d0">(</span><span style="color: #ed9d13">&quot;/tickets.json&quot;</span><span style="color: #d0d0d0">,</span> <span style="color: #40ffff">$create</span><span style="color: #d0d0d0">,</span><span style="color: #ed9d13">&#39;post&#39;</span><span style="color: #d0d0d0">);</span>

		<span style="color: #40ffff">$regContract</span> <span style="color: #d0d0d0">=</span> <span style="color: #40ffff">$this</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">register</span><span style="color: #d0d0d0">(</span><span style="color: #40ffff">$regdata</span><span style="color: #d0d0d0">,</span><span style="color: #ed9d13">&#39;t&#39;</span><span style="color: #d0d0d0">);</span>

		<span style="color: #d0d0d0">}</span>
		<span style="color: #6ab825; font-weight: bold">else</span><span style="color: #d0d0d0">{</span>

		<span style="color: #40ffff">$regContract</span> <span style="color: #d0d0d0">=</span> <span style="color: #40ffff">$this</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">register</span><span style="color: #d0d0d0">(</span><span style="color: #40ffff">$regdata</span><span style="color: #d0d0d0">);</span>
		<span style="color: #d0d0d0">}</span>

		<span style="color: #6ab825; font-weight: bold">if</span><span style="color: #d0d0d0">(</span><span style="color: #40ffff">$companySwitch</span><span style="color: #d0d0d0">)</span> <span style="color: #40ffff">$this</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">returnJson</span><span style="color: #d0d0d0">(</span><span style="color: #ed9d13">&#39;redirect&#39;</span><span style="color: #d0d0d0">);</span>
			<span style="color: #6ab825; font-weight: bold">elseif</span> <span style="color: #d0d0d0">(</span><span style="color: #40ffff">$regContract</span><span style="color: #d0d0d0">)</span> <span style="color: #d0d0d0">{</span>
				<span style="color: #40ffff">$this</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">returnJson</span><span style="color: #d0d0d0">(</span><span style="color: #ed9d13">&#39;reggift&#39;</span><span style="color: #d0d0d0">);</span>
			<span style="color: #d0d0d0">}</span>
			<span style="color: #6ab825; font-weight: bold">else</span> <span style="color: #40ffff">$this</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">returnJson</span><span style="color: #d0d0d0">(</span><span style="color: #ed9d13">&#39;success&#39;</span><span style="color: #d0d0d0">);</span>
    <span style="color: #d0d0d0">}</span>

   <span style="color: #6ab825; font-weight: bold">public</span> <span style="color: #6ab825; font-weight: bold">function</span> <span style="color: #447fcf">actionInternalRegister</span><span style="color: #d0d0d0">()</span>
    <span style="color: #d0d0d0">{</span>

		<span style="color: #40ffff">$this</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">requireLogin</span><span style="color: #d0d0d0">();</span>
    	<span style="color: #40ffff">$regdata</span> <span style="color: #d0d0d0">=</span> <span style="color: #6ab825; font-weight: bold">new</span> <span style="color: #d0d0d0">\stdClass();</span>
		<span style="color: #40ffff">$formData</span> <span style="color: #d0d0d0">=</span> <span style="color: #d0d0d0">craft()-&gt;</span><span style="color: #bbbbbb">request</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">getPost</span><span style="color: #d0d0d0">(</span><span style="color: #ed9d13">&#39;formData&#39;</span><span style="color: #d0d0d0">);</span>
		<span style="color: #40ffff">$serialData</span> <span style="color: #d0d0d0">=</span> <span style="color: #d0d0d0">craft()-&gt;</span><span style="color: #bbbbbb">request</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">getPost</span><span style="color: #d0d0d0">(</span><span style="color: #ed9d13">&#39;data&#39;</span><span style="color: #d0d0d0">);</span>
		<span style="color: #40ffff">$regdata</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">first</span> <span style="color: #d0d0d0">=</span> <span style="color: #40ffff">$this</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">mysqli</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">real_escape_string</span><span style="color: #d0d0d0">(</span><span style="color: #40ffff">$formData</span><span style="color: #d0d0d0">[</span><span style="color: #ed9d13">&#39;first_name&#39;</span><span style="color: #d0d0d0">]);</span>
		<span style="color: #40ffff">$regdata</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">last</span> <span style="color: #d0d0d0">=</span> <span style="color: #40ffff">$this</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">mysqli</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">real_escape_string</span><span style="color: #d0d0d0">(</span><span style="color: #40ffff">$formData</span><span style="color: #d0d0d0">[</span><span style="color: #ed9d13">&#39;last_name&#39;</span><span style="color: #d0d0d0">]);</span>
		<span style="color: #40ffff">$regdata</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">org</span> <span style="color: #d0d0d0">=</span> <span style="color: #40ffff">$this</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">mysqli</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">real_escape_string</span><span style="color: #d0d0d0">(</span><span style="color: #40ffff">$formData</span><span style="color: #d0d0d0">[</span><span style="color: #ed9d13">&#39;org&#39;</span><span style="color: #d0d0d0">]);</span>
		<span style="color: #40ffff">$regdata</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">email</span> <span style="color: #d0d0d0">=</span> <span style="color: #40ffff">$this</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">mysqli</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">real_escape_string</span><span style="color: #d0d0d0">(</span><span style="color: #40ffff">$formData</span><span style="color: #d0d0d0">[</span><span style="color: #ed9d13">&#39;email&#39;</span><span style="color: #d0d0d0">]);</span>
		<span style="color: #40ffff">$regdata</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">reg_country</span> <span style="color: #d0d0d0">=</span> <span style="color: #40ffff">$this</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">mysqli</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">real_escape_string</span><span style="color: #d0d0d0">(</span><span style="color: #40ffff">$formData</span><span style="color: #d0d0d0">[</span><span style="color: #ed9d13">&#39;country&#39;</span><span style="color: #d0d0d0">]);</span>
		<span style="color: #40ffff">$regdata</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">country</span> <span style="color: #d0d0d0">=</span> <span style="color: #40ffff">$this</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">mysqli</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">real_escape_string</span><span style="color: #d0d0d0">(</span><span style="color: #40ffff">$formData</span><span style="color: #d0d0d0">[</span><span style="color: #ed9d13">&#39;country&#39;</span><span style="color: #d0d0d0">]);</span>
		<span style="color: #40ffff">$regdata</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">phone</span> <span style="color: #d0d0d0">=</span> <span style="color: #40ffff">$this</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">mysqli</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">real_escape_string</span><span style="color: #d0d0d0">(</span><span style="color: #40ffff">$formData</span><span style="color: #d0d0d0">[</span><span style="color: #ed9d13">&#39;phone&#39;</span><span style="color: #d0d0d0">]);</span>
		<span style="color: #40ffff">$regdata</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">address</span> <span style="color: #d0d0d0">=</span> <span style="color: #40ffff">$this</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">mysqli</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">real_escape_string</span><span style="color: #d0d0d0">(</span><span style="color: #40ffff">$formData</span><span style="color: #d0d0d0">[</span><span style="color: #ed9d13">&#39;address&#39;</span><span style="color: #d0d0d0">]);</span>
		<span style="color: #40ffff">$regdata</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">city</span> <span style="color: #d0d0d0">=</span> <span style="color: #40ffff">$this</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">mysqli</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">real_escape_string</span><span style="color: #d0d0d0">(</span><span style="color: #40ffff">$formData</span><span style="color: #d0d0d0">[</span><span style="color: #ed9d13">&#39;city&#39;</span><span style="color: #d0d0d0">]);</span>
		<span style="color: #40ffff">$regdata</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">state</span> <span style="color: #d0d0d0">=</span> <span style="color: #40ffff">$this</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">mysqli</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">real_escape_string</span><span style="color: #d0d0d0">(</span><span style="color: #40ffff">$formData</span><span style="color: #d0d0d0">[</span><span style="color: #ed9d13">&#39;state&#39;</span><span style="color: #d0d0d0">]);</span>
		<span style="color: #40ffff">$regdata</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">zip</span> <span style="color: #d0d0d0">=</span> <span style="color: #40ffff">$this</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">mysqli</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">real_escape_string</span><span style="color: #d0d0d0">(</span><span style="color: #40ffff">$formData</span><span style="color: #d0d0d0">[</span><span style="color: #ed9d13">&#39;zip&#39;</span><span style="color: #d0d0d0">]);</span>
		<span style="color: #40ffff">$regdata</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">second_name</span> <span style="color: #d0d0d0">=</span> <span style="color: #40ffff">$this</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">mysqli</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">real_escape_string</span><span style="color: #d0d0d0">(</span><span style="color: #40ffff">$formData</span><span style="color: #d0d0d0">[</span><span style="color: #ed9d13">&#39;secondary_name&#39;</span><span style="color: #d0d0d0">]);</span>
		<span style="color: #40ffff">$regdata</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">second_email</span> <span style="color: #d0d0d0">=</span> <span style="color: #40ffff">$this</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">mysqli</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">real_escape_string</span><span style="color: #d0d0d0">(</span><span style="color: #40ffff">$formData</span><span style="color: #d0d0d0">[</span><span style="color: #ed9d13">&#39;secondary_email&#39;</span><span style="color: #d0d0d0">]);</span>

		<span style="color: #6ab825; font-weight: bold">foreach</span> <span style="color: #d0d0d0">(</span><span style="color: #40ffff">$serialData</span> <span style="color: #6ab825; font-weight: bold">as</span> <span style="color: #40ffff">$serialArray</span><span style="color: #d0d0d0">)</span> 
		<span style="color: #d0d0d0">{</span>
			<span style="color: #40ffff">$regdata</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">serial</span> <span style="color: #d0d0d0">=</span> <span style="color: #40ffff">$serialArray</span><span style="color: #d0d0d0">[</span><span style="color: #3677a9">0</span><span style="color: #d0d0d0">];</span>
			<span style="color: #40ffff">$regdata</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">from</span> <span style="color: #d0d0d0">=</span> <span style="color: #40ffff">$serialArray</span><span style="color: #d0d0d0">[</span><span style="color: #3677a9">1</span><span style="color: #d0d0d0">];</span>
			<span style="color: #40ffff">$regdata</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">to</span> <span style="color: #d0d0d0">=</span> <span style="color: #40ffff">$serialArray</span><span style="color: #d0d0d0">[</span><span style="color: #3677a9">2</span><span style="color: #d0d0d0">];</span>
			<span style="color: #40ffff">$regdata</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">ewCode</span> <span style="color: #d0d0d0">=</span> <span style="color: #24909d">explode</span><span style="color: #d0d0d0">(</span><span style="color: #ed9d13">&quot;,&quot;</span><span style="color: #d0d0d0">,</span><span style="color: #40ffff">$serialArray</span><span style="color: #d0d0d0">[</span><span style="color: #3677a9">3</span><span style="color: #d0d0d0">]);</span>

			<span style="color: #40ffff">$result</span> <span style="color: #d0d0d0">=</span> <span style="color: #40ffff">$this</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">mysqli</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">query</span><span style="color: #d0d0d0">(</span><span style="color: #ed9d13">&quot;SELECT * FROM install_base WHERE serial_number = &#39;$regdata-&gt;serial&#39;&quot;</span><span style="color: #d0d0d0">);</span>
			<span style="color: #999999; font-style: italic">//Pull prefix and associated company/group/form</span>
			<span style="color: #40ffff">$prefix_result</span> <span style="color: #d0d0d0">=</span> <span style="color: #40ffff">$this</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">mysqli</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">query</span><span style="color: #d0d0d0">(</span><span style="color: #ed9d13">&#39;SELECT * FROM sn_prefix WHERE prefix = &quot;&#39;</span> <span style="color: #d0d0d0">.</span> <span style="color: #d0d0d0">substr(</span><span style="color: #40ffff">$regdata</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">serial</span><span style="color: #d0d0d0">,</span><span style="color: #3677a9">0</span><span style="color: #d0d0d0">,</span><span style="color: #3677a9">3</span><span style="color: #d0d0d0">)</span> <span style="color: #d0d0d0">.</span> <span style="color: #ed9d13">&#39;&quot;&#39;</span> <span style="color: #d0d0d0">);</span>

			<span style="color: #6ab825; font-weight: bold">while</span><span style="color: #d0d0d0">(</span><span style="color: #40ffff">$row</span> <span style="color: #d0d0d0">=</span> <span style="color: #40ffff">$prefix_result</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">fetch_assoc</span> <span style="color: #d0d0d0">())</span><span style="color: #40ffff">$regdata</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">product</span> <span style="color: #d0d0d0">=</span> <span style="color: #40ffff">$row</span><span style="color: #d0d0d0">[</span><span style="color: #ed9d13">&#39;part_number&#39;</span><span style="color: #d0d0d0">];</span>

			<span style="color: #999999; font-style: italic">//Check for existing record and pull available purchase data.</span>
		    <span style="color: #6ab825; font-weight: bold">if</span><span style="color: #d0d0d0">(</span><span style="color: #40ffff">$result</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">num_rows</span><span style="color: #d0d0d0">&gt;</span><span style="color: #3677a9">0</span><span style="color: #d0d0d0">)</span> <span style="color: #6ab825; font-weight: bold">while</span><span style="color: #d0d0d0">(</span><span style="color: #40ffff">$row</span> <span style="color: #d0d0d0">=</span> <span style="color: #40ffff">$result</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">fetch_assoc</span> <span style="color: #d0d0d0">())</span> <span style="color: #40ffff">$regdata</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">country</span> <span style="color: #d0d0d0">=</span> <span style="color: #40ffff">$row</span><span style="color: #d0d0d0">[</span><span style="color: #ed9d13">&#39;country&#39;</span><span style="color: #d0d0d0">];</span>

			<span style="color: #40ffff">$this</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">register</span><span style="color: #d0d0d0">(</span><span style="color: #40ffff">$regdata</span><span style="color: #d0d0d0">,</span><span style="color: #ed9d13">&#39;i&#39;</span><span style="color: #d0d0d0">);</span>

		<span style="color: #d0d0d0">}</span>		
		<span style="color: #40ffff">$this</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">returnJson</span><span style="color: #d0d0d0">(</span><span style="color: #ed9d13">&#39;Registered&#39;</span><span style="color: #d0d0d0">);</span>
    <span style="color: #d0d0d0">}</span>

   <span style="color: #6ab825; font-weight: bold">public</span> <span style="color: #6ab825; font-weight: bold">function</span> <span style="color: #447fcf">actionGetPendingRegistrations</span><span style="color: #d0d0d0">()</span>
    <span style="color: #d0d0d0">{</span>

		<span style="color: #40ffff">$sql</span> <span style="color: #d0d0d0">=</span> <span style="color: #ed9d13">&quot;SELECT `serial_number`, IF(`ib_pending`.`part_number` IS NULL, `sn_prefix`.`part_number`, `ib_pending`.`part_number`) AS `part_number`, `INVENTDIMID`, `MASTERID`, `from_date`, `to_date`, `sales_id`, `first_name`, `last_name`, `org`, `phone`, `email`, `secondary_email`, `warranty_keys`, country FROM `ib_pending` LEFT JOIN sn_prefix ON LEFT(serial_number,3) = prefix WHERE `processed` IS NULL AND email IS NOT NULL GROUP BY `serial_number`&quot;</span><span style="color: #d0d0d0">;</span>
		<span style="color: #40ffff">$result</span> <span style="color: #d0d0d0">=</span> <span style="color: #40ffff">$this</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">mysqli</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">query</span><span style="color: #d0d0d0">(</span><span style="color: #40ffff">$sql</span><span style="color: #d0d0d0">);</span>
		<span style="color: #6ab825; font-weight: bold">if</span><span style="color: #d0d0d0">(</span><span style="color: #40ffff">$result</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">num_rows</span> <span style="color: #d0d0d0">==</span> <span style="color: #3677a9">0</span><span style="color: #d0d0d0">)</span> <span style="color: #40ffff">$this</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">returnJson</span><span style="color: #d0d0d0">(</span><span style="color: #ed9d13">&quot;No records&quot;</span><span style="color: #d0d0d0">);</span>
		<span style="color: #6ab825; font-weight: bold">for</span> <span style="color: #d0d0d0">(</span><span style="color: #40ffff">$i</span><span style="color: #d0d0d0">=</span><span style="color: #3677a9">0</span><span style="color: #d0d0d0">;</span> <span style="color: #40ffff">$i</span> <span style="color: #d0d0d0">&lt;</span> <span style="color: #40ffff">$result</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">field_count</span><span style="color: #d0d0d0">;</span> <span style="color: #40ffff">$i</span><span style="color: #d0d0d0">++)</span> <span style="color: #d0d0d0">{</span> 
		    <span style="color: #40ffff">$fieldNames</span><span style="color: #d0d0d0">[</span><span style="color: #40ffff">$i</span><span style="color: #d0d0d0">]</span> <span style="color: #d0d0d0">=</span> <span style="color: #40ffff">$result</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">fetch_field_direct</span><span style="color: #d0d0d0">(</span><span style="color: #40ffff">$i</span><span style="color: #d0d0d0">)-&gt;</span><span style="color: #bbbbbb">name</span><span style="color: #d0d0d0">;</span>
		    <span style="color: #40ffff">$colNames</span><span style="color: #d0d0d0">[</span><span style="color: #40ffff">$i</span><span style="color: #d0d0d0">]</span> <span style="color: #d0d0d0">=</span> <span style="color: #d0d0d0">ucfirst(</span><span style="color: #24909d">str_replace</span><span style="color: #d0d0d0">(</span><span style="color: #ed9d13">&quot;_&quot;</span><span style="color: #d0d0d0">,</span><span style="color: #ed9d13">&quot; &quot;</span><span style="color: #d0d0d0">,</span><span style="color: #40ffff">$result</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">fetch_field_direct</span><span style="color: #d0d0d0">(</span><span style="color: #40ffff">$i</span><span style="color: #d0d0d0">)-&gt;</span><span style="color: #bbbbbb">name</span><span style="color: #d0d0d0">));</span>
		<span style="color: #d0d0d0">}</span>

		<span style="color: #6ab825; font-weight: bold">while</span><span style="color: #d0d0d0">(</span><span style="color: #40ffff">$row</span> <span style="color: #d0d0d0">=</span> <span style="color: #40ffff">$result</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">fetch_assoc</span><span style="color: #d0d0d0">())</span> <span style="color: #40ffff">$rows</span><span style="color: #d0d0d0">[]</span> <span style="color: #d0d0d0">=</span> <span style="color: #24909d">array_map</span><span style="color: #d0d0d0">(</span><span style="color: #ed9d13">&#39;utf8_encode&#39;</span><span style="color: #d0d0d0">,</span><span style="color: #40ffff">$row</span><span style="color: #d0d0d0">);</span>
		<span style="color: #40ffff">$this</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">returnJson</span><span style="color: #d0d0d0">(</span><span style="color: #6ab825; font-weight: bold">array</span><span style="color: #d0d0d0">(</span><span style="color: #ed9d13">&quot;fields&quot;</span><span style="color: #d0d0d0">=&gt;</span><span style="color: #40ffff">$fieldNames</span><span style="color: #d0d0d0">,</span><span style="color: #ed9d13">&quot;columns&quot;</span><span style="color: #d0d0d0">=&gt;</span><span style="color: #40ffff">$colNames</span><span style="color: #d0d0d0">,</span><span style="color: #ed9d13">&quot;rows&quot;</span><span style="color: #d0d0d0">=&gt;</span><span style="color: #40ffff">$rows</span><span style="color: #d0d0d0">));</span>
    <span style="color: #d0d0d0">}</span>

   <span style="color: #6ab825; font-weight: bold">public</span> <span style="color: #6ab825; font-weight: bold">function</span> <span style="color: #447fcf">actionRejectRegistrations</span><span style="color: #d0d0d0">()</span>
   <span style="color: #d0d0d0">{</span>
		<span style="color: #40ffff">$serial_number</span> <span style="color: #d0d0d0">=</span> <span style="color: #d0d0d0">craft()-&gt;</span><span style="color: #bbbbbb">request</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">getPost</span><span style="color: #d0d0d0">(</span><span style="color: #ed9d13">&#39;serial_number&#39;</span><span style="color: #d0d0d0">);</span>
		<span style="color: #40ffff">$serial_number</span> <span style="color: #d0d0d0">=</span> <span style="color: #24909d">implode</span><span style="color: #d0d0d0">(</span><span style="color: #ed9d13">&quot;&#39;,&#39;&quot;</span><span style="color: #d0d0d0">,</span> <span style="color: #40ffff">$serial_number</span><span style="color: #d0d0d0">);</span>
		<span style="color: #40ffff">$sql</span> <span style="color: #d0d0d0">=</span> <span style="color: #ed9d13">&quot;UPDATE `ib_pending` SET `status` =&#39;Rejected&#39;, `processed` = 1  WHERE  `serial_number` IN(&#39;$serial_number&#39;) &quot;</span><span style="color: #d0d0d0">;</span>
		<span style="color: #40ffff">$result</span> <span style="color: #d0d0d0">=</span> <span style="color: #40ffff">$this</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">mysqli</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">query</span><span style="color: #d0d0d0">(</span><span style="color: #40ffff">$sql</span><span style="color: #d0d0d0">);</span>
		<span style="color: #40ffff">$this</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">returnJson</span><span style="color: #d0d0d0">(</span><span style="color: #ed9d13">&#39;success&#39;</span><span style="color: #d0d0d0">);</span>
   <span style="color: #d0d0d0">}</span>

   <span style="color: #6ab825; font-weight: bold">public</span> <span style="color: #6ab825; font-weight: bold">function</span> <span style="color: #447fcf">actionApproveRegistrations</span><span style="color: #d0d0d0">()</span>
   <span style="color: #d0d0d0">{</span>
		<span style="color: #40ffff">$data</span> <span style="color: #d0d0d0">=</span> <span style="color: #d0d0d0">craft()-&gt;</span><span style="color: #bbbbbb">request</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">getPost</span><span style="color: #d0d0d0">(</span><span style="color: #ed9d13">&#39;data&#39;</span><span style="color: #d0d0d0">);</span>
		<span style="color: #40ffff">$fields</span> <span style="color: #d0d0d0">=</span> <span style="color: #d0d0d0">craft()-&gt;</span><span style="color: #bbbbbb">request</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">getPost</span><span style="color: #d0d0d0">(</span><span style="color: #ed9d13">&#39;fields&#39;</span><span style="color: #d0d0d0">);</span>
		<span style="color: #6ab825; font-weight: bold">foreach</span><span style="color: #d0d0d0">(</span><span style="color: #40ffff">$data</span> <span style="color: #6ab825; font-weight: bold">as</span> <span style="color: #40ffff">$row</span><span style="color: #d0d0d0">){</span>
			<span style="color: #40ffff">$sql</span> <span style="color: #d0d0d0">=</span> <span style="color: #ed9d13">&quot;UPDATE ib_pending SET &quot;</span><span style="color: #d0d0d0">;</span>

    	<span style="color: #40ffff">$regdata</span> <span style="color: #d0d0d0">=</span> <span style="color: #6ab825; font-weight: bold">new</span> <span style="color: #d0d0d0">\stdClass();</span>
		<span style="color: #40ffff">$regdata</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">serial</span> <span style="color: #d0d0d0">=</span> <span style="color: #40ffff">$row</span><span style="color: #d0d0d0">[</span><span style="color: #24909d">array_search</span><span style="color: #d0d0d0">(</span><span style="color: #ed9d13">&#39;serial_number&#39;</span><span style="color: #d0d0d0">,</span><span style="color: #40ffff">$fields</span><span style="color: #d0d0d0">)];</span>
		<span style="color: #40ffff">$regdata</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">email</span> <span style="color: #d0d0d0">=</span> <span style="color: #40ffff">$row</span><span style="color: #d0d0d0">[</span><span style="color: #24909d">array_search</span><span style="color: #d0d0d0">(</span><span style="color: #ed9d13">&#39;email&#39;</span><span style="color: #d0d0d0">,</span><span style="color: #40ffff">$fields</span><span style="color: #d0d0d0">)];</span>
		<span style="color: #40ffff">$regdata</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">country</span> <span style="color: #d0d0d0">=</span> <span style="color: #40ffff">$row</span><span style="color: #d0d0d0">[</span><span style="color: #24909d">array_search</span><span style="color: #d0d0d0">(</span><span style="color: #ed9d13">&#39;country&#39;</span><span style="color: #d0d0d0">,</span><span style="color: #40ffff">$fields</span><span style="color: #d0d0d0">)];</span>
		<span style="color: #40ffff">$regdata</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">product</span> <span style="color: #d0d0d0">=</span> <span style="color: #40ffff">$row</span><span style="color: #d0d0d0">[</span><span style="color: #24909d">array_search</span><span style="color: #d0d0d0">(</span><span style="color: #ed9d13">&#39;part_number&#39;</span><span style="color: #d0d0d0">,</span><span style="color: #40ffff">$fields</span><span style="color: #d0d0d0">)];</span>
		<span style="color: #40ffff">$regdata</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">second_email</span> <span style="color: #d0d0d0">=</span> <span style="color: #40ffff">$row</span><span style="color: #d0d0d0">[</span><span style="color: #24909d">array_search</span><span style="color: #d0d0d0">(</span><span style="color: #ed9d13">&#39;secondary_email&#39;</span><span style="color: #d0d0d0">,</span><span style="color: #40ffff">$fields</span><span style="color: #d0d0d0">)];</span>

			<span style="color: #40ffff">$sql</span> <span style="color: #d0d0d0">.=</span> <span style="color: #ed9d13">&quot;`status` = &#39;Approved&#39;, `processed` = &#39;1&#39;&quot;</span><span style="color: #d0d0d0">;</span> 
			<span style="color: #40ffff">$sql</span> <span style="color: #d0d0d0">.=</span> <span style="color: #ed9d13">&quot; WHERE `serial_number` = &#39;$regdata-&gt;serial&#39;&quot;</span><span style="color: #d0d0d0">;</span>
			<span style="color: #40ffff">$result</span> <span style="color: #d0d0d0">=</span> <span style="color: #40ffff">$this</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">mysqli</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">query</span><span style="color: #d0d0d0">(</span><span style="color: #40ffff">$sql</span><span style="color: #d0d0d0">);</span>

			<span style="color: #999999; font-style: italic">// ************ Registration Contract **************</span>
			<span style="color: #40ffff">$this</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">registrationContract</span><span style="color: #d0d0d0">(</span><span style="color: #40ffff">$regdata</span><span style="color: #d0d0d0">);</span>
			<span style="color: #40ffff">$warranty_keys</span> <span style="color: #d0d0d0">=</span> <span style="color: #40ffff">$row</span><span style="color: #d0d0d0">[</span><span style="color: #24909d">array_search</span><span style="color: #d0d0d0">(</span><span style="color: #ed9d13">&#39;warranty_keys&#39;</span><span style="color: #d0d0d0">,</span><span style="color: #40ffff">$fields</span><span style="color: #d0d0d0">)];</span>
			<span style="color: #6ab825; font-weight: bold">if</span><span style="color: #d0d0d0">(</span><span style="color: #40ffff">$warranty_keys</span><span style="color: #d0d0d0">){</span>
			<span style="color: #40ffff">$this</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">registerContracts</span><span style="color: #d0d0d0">(</span><span style="color: #24909d">explode</span><span style="color: #d0d0d0">(</span><span style="color: #ed9d13">&quot;,&quot;</span><span style="color: #d0d0d0">,</span><span style="color: #40ffff">$warranty_keys</span><span style="color: #d0d0d0">),</span><span style="color: #40ffff">$regdata</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">serial</span><span style="color: #d0d0d0">,</span><span style="color: #40ffff">$regdata</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">email</span><span style="color: #d0d0d0">);</span>
			<span style="color: #d0d0d0">}</span>
		<span style="color: #d0d0d0">}</span>
		<span style="color: #40ffff">$user</span> <span style="color: #d0d0d0">=</span> <span style="color: #d0d0d0">craft()-&gt;</span><span style="color: #bbbbbb">userSession</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">getUser</span><span style="color: #d0d0d0">();</span>  
		<span style="color: #40ffff">$source</span> <span style="color: #d0d0d0">=</span> <span style="color: #ed9d13">&quot;Approved Customer Registration - {</span><span style="color: #40ffff">$user</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">username</span><span style="color: #ed9d13">}&quot;</span><span style="color: #d0d0d0">;</span>

		<span style="color: #40ffff">$sql</span> <span style="color: #d0d0d0">=</span> <span style="color: #ed9d13">&quot;REPLACE INTO `install_base` SELECT `serial_number`,`part_number`,`INVENTDIMID`,`MASTERID`,`from_date`,DATE_ADD(`from_date`, INTERVAL `install_base`.`warranty_function`(part_number,country,&#39;Standard&#39;,serial_number,&#39;000&#39;) MONTH),`sales_id`,`name`,`country`,&#39;Registered&#39;,`modified`,`first_name`,`last_name`,`org`,`phone`,`email`,`address`,`city`,`state`,`zip`,`reg_country`,`secondary_name`,`secondary_email`,&#39;TRUE&#39;,`optin`,&#39;$source&#39; FROM `ib_pending` WHERE `status` = &#39;Approved&#39; AND `processed` = &#39;1&#39;&quot;</span><span style="color: #d0d0d0">;</span>
		<span style="color: #40ffff">$result</span> <span style="color: #d0d0d0">=</span> <span style="color: #40ffff">$this</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">mysqli</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">query</span><span style="color: #d0d0d0">(</span><span style="color: #40ffff">$sql</span><span style="color: #d0d0d0">);</span>
		<span style="color: #40ffff">$sql</span> <span style="color: #d0d0d0">=</span> <span style="color: #ed9d13">&#39;UPDATE `ib_pending` SET `processed` = &quot;2&quot; WHERE `status` = &quot;Approved&quot; AND `processed` = &quot;1&quot;&#39;</span><span style="color: #d0d0d0">;</span>
		<span style="color: #40ffff">$result</span> <span style="color: #d0d0d0">=</span> <span style="color: #40ffff">$this</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">mysqli</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">query</span><span style="color: #d0d0d0">(</span><span style="color: #40ffff">$sql</span><span style="color: #d0d0d0">);</span>
		<span style="color: #40ffff">$this</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">returnJson</span><span style="color: #d0d0d0">(</span><span style="color: #ed9d13">&quot;success&quot;</span><span style="color: #d0d0d0">);</span>
   <span style="color: #d0d0d0">}</span>


	<span style="color: #6ab825; font-weight: bold">private</span> <span style="color: #6ab825; font-weight: bold">function</span> <span style="color: #447fcf">register</span><span style="color: #d0d0d0">(</span><span style="color: #40ffff">$data</span><span style="color: #d0d0d0">,</span><span style="color: #40ffff">$type</span> <span style="color: #d0d0d0">=</span> <span style="color: #6ab825; font-weight: bold">NULL</span><span style="color: #d0d0d0">)</span>
	<span style="color: #d0d0d0">{</span>
		<span style="color: #40ffff">$source</span> <span style="color: #d0d0d0">=</span> <span style="color: #ed9d13">&quot;Automated Registration&quot;</span><span style="color: #d0d0d0">;</span>
		<span style="color: #6ab825; font-weight: bold">if</span><span style="color: #d0d0d0">(!</span><span style="color: #24909d">property_exists</span><span style="color: #d0d0d0">(</span><span style="color: #40ffff">$data</span><span style="color: #d0d0d0">,</span> <span style="color: #ed9d13">&quot;from&quot;</span><span style="color: #d0d0d0">))</span> <span style="color: #40ffff">$data</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">from</span> <span style="color: #d0d0d0">=</span> <span style="color: #ed9d13">&#39;&#39;</span><span style="color: #d0d0d0">;</span>
		<span style="color: #6ab825; font-weight: bold">if</span><span style="color: #d0d0d0">(</span><span style="color: #40ffff">$data</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">from</span><span style="color: #d0d0d0">==</span><span style="color: #ed9d13">&#39;&#39;</span><span style="color: #d0d0d0">){</span>
			<span style="color: #40ffff">$sql</span> <span style="color: #d0d0d0">=</span> <span style="color: #ed9d13">&quot;SELECT * FROM sn_prefix p WHERE LEFT(&#39;$data-&gt;serial&#39;,3) = p.prefix&quot;</span><span style="color: #d0d0d0">;</span> 
			<span style="color: #40ffff">$result</span> <span style="color: #d0d0d0">=</span> <span style="color: #40ffff">$this</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">mysqli</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">query</span><span style="color: #d0d0d0">(</span><span style="color: #40ffff">$sql</span><span style="color: #d0d0d0">);</span>

			<span style="color: #6ab825; font-weight: bold">while</span><span style="color: #d0d0d0">(</span><span style="color: #40ffff">$row</span> <span style="color: #d0d0d0">=</span> <span style="color: #40ffff">$result</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">fetch_assoc</span><span style="color: #d0d0d0">())</span>
			<span style="color: #d0d0d0">{</span>
			<span style="color: #40ffff">$firstShip</span> <span style="color: #d0d0d0">=</span> <span style="color: #40ffff">$row</span><span style="color: #d0d0d0">[</span><span style="color: #ed9d13">&#39;first_ship&#39;</span><span style="color: #d0d0d0">];</span>
			<span style="color: #24909d">preg_match_all</span><span style="color: #d0d0d0">(</span><span style="color: #ed9d13">&quot;/[0-9]/&quot;</span><span style="color: #d0d0d0">,</span> <span style="color: #40ffff">$data</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">serial</span><span style="color: #d0d0d0">,</span> <span style="color: #40ffff">$matches</span><span style="color: #d0d0d0">);</span>

			<span style="color: #6ab825; font-weight: bold">if</span> <span style="color: #d0d0d0">(</span><span style="color: #40ffff">$matches</span><span style="color: #d0d0d0">[</span><span style="color: #3677a9">0</span><span style="color: #d0d0d0">][</span><span style="color: #3677a9">0</span><span style="color: #d0d0d0">]</span> <span style="color: #d0d0d0">&lt;</span> <span style="color: #d0d0d0">(substr(</span><span style="color: #40ffff">$firstShip</span><span style="color: #d0d0d0">,-</span><span style="color: #3677a9">1</span><span style="color: #d0d0d0">)-</span><span style="color: #3677a9">1</span><span style="color: #d0d0d0">))</span> <span style="color: #40ffff">$firstShip</span> <span style="color: #d0d0d0">=</span> <span style="color: #40ffff">$firstShip</span><span style="color: #d0d0d0">+</span><span style="color: #3677a9">10</span><span style="color: #d0d0d0">;</span>

			<span style="color: #40ffff">$year</span> <span style="color: #d0d0d0">=</span> <span style="color: #d0d0d0">substr(</span><span style="color: #40ffff">$firstShip</span><span style="color: #d0d0d0">,</span><span style="color: #3677a9">0</span><span style="color: #d0d0d0">,</span><span style="color: #3677a9">3</span><span style="color: #d0d0d0">).</span><span style="color: #40ffff">$matches</span><span style="color: #d0d0d0">[</span><span style="color: #3677a9">0</span><span style="color: #d0d0d0">][</span><span style="color: #3677a9">0</span><span style="color: #d0d0d0">];</span>
			<span style="color: #40ffff">$week</span> <span style="color: #d0d0d0">=</span> <span style="color: #40ffff">$matches</span><span style="color: #d0d0d0">[</span><span style="color: #3677a9">0</span><span style="color: #d0d0d0">][</span><span style="color: #3677a9">1</span><span style="color: #d0d0d0">].</span><span style="color: #40ffff">$matches</span><span style="color: #d0d0d0">[</span><span style="color: #3677a9">0</span><span style="color: #d0d0d0">][</span><span style="color: #3677a9">2</span><span style="color: #d0d0d0">];</span>
			<span style="color: #40ffff">$start</span> <span style="color: #d0d0d0">=</span> <span style="color: #24909d">date</span><span style="color: #d0d0d0">(</span><span style="color: #ed9d13">&quot;Y-m-d&quot;</span><span style="color: #d0d0d0">,</span> <span style="color: #24909d">strtotime</span><span style="color: #d0d0d0">(</span><span style="color: #ed9d13">&quot;01 Jan &quot;</span><span style="color: #d0d0d0">.</span><span style="color: #40ffff">$year</span><span style="color: #d0d0d0">.</span><span style="color: #ed9d13">&quot; 00:00:00 GMT + &quot;</span><span style="color: #d0d0d0">.</span><span style="color: #40ffff">$week</span><span style="color: #d0d0d0">.</span><span style="color: #ed9d13">&quot; weeks&quot;</span><span style="color: #d0d0d0">));</span>
			<span style="color: #40ffff">$data</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">from</span> <span style="color: #d0d0d0">=</span> <span style="color: #40ffff">$start</span><span style="color: #d0d0d0">;</span>
			<span style="color: #d0d0d0">}</span>
		<span style="color: #d0d0d0">}</span>


		<span style="color: #6ab825; font-weight: bold">if</span><span style="color: #d0d0d0">(</span><span style="color: #40ffff">$type</span> <span style="color: #d0d0d0">==</span> <span style="color: #ed9d13">&#39;i&#39;</span><span style="color: #d0d0d0">){</span>

			<span style="color: #40ffff">$user</span> <span style="color: #d0d0d0">=</span> <span style="color: #d0d0d0">craft()-&gt;</span><span style="color: #bbbbbb">userSession</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">getUser</span><span style="color: #d0d0d0">();</span>  
			<span style="color: #40ffff">$source</span> <span style="color: #d0d0d0">=</span> <span style="color: #ed9d13">&quot;Internal Registration - {</span><span style="color: #40ffff">$user</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">username</span><span style="color: #ed9d13">}&quot;</span><span style="color: #d0d0d0">;</span>
		<span style="color: #d0d0d0">}</span>


			<span style="color: #40ffff">$sql_base</span> <span style="color: #d0d0d0">=</span> <span style="color: #ed9d13">&quot;modified = CURDATE(),</span>
<span style="color: #ed9d13">			`first_name` = &#39;$data-&gt;first&#39;,</span>
<span style="color: #ed9d13">			`last_name` = &#39;$data-&gt;last&#39;,</span>
<span style="color: #ed9d13">			`org` = &#39;$data-&gt;org&#39;,</span>
<span style="color: #ed9d13">			`from_date` = &#39;$data-&gt;from&#39;,</span>
<span style="color: #ed9d13">			`phone` = &#39;$data-&gt;phone&#39;,</span>
<span style="color: #ed9d13">			`email` = &#39;$data-&gt;email&#39;,</span>
<span style="color: #ed9d13">			`address` = &#39;$data-&gt;address&#39;,</span>
<span style="color: #ed9d13">			`city` = &#39;$data-&gt;city&#39;,</span>
<span style="color: #ed9d13">			`state` = &#39;$data-&gt;state&#39;,</span>
<span style="color: #ed9d13">			`zip` = &#39;$data-&gt;zip&#39;,</span>
<span style="color: #ed9d13">			`reg_country` = &#39;$data-&gt;reg_country&#39;,</span>
<span style="color: #ed9d13">			`secondary_name` = &#39;$data-&gt;second_name&#39;,</span>
<span style="color: #ed9d13">			`secondary_email` = &#39;$data-&gt;second_email&#39;,&quot;</span><span style="color: #d0d0d0">;</span>
			<span style="color: #6ab825; font-weight: bold">if</span><span style="color: #d0d0d0">(</span><span style="color: #40ffff">$data</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">to</span> <span style="color: #d0d0d0">!=</span> <span style="color: #ed9d13">&#39;&#39;</span> <span style="color: #6ab825; font-weight: bold">AND</span> <span style="color: #40ffff">$data</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">to</span> <span style="color: #d0d0d0">!=</span> <span style="color: #6ab825; font-weight: bold">null</span><span style="color: #d0d0d0">)</span> <span style="color: #40ffff">$sql_base</span> <span style="color: #d0d0d0">.=</span> <span style="color: #ed9d13">&quot;`to_date` = &#39;$data-&gt;to&#39;,&quot;</span><span style="color: #d0d0d0">;</span>
			<span style="color: #6ab825; font-weight: bold">else</span> <span style="color: #40ffff">$sql_base</span> <span style="color: #d0d0d0">.=</span> <span style="color: #ed9d13">&quot;`to_date` = DATE_ADD(&#39;$data-&gt;from&#39;, INTERVAL `install_base`.`warranty_function`(&#39;$data-&gt;product&#39;,&#39;$data-&gt;country&#39;,&#39;Standard&#39;,&#39;$data-&gt;serial&#39;,&#39;000&#39;) MONTH),&quot;</span><span style="color: #d0d0d0">;</span>
		

			<span style="color: #6ab825; font-weight: bold">if</span><span style="color: #d0d0d0">(</span><span style="color: #24909d">isset</span><span style="color: #d0d0d0">(</span><span style="color: #40ffff">$data</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">optin</span><span style="color: #d0d0d0">))</span> <span style="color: #6ab825; font-weight: bold">if</span><span style="color: #d0d0d0">(</span><span style="color: #40ffff">$data</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">optin</span> <span style="color: #d0d0d0">!=</span> <span style="color: #ed9d13">&#39;&#39;</span><span style="color: #d0d0d0">)</span> <span style="color: #40ffff">$sql_base</span> <span style="color: #d0d0d0">.=</span> <span style="color: #ed9d13">&quot;`optin` = &#39;$data-&gt;optin&#39;,&quot;</span><span style="color: #d0d0d0">;</span>
			<span style="color: #6ab825; font-weight: bold">if</span><span style="color: #d0d0d0">(</span><span style="color: #24909d">isset</span><span style="color: #d0d0d0">(</span><span style="color: #40ffff">$data</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">sale</span><span style="color: #d0d0d0">))</span> <span style="color: #6ab825; font-weight: bold">if</span><span style="color: #d0d0d0">(</span><span style="color: #40ffff">$data</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">sale</span> <span style="color: #d0d0d0">!=</span> <span style="color: #ed9d13">&#39;&#39;</span><span style="color: #d0d0d0">)</span> <span style="color: #40ffff">$sql_base</span> <span style="color: #d0d0d0">.=</span> <span style="color: #ed9d13">&quot;`sales_id` = &#39;$data-&gt;sale&#39;,&quot;</span><span style="color: #d0d0d0">;</span>
			<span style="color: #6ab825; font-weight: bold">if</span><span style="color: #d0d0d0">(</span><span style="color: #24909d">isset</span><span style="color: #d0d0d0">(</span><span style="color: #40ffff">$data</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">inventdimid</span><span style="color: #d0d0d0">))</span> <span style="color: #6ab825; font-weight: bold">if</span><span style="color: #d0d0d0">(</span><span style="color: #40ffff">$data</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">inventdimid</span> <span style="color: #d0d0d0">!=</span> <span style="color: #ed9d13">&#39;&#39;</span><span style="color: #d0d0d0">)</span> <span style="color: #40ffff">$sql_base</span> <span style="color: #d0d0d0">.=</span> <span style="color: #ed9d13">&quot;`INVENTDIMID` = &#39;$data-&gt;inventdimid&#39;,&quot;</span><span style="color: #d0d0d0">;</span>
			<span style="color: #6ab825; font-weight: bold">if</span><span style="color: #d0d0d0">(</span><span style="color: #24909d">isset</span><span style="color: #d0d0d0">(</span><span style="color: #40ffff">$data</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">product</span><span style="color: #d0d0d0">))</span> <span style="color: #6ab825; font-weight: bold">if</span><span style="color: #d0d0d0">(</span><span style="color: #40ffff">$data</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">product</span> <span style="color: #d0d0d0">!=</span> <span style="color: #ed9d13">&#39;&#39;</span><span style="color: #d0d0d0">)</span> <span style="color: #40ffff">$sql_base</span> <span style="color: #d0d0d0">.=</span> <span style="color: #ed9d13">&quot;`part_number` = &#39;$data-&gt;product&#39;,&quot;</span><span style="color: #d0d0d0">;</span>
			<span style="color: #6ab825; font-weight: bold">if</span><span style="color: #d0d0d0">(</span><span style="color: #24909d">isset</span><span style="color: #d0d0d0">(</span><span style="color: #40ffff">$data</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">reseller</span><span style="color: #d0d0d0">))</span> <span style="color: #6ab825; font-weight: bold">if</span><span style="color: #d0d0d0">(</span><span style="color: #40ffff">$data</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">reseller</span> <span style="color: #d0d0d0">!=</span> <span style="color: #ed9d13">&#39;&#39;</span><span style="color: #d0d0d0">)</span> <span style="color: #40ffff">$sql_base</span> <span style="color: #d0d0d0">.=</span> <span style="color: #ed9d13">&quot;`name` = &#39;$data-&gt;reseller&#39;,&quot;</span><span style="color: #d0d0d0">;</span>

		<span style="color: #6ab825; font-weight: bold">if</span><span style="color: #d0d0d0">(</span><span style="color: #40ffff">$type</span> <span style="color: #d0d0d0">==</span> <span style="color: #ed9d13">&#39;t&#39;</span><span style="color: #d0d0d0">){</span>
			<span style="color: #6ab825; font-weight: bold">if</span> <span style="color: #d0d0d0">(</span><span style="color: #24909d">is_array</span><span style="color: #d0d0d0">(</span><span style="color: #40ffff">$data</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">ewCode</span><span style="color: #d0d0d0">))</span> <span style="color: #40ffff">$data</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">ewCode</span> <span style="color: #d0d0d0">=</span> <span style="color: #24909d">implode</span><span style="color: #d0d0d0">(</span><span style="color: #ed9d13">&quot;,&quot;</span><span style="color: #d0d0d0">,</span> <span style="color: #40ffff">$data</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">ewCode</span><span style="color: #d0d0d0">);</span>
		    <span style="color: #40ffff">$sql</span><span style="color: #d0d0d0">=</span><span style="color: #ed9d13">&quot;REPLACE INTO ib_pending SET $sql_base `warranty_keys` = &#39;$data-&gt;ewCode&#39;, serial_number = &#39;$data-&gt;serial&#39;&quot;</span><span style="color: #d0d0d0">;</span>
		    <span style="color: #40ffff">$result</span> <span style="color: #d0d0d0">=</span> <span style="color: #40ffff">$this</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">mysqli</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">query</span><span style="color: #d0d0d0">(</span><span style="color: #40ffff">$sql</span><span style="color: #d0d0d0">);</span>

			<span style="color: #40ffff">$sql</span> <span style="color: #d0d0d0">=</span> <span style="color: #ed9d13">&quot;SELECT contract FROM install_base.contract_rules r </span>
<span style="color: #ed9d13">									JOIN infocus_internal.sales_regions s ON country = &#39;$data-&gt;country&#39;</span>
<span style="color: #ed9d13">									JOIN infocus_internal.items i ON ITEMID = &#39;$data-&gt;product&#39; </span>
<span style="color: #ed9d13">									JOIN install_base.contract_data d ON d.part_number = contract </span>
<span style="color: #ed9d13">						WHERE r.`warranty_type` = &#39;Registration&#39; AND</span>
<span style="color: #ed9d13">				(LOCATE(CONCAT(s.region,&#39;,&#39;),CONCAT(&#39; &#39;,r.`region`,&#39;,&#39;))&gt;0 OR r.region = &#39;All&#39;) AND </span>
<span style="color: #ed9d13">				(LOCATE(CONCAT(i.PROJCATEGORYID,&#39;,&#39;),CONCAT(&#39; &#39;,`category`,&#39;,&#39;))&gt;0 OR LOCATE(CONCAT(&#39;$data-&gt;product&#39;,&#39;,&#39;),CONCAT(&#39; &#39;,`category`,&#39;,&#39;))&gt;0) AND</span>
<span style="color: #ed9d13">				(LOCATE(CONCAT(&#39;Standard&#39;,&#39;,&#39;),CONCAT(&#39; &#39;,`customer`,&#39;,&#39;))&gt;0 OR LOCATE(CONCAT(&#39;000&#39;,&#39;,&#39;),CONCAT(&#39; &#39;,`customer`,&#39;,&#39;))&gt;0 OR `customer` = &#39;All&#39;)&quot;</span><span style="color: #d0d0d0">;</span>


		    <span style="color: #40ffff">$result</span> <span style="color: #d0d0d0">=</span> <span style="color: #40ffff">$this</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">mysqli</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">query</span><span style="color: #d0d0d0">(</span><span style="color: #40ffff">$sql</span><span style="color: #d0d0d0">);</span>
		    <span style="color: #40ffff">$contracts</span> <span style="color: #d0d0d0">=</span> <span style="color: #d0d0d0">[];</span>
			<span style="color: #6ab825; font-weight: bold">while</span><span style="color: #d0d0d0">(</span><span style="color: #40ffff">$row</span> <span style="color: #d0d0d0">=</span> <span style="color: #40ffff">$result</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">fetch_assoc</span><span style="color: #d0d0d0">())</span> <span style="color: #40ffff">$contracts</span><span style="color: #d0d0d0">[]</span> <span style="color: #d0d0d0">=</span> <span style="color: #40ffff">$row</span><span style="color: #d0d0d0">[</span><span style="color: #ed9d13">&#39;contract&#39;</span><span style="color: #d0d0d0">];</span>

			<span style="color: #6ab825; font-weight: bold">if</span><span style="color: #d0d0d0">(</span><span style="color: #24909d">count</span><span style="color: #d0d0d0">(</span><span style="color: #40ffff">$contracts</span><span style="color: #d0d0d0">)&gt;</span><span style="color: #3677a9">0</span><span style="color: #d0d0d0">)</span> <span style="color: #6ab825; font-weight: bold">return</span> <span style="color: #6ab825; font-weight: bold">TRUE</span><span style="color: #d0d0d0">;</span>
				<span style="color: #6ab825; font-weight: bold">else</span> <span style="color: #6ab825; font-weight: bold">return</span> <span style="color: #6ab825; font-weight: bold">FALSE</span><span style="color: #d0d0d0">;</span>


		<span style="color: #d0d0d0">}</span>
		<span style="color: #6ab825; font-weight: bold">else</span><span style="color: #d0d0d0">{</span>
			<span style="color: #40ffff">$sql</span><span style="color: #d0d0d0">=</span><span style="color: #ed9d13">&quot;INSERT INTO install_base SET </span>
<span style="color: #ed9d13">			$sql_base </span>
<span style="color: #ed9d13">			`country` = &#39;$data-&gt;country&#39;,</span>
<span style="color: #ed9d13">			`registered` = &#39;TRUE&#39;,</span>
<span style="color: #ed9d13">			`source` = &#39;$source&#39;,</span>
<span style="color: #ed9d13">			`status` = &#39;Created&#39;,</span>
<span style="color: #ed9d13">			serial_number = &#39;$data-&gt;serial&#39; ON DUPLICATE KEY UPDATE $sql_base </span>
<span style="color: #ed9d13">			`registered` = &#39;TRUE&#39;,</span>
<span style="color: #ed9d13">			`source` = &#39;$source&#39;, `status` = &#39;Updated&#39; &quot;</span><span style="color: #d0d0d0">;</span>

			<span style="color: #40ffff">$result</span> <span style="color: #d0d0d0">=</span> <span style="color: #40ffff">$this</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">mysqli</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">query</span><span style="color: #d0d0d0">(</span><span style="color: #40ffff">$sql</span><span style="color: #d0d0d0">);</span>

				<span style="color: #999999; font-style: italic">// ************ Registration Contract **************</span>


			<span style="color: #6ab825; font-weight: bold">if</span><span style="color: #d0d0d0">(</span><span style="color: #40ffff">$data</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">ewCode</span><span style="color: #d0d0d0">)</span> <span style="color: #40ffff">$this</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">registerContracts</span><span style="color: #d0d0d0">(</span><span style="color: #40ffff">$data</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">ewCode</span><span style="color: #d0d0d0">,</span><span style="color: #40ffff">$data</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">serial</span><span style="color: #d0d0d0">,</span><span style="color: #40ffff">$data</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">email</span><span style="color: #d0d0d0">);</span>
			
			<span style="color: #6ab825; font-weight: bold">return</span> <span style="color: #40ffff">$this</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">registrationContract</span><span style="color: #d0d0d0">(</span><span style="color: #40ffff">$data</span><span style="color: #d0d0d0">);</span>
		<span style="color: #d0d0d0">}</span>
	<span style="color: #d0d0d0">}</span>

	<span style="color: #6ab825; font-weight: bold">public</span> <span style="color: #6ab825; font-weight: bold">function</span> <span style="color: #447fcf">registrationContract</span><span style="color: #d0d0d0">(</span><span style="color: #40ffff">$data</span><span style="color: #d0d0d0">){</span>

		<span style="color: #40ffff">$sql</span> <span style="color: #d0d0d0">=</span> <span style="color: #ed9d13">&quot;SELECT contract FROM install_base.contract_rules r </span>
<span style="color: #ed9d13">								LEFT JOIN infocus_internal.sales_regions s ON country = &#39;$data-&gt;country&#39;</span>
<span style="color: #ed9d13">								JOIN infocus_internal.items i ON ITEMID = &#39;$data-&gt;product&#39; </span>
<span style="color: #ed9d13">								JOIN install_base.contract_data d ON d.part_number = contract </span>
<span style="color: #ed9d13">					WHERE r.`warranty_type` = &#39;Registration&#39; AND</span>
<span style="color: #ed9d13">			(LOCATE(CONCAT(s.region,&#39;,&#39;),CONCAT(&#39; &#39;,r.`region`,&#39;,&#39;))&gt;0 OR r.region = &#39;All&#39;) AND </span>
<span style="color: #ed9d13">			(LOCATE(CONCAT(i.PROJCATEGORYID,&#39;,&#39;),CONCAT(&#39; &#39;,`category`,&#39;,&#39;))&gt;0 OR LOCATE(CONCAT(&#39;$data-&gt;product&#39;,&#39;,&#39;),CONCAT(&#39; &#39;,`category`,&#39;,&#39;))&gt;0) AND</span>
<span style="color: #ed9d13">			(LOCATE(CONCAT(&#39;Standard&#39;,&#39;,&#39;),CONCAT(&#39; &#39;,`customer`,&#39;,&#39;))&gt;0 OR LOCATE(CONCAT(&#39;000&#39;,&#39;,&#39;),CONCAT(&#39; &#39;,`customer`,&#39;,&#39;))&gt;0 OR `customer` = &#39;All&#39;)&quot;</span><span style="color: #d0d0d0">;</span>


		    <span style="color: #40ffff">$result</span> <span style="color: #d0d0d0">=</span> <span style="color: #40ffff">$this</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">mysqli</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">query</span><span style="color: #d0d0d0">(</span><span style="color: #40ffff">$sql</span><span style="color: #d0d0d0">);</span>
		    <span style="color: #40ffff">$contracts</span> <span style="color: #d0d0d0">=</span> <span style="color: #d0d0d0">[];</span>
		<span style="color: #6ab825; font-weight: bold">while</span><span style="color: #d0d0d0">(</span><span style="color: #40ffff">$row</span> <span style="color: #d0d0d0">=</span> <span style="color: #40ffff">$result</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">fetch_assoc</span><span style="color: #d0d0d0">())</span> <span style="color: #40ffff">$contracts</span><span style="color: #d0d0d0">[]</span> <span style="color: #d0d0d0">=</span> <span style="color: #40ffff">$row</span><span style="color: #d0d0d0">[</span><span style="color: #ed9d13">&#39;contract&#39;</span><span style="color: #d0d0d0">];</span>


		<span style="color: #40ffff">$sql</span> <span style="color: #d0d0d0">=</span> <span style="color: #ed9d13">&quot;INSERT IGNORE INTO install_base.contracts (part_number,`key`,issued, redeemed, contract_length, serial_number) SELECT contract, CONCAT(&#39;$data-&gt;serial&#39;,&#39;REG&#39;,contract), NOW(), NOW(), d.contract_length, &#39;$data-&gt;serial&#39; FROM install_base.contract_rules r 								</span>
<span style="color: #ed9d13">				LEFT JOIN infocus_internal.sales_regions s ON country = &#39;$data-&gt;country&#39; </span>
<span style="color: #ed9d13">				JOIN infocus_internal.items i ON ITEMID = &#39;$data-&gt;product&#39; </span>
<span style="color: #ed9d13">				JOIN install_base.contract_data d ON d.part_number = contract </span>
<span style="color: #ed9d13">				WHERE r.`warranty_type` = &#39;Registration&#39; AND</span>
<span style="color: #ed9d13">			(LOCATE(CONCAT(s.region,&#39;,&#39;),CONCAT(&#39; &#39;,r.`region`,&#39;,&#39;))&gt;0 OR r.region = &#39;All&#39;) AND </span>
<span style="color: #ed9d13">			(LOCATE(CONCAT(i.PROJCATEGORYID,&#39;,&#39;),CONCAT(&#39; &#39;,`category`,&#39;,&#39;))&gt;0 OR LOCATE(CONCAT(&#39;$data-&gt;product&#39;,&#39;,&#39;),CONCAT(&#39; &#39;,`category`,&#39;,&#39;))&gt;0) AND</span>
<span style="color: #ed9d13">			(LOCATE(CONCAT(&#39;Standard&#39;,&#39;,&#39;),CONCAT(&#39; &#39;,`customer`,&#39;,&#39;))&gt;0 OR LOCATE(CONCAT(&#39;000&#39;,&#39;,&#39;),CONCAT(&#39; &#39;,`customer`,&#39;,&#39;))&gt;0 OR `customer` = &#39;All&#39;)&quot;</span><span style="color: #d0d0d0">;</span>


		    <span style="color: #40ffff">$result</span> <span style="color: #d0d0d0">=</span> <span style="color: #40ffff">$this</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">mysqli</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">query</span><span style="color: #d0d0d0">(</span><span style="color: #40ffff">$sql</span><span style="color: #d0d0d0">);</span>




		    <span style="color: #6ab825; font-weight: bold">foreach</span> <span style="color: #d0d0d0">(</span><span style="color: #40ffff">$contracts</span> <span style="color: #6ab825; font-weight: bold">as</span> <span style="color: #40ffff">$contract</span><span style="color: #d0d0d0">)</span> <span style="color: #d0d0d0">{</span>

		<span style="color: #40ffff">$sql</span> <span style="color: #d0d0d0">=</span> <span style="color: #ed9d13">&quot;SELECT id FROM craftcms.craft_content WHERE `field_partNumber` = &#39;$contract&#39;&quot;</span><span style="color: #d0d0d0">;</span> 
		<span style="color: #40ffff">$result</span> <span style="color: #d0d0d0">=</span> <span style="color: #40ffff">$this</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">mysqli</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">query</span><span style="color: #d0d0d0">(</span><span style="color: #40ffff">$sql</span><span style="color: #d0d0d0">);</span>


		<span style="color: #40ffff">$emailId</span> <span style="color: #d0d0d0">=</span> <span style="color: #ed9d13">&#39;&#39;</span><span style="color: #d0d0d0">;</span>
		<span style="color: #6ab825; font-weight: bold">while</span><span style="color: #d0d0d0">(</span><span style="color: #40ffff">$row</span> <span style="color: #d0d0d0">=</span> <span style="color: #40ffff">$result</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">fetch_assoc</span><span style="color: #d0d0d0">())</span> <span style="color: #40ffff">$emailId</span>  <span style="color: #d0d0d0">=</span> <span style="color: #40ffff">$row</span><span style="color: #d0d0d0">[</span><span style="color: #ed9d13">&#39;id&#39;</span><span style="color: #d0d0d0">];</span>

   		<span style="color: #40ffff">$htmlEmail</span> <span style="color: #d0d0d0">=</span> <span style="color: #d0d0d0">craft()-&gt;</span><span style="color: #bbbbbb">entries</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">getEntryById</span><span style="color: #d0d0d0">(</span><span style="color: #40ffff">$emailId</span><span style="color: #d0d0d0">)-&gt;</span><span style="color: #bbbbbb">getContent</span><span style="color: #d0d0d0">()[</span><span style="color: #ed9d13">&#39;body&#39;</span><span style="color: #d0d0d0">];</span>
   		<span style="color: #40ffff">$textEmail</span> <span style="color: #d0d0d0">=</span> <span style="color: #d0d0d0">craft()-&gt;</span><span style="color: #bbbbbb">entries</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">getEntryById</span><span style="color: #d0d0d0">(</span><span style="color: #40ffff">$emailId</span><span style="color: #d0d0d0">)-&gt;</span><span style="color: #bbbbbb">getContent</span><span style="color: #d0d0d0">()[</span><span style="color: #ed9d13">&#39;txtBody&#39;</span><span style="color: #d0d0d0">];</span>
   		<span style="color: #40ffff">$subject</span> <span style="color: #d0d0d0">=</span> <span style="color: #d0d0d0">craft()-&gt;</span><span style="color: #bbbbbb">entries</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">getEntryById</span><span style="color: #d0d0d0">(</span><span style="color: #40ffff">$emailId</span><span style="color: #d0d0d0">)-&gt;</span><span style="color: #bbbbbb">getContent</span><span style="color: #d0d0d0">()[</span><span style="color: #ed9d13">&#39;subject&#39;</span><span style="color: #d0d0d0">];</span>

   		<span style="color: #40ffff">$htmlEmail</span> <span style="color: #d0d0d0">=</span> <span style="color: #24909d">str_replace</span><span style="color: #d0d0d0">(</span><span style="color: #ed9d13">&quot;{{key}}&quot;</span><span style="color: #d0d0d0">,</span> <span style="color: #40ffff">$data</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">serial</span> <span style="color: #d0d0d0">.</span> <span style="color: #ed9d13">&#39;REG&#39;</span> <span style="color: #d0d0d0">.</span> <span style="color: #40ffff">$contract</span><span style="color: #d0d0d0">,</span> <span style="color: #40ffff">$htmlEmail</span><span style="color: #d0d0d0">);</span>
   		<span style="color: #40ffff">$textEmail</span> <span style="color: #d0d0d0">=</span> <span style="color: #24909d">str_replace</span><span style="color: #d0d0d0">(</span><span style="color: #ed9d13">&quot;{{key}}&quot;</span><span style="color: #d0d0d0">,</span> <span style="color: #40ffff">$data</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">serial</span> <span style="color: #d0d0d0">.</span> <span style="color: #ed9d13">&#39;REG&#39;</span> <span style="color: #d0d0d0">.</span> <span style="color: #40ffff">$contract</span><span style="color: #d0d0d0">,</span> <span style="color: #40ffff">$textEmail</span><span style="color: #d0d0d0">);</span>
   		<span style="color: #40ffff">$htmlEmail</span> <span style="color: #d0d0d0">=</span> <span style="color: #24909d">str_replace</span><span style="color: #d0d0d0">(</span><span style="color: #ed9d13">&quot;{{fName}}&quot;</span><span style="color: #d0d0d0">,</span> <span style="color: #40ffff">$data</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">first</span><span style="color: #d0d0d0">,</span> <span style="color: #40ffff">$htmlEmail</span><span style="color: #d0d0d0">);</span>
   		<span style="color: #40ffff">$textEmail</span> <span style="color: #d0d0d0">=</span> <span style="color: #24909d">str_replace</span><span style="color: #d0d0d0">(</span><span style="color: #ed9d13">&quot;{{fName}}&quot;</span><span style="color: #d0d0d0">,</span> <span style="color: #40ffff">$data</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">first</span><span style="color: #d0d0d0">,</span> <span style="color: #40ffff">$textEmail</span><span style="color: #d0d0d0">);</span>


			<span style="color: #40ffff">$email</span> <span style="color: #d0d0d0">=</span> <span style="color: #6ab825; font-weight: bold">new</span> <span style="color: #d0d0d0">EmailModel();</span>
			<span style="color: #40ffff">$email</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">toEmail</span> 			<span style="color: #d0d0d0">=</span> <span style="color: #40ffff">$data</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">email</span><span style="color: #d0d0d0">;</span>
			<span style="color: #999999; font-style: italic">// if($data-&gt;second_email != &#39;&#39;) $email-&gt;cc = array(array(&#39;email&#39; =&gt; $data-&gt;second_email, &#39;name&#39; =&gt; $data-&gt;second_name));</span>
			<span style="color: #40ffff">$email</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">replyTo</span> 			<span style="color: #d0d0d0">=</span> <span style="color: #ed9d13">&quot;no-reply@infocus.com&quot;</span><span style="color: #d0d0d0">;</span>
			<span style="color: #40ffff">$email</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">subject</span> 			<span style="color: #d0d0d0">=</span> <span style="color: #40ffff">$subject</span><span style="color: #d0d0d0">;</span>
			<span style="color: #40ffff">$email</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">body</span>    			<span style="color: #d0d0d0">=</span> <span style="color: #40ffff">$textEmail</span><span style="color: #d0d0d0">;</span>
			<span style="color: #40ffff">$email</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">htmlBody</span>    		<span style="color: #d0d0d0">=</span> <span style="color: #40ffff">$htmlEmail</span><span style="color: #d0d0d0">;</span>
			<span style="color: #40ffff">$email</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">validate</span><span style="color: #d0d0d0">();</span>
			<span style="color: #6ab825; font-weight: bold">if</span><span style="color: #d0d0d0">(</span><span style="color: #40ffff">$email</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">hasErrors</span><span style="color: #d0d0d0">())</span>
				<span style="color: #d0d0d0">{</span>
					<span style="color: #40ffff">$email</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">subject</span> <span style="color: #d0d0d0">=</span> <span style="color: #ed9d13">&quot;Error in Registration Processing&quot;</span><span style="color: #d0d0d0">;</span>
					<span style="color: #40ffff">$email</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">body</span> <span style="color: #d0d0d0">=</span> <span style="color: #ed9d13">&quot;Error in Registration Processing:\r\n&quot;</span><span style="color: #d0d0d0">.</span><span style="color: #24909d">json_encode</span><span style="color: #d0d0d0">(</span><span style="color: #40ffff">$email</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">getAllErrors</span><span style="color: #d0d0d0">()).</span> <span style="color: #ed9d13">&quot;\r\n\r\nFor Email address: &quot;</span> <span style="color: #d0d0d0">.</span> <span style="color: #40ffff">$email_address</span><span style="color: #d0d0d0">;</span>
					<span style="color: #40ffff">$email</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">htmlBody</span> <span style="color: #d0d0d0">=</span> <span style="color: #ed9d13">&quot;Error in Registration Processing:&lt; br&gt;&quot;</span><span style="color: #d0d0d0">.</span><span style="color: #24909d">json_encode</span><span style="color: #d0d0d0">(</span><span style="color: #40ffff">$email</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">getAllErrors</span><span style="color: #d0d0d0">()).</span> <span style="color: #ed9d13">&quot;&lt; br&gt;&lt; br&gt;Email address: &quot;</span> <span style="color: #d0d0d0">.</span> <span style="color: #40ffff">$email_address</span><span style="color: #d0d0d0">;</span>
					<span style="color: #40ffff">$email</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">toEmail</span> <span style="color: #d0d0d0">=</span> <span style="color: #ed9d13">&quot;helpdesk@infocus.com&quot;</span><span style="color: #d0d0d0">;</span>
				<span style="color: #d0d0d0">}</span>
			<span style="color: #d0d0d0">craft()-&gt;</span><span style="color: #bbbbbb">email</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">sendEmail</span><span style="color: #d0d0d0">(</span><span style="color: #40ffff">$email</span><span style="color: #d0d0d0">);</span>
		<span style="color: #d0d0d0">}</span>

		<span style="color: #6ab825; font-weight: bold">if</span><span style="color: #d0d0d0">(</span><span style="color: #24909d">count</span><span style="color: #d0d0d0">(</span><span style="color: #40ffff">$contracts</span><span style="color: #d0d0d0">)&gt;</span><span style="color: #3677a9">0</span><span style="color: #d0d0d0">)</span> <span style="color: #6ab825; font-weight: bold">return</span> <span style="color: #6ab825; font-weight: bold">TRUE</span><span style="color: #d0d0d0">;</span>
			<span style="color: #6ab825; font-weight: bold">else</span> <span style="color: #6ab825; font-weight: bold">return</span> <span style="color: #6ab825; font-weight: bold">FALSE</span><span style="color: #d0d0d0">;</span>

	<span style="color: #d0d0d0">}</span>

   <span style="color: #6ab825; font-weight: bold">public</span> <span style="color: #6ab825; font-weight: bold">function</span> <span style="color: #447fcf">actionUpdateZendesk</span><span style="color: #d0d0d0">()</span>
   <span style="color: #d0d0d0">{</span>
		<span style="color: #999999; font-style: italic">//cron record: 30 10,16 * * 1-5 wget http://internal.infocus.com/actions/service/api/updateZendesk</span>
		<span style="color: #d0d0d0">ServicePlugin::</span><span style="color: #bbbbbb">log</span><span style="color: #d0d0d0">(</span><span style="color: #ed9d13">&quot;Zendesk Update&quot;</span><span style="color: #d0d0d0">);</span>
		<span style="color: #40ffff">$this</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">mysqli</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">select_db</span><span style="color: #d0d0d0">(</span><span style="color: #ed9d13">&#39;infocus_internal&#39;</span><span style="color: #d0d0d0">);</span>
		<span style="color: #40ffff">$sql</span> <span style="color: #d0d0d0">=</span> <span style="color: #ed9d13">&quot;SELECT REPLACE(id,&#39;ZDCase# &#39;,&#39;&#39;) as id, rma,sales_order, `status`, owner, note FROM ax_transactions WHERE `status` IN(&#39;Processed&#39;, &#39;Err&#39;)&quot;</span><span style="color: #d0d0d0">;</span>
		<span style="color: #40ffff">$result</span> <span style="color: #d0d0d0">=</span> <span style="color: #40ffff">$this</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">mysqli</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">query</span><span style="color: #d0d0d0">(</span><span style="color: #40ffff">$sql</span><span style="color: #d0d0d0">);</span>

		<span style="color: #6ab825; font-weight: bold">while</span><span style="color: #d0d0d0">(</span><span style="color: #40ffff">$row</span> <span style="color: #d0d0d0">=</span> <span style="color: #40ffff">$result</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">fetch_assoc</span><span style="color: #d0d0d0">()){</span>

			<span style="color: #40ffff">$caseNum</span> <span style="color: #d0d0d0">=</span> <span style="color: #40ffff">$row</span><span style="color: #d0d0d0">[</span><span style="color: #ed9d13">&#39;id&#39;</span><span style="color: #d0d0d0">];</span>
			<span style="color: #40ffff">$RMA</span> <span style="color: #d0d0d0">=</span> <span style="color: #40ffff">$row</span><span style="color: #d0d0d0">[</span><span style="color: #ed9d13">&#39;rma&#39;</span><span style="color: #d0d0d0">];</span>
			<span style="color: #40ffff">$SO</span> <span style="color: #d0d0d0">=</span> <span style="color: #40ffff">$row</span><span style="color: #d0d0d0">[</span><span style="color: #ed9d13">&#39;sales_order&#39;</span><span style="color: #d0d0d0">];</span>
			<span style="color: #40ffff">$note</span> <span style="color: #d0d0d0">=</span> <span style="color: #40ffff">$row</span><span style="color: #d0d0d0">[</span><span style="color: #ed9d13">&#39;note&#39;</span><span style="color: #d0d0d0">];</span>
			<span style="color: #40ffff">$owner</span> <span style="color: #d0d0d0">=</span> <span style="color: #40ffff">$row</span><span style="color: #d0d0d0">[</span><span style="color: #ed9d13">&#39;owner&#39;</span><span style="color: #d0d0d0">];</span>

			<span style="color: #6ab825; font-weight: bold">if</span><span style="color: #d0d0d0">(substr(</span><span style="color: #40ffff">$RMA</span><span style="color: #d0d0d0">,</span><span style="color: #3677a9">0</span><span style="color: #d0d0d0">,</span><span style="color: #3677a9">1</span><span style="color: #d0d0d0">)</span> <span style="color: #d0d0d0">==</span> <span style="color: #3677a9">5</span> <span style="color: #6ab825; font-weight: bold">OR</span> <span style="color: #d0d0d0">substr(</span><span style="color: #40ffff">$SO</span><span style="color: #d0d0d0">,</span><span style="color: #3677a9">0</span><span style="color: #d0d0d0">,</span><span style="color: #3677a9">1</span><span style="color: #d0d0d0">)</span> <span style="color: #d0d0d0">==</span> <span style="color: #3677a9">9</span> <span style="color: #d0d0d0">){</span>
			<span style="color: #40ffff">$data_string</span> <span style="color: #d0d0d0">=</span> <span style="color: #ed9d13">&quot;{&#39;ticket&#39;: {</span>
<span style="color: #ed9d13">					&#39;status&#39;:&#39;open&#39;,</span>
<span style="color: #ed9d13">					&#39;custom_fields&#39;:[</span>
<span style="color: #ed9d13">						{&#39;id&#39;:23557899,&#39;value&#39;:&#39;$SO&#39;},</span>
<span style="color: #ed9d13">						{&#39;id&#39;:23617005,&#39;value&#39;:&#39;$RMA&#39;}],</span>
<span style="color: #ed9d13">			 &#39;comment&#39;:{&#39;public&#39;:false, &#39;body&#39;: &#39;Order Processed&#39;, &#39;author_id&#39;: 416847189}}}&quot;</span><span style="color: #d0d0d0">;</span>
			<span style="color: #d0d0d0">}</span>
			<span style="color: #6ab825; font-weight: bold">else</span><span style="color: #d0d0d0">{</span>
				<span style="color: #40ffff">$data_string</span> <span style="color: #d0d0d0">=</span> <span style="color: #ed9d13">&quot;{&#39;ticket&#39;: {</span>
<span style="color: #ed9d13">						&#39;status&#39;:&#39;open&#39;,</span>
<span style="color: #ed9d13">				 &#39;comment&#39;:{&#39;public&#39;:false, &#39;body&#39;: &#39;Processing Error: $note&#39;, &#39;author_id&#39;: 416847189}}}&quot;</span><span style="color: #d0d0d0">;</span>
			<span style="color: #d0d0d0">}</span>

			<span style="color: #40ffff">$replace</span> <span style="color: #d0d0d0">=</span> <span style="color: #6ab825; font-weight: bold">array</span><span style="color: #d0d0d0">(</span><span style="color: #ed9d13">&quot;&#39;&quot;</span><span style="color: #d0d0d0">,</span><span style="color: #ed9d13">&quot;~~&quot;</span><span style="color: #d0d0d0">,</span><span style="color: #ed9d13">&quot;~&quot;</span><span style="color: #d0d0d0">);</span>
			<span style="color: #40ffff">$with</span> <span style="color: #d0d0d0">=</span> <span style="color: #6ab825; font-weight: bold">array</span><span style="color: #d0d0d0">(</span><span style="color: #ed9d13">&#39;&quot;&#39;</span><span style="color: #d0d0d0">,</span><span style="color: #ed9d13">&#39;\\&quot;&#39;</span><span style="color: #d0d0d0">,</span><span style="color: #ed9d13">&quot;&#39;&quot;</span><span style="color: #d0d0d0">);</span>
			<span style="color: #40ffff">$data_string</span> <span style="color: #d0d0d0">=</span> <span style="color: #24909d">str_replace</span><span style="color: #d0d0d0">(</span><span style="color: #40ffff">$replace</span><span style="color: #d0d0d0">,</span><span style="color: #40ffff">$with</span><span style="color: #d0d0d0">,</span><span style="color: #40ffff">$data_string</span><span style="color: #d0d0d0">);</span>			

			<span style="color: #40ffff">$this</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">sendToZendesk</span><span style="color: #d0d0d0">(</span><span style="color: #40ffff">$data_string</span><span style="color: #d0d0d0">,</span> <span style="color: #40ffff">$caseNum</span><span style="color: #d0d0d0">);</span>
			
			<span style="color: #6ab825; font-weight: bold">if</span><span style="color: #d0d0d0">(</span><span style="color: #40ffff">$row</span><span style="color: #d0d0d0">[</span><span style="color: #ed9d13">&#39;status&#39;</span><span style="color: #d0d0d0">]</span> <span style="color: #d0d0d0">!=</span> <span style="color: #ed9d13">&quot;Err&quot;</span><span style="color: #d0d0d0">)</span> <span style="color: #40ffff">$sub_sql</span> <span style="color: #d0d0d0">=</span> <span style="color: #ed9d13">&quot;UPDATE ax_transactions SET Status = &#39;Closed&#39; WHERE ID = &#39;ZDCase# $caseNum&#39;&quot;</span><span style="color: #d0d0d0">;</span>
				<span style="color: #6ab825; font-weight: bold">else</span><span style="color: #d0d0d0">{</span>
					<span style="color: #40ffff">$sub_sql</span> <span style="color: #d0d0d0">=</span> <span style="color: #ed9d13">&quot;UPDATE ax_transactions SET Status = &#39;Error&#39; WHERE ID = &#39;ZDCase# $caseNum&#39;&quot;</span><span style="color: #d0d0d0">;</span>
					<span style="color: #40ffff">$owner</span> <span style="color: #d0d0d0">=</span> <span style="color: #24909d">str_replace</span><span style="color: #d0d0d0">(</span><span style="color: #ed9d13">&quot; &quot;</span><span style="color: #d0d0d0">,</span><span style="color: #ed9d13">&quot;.&quot;</span><span style="color: #d0d0d0">,</span><span style="color: #40ffff">$owner</span><span style="color: #d0d0d0">)</span> <span style="color: #d0d0d0">.</span> <span style="color: #ed9d13">&quot;@infocus.com&quot;</span><span style="color: #d0d0d0">;</span>			

					<span style="color: #40ffff">$this</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">sendEmail</span><span style="color: #d0d0d0">(</span><span style="color: #40ffff">$owner</span><span style="color: #d0d0d0">,</span> <span style="color: #ed9d13">&quot;Order Error&quot;</span><span style="color: #d0d0d0">,</span><span style="color: #ed9d13">&quot;&lt; a href=&#39;https://infocuscorp.zendesk.com/agent/tickets/$caseNum&#39;&gt;Case# $caseNum &lt; /a&gt;&lt; br&gt;&lt; a href=&#39;http://internal.infocus.com/service/service-order-review&#39;&gt;Service Order Review&lt; /a&gt;&quot;</span><span style="color: #d0d0d0">);</span>
				<span style="color: #d0d0d0">}</span> 

			<span style="color: #40ffff">$sub_result</span>	<span style="color: #d0d0d0">=</span>	<span style="color: #40ffff">$this</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">mysqli</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">query</span><span style="color: #d0d0d0">(</span><span style="color: #40ffff">$sub_sql</span><span style="color: #d0d0d0">);</span>
		<span style="color: #d0d0d0">}</span>
	<span style="color: #d0d0d0">}</span>

   <span style="color: #6ab825; font-weight: bold">public</span> <span style="color: #6ab825; font-weight: bold">function</span> <span style="color: #447fcf">actionAddTrackingZendesk</span><span style="color: #d0d0d0">()</span>
   <span style="color: #d0d0d0">{</span>
		<span style="color: #40ffff">$data</span> <span style="color: #d0d0d0">=</span> <span style="color: #d0d0d0">craft()-&gt;</span><span style="color: #bbbbbb">request</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">getRestParams</span><span style="color: #d0d0d0">();</span>
		<span style="color: #6ab825; font-weight: bold">foreach</span><span style="color: #d0d0d0">(</span><span style="color: #40ffff">$data</span> <span style="color: #6ab825; font-weight: bold">as</span> <span style="color: #40ffff">$record</span><span style="color: #d0d0d0">)</span> <span style="color: #d0d0d0">{</span>
			<span style="color: #6ab825; font-weight: bold">if</span><span style="color: #d0d0d0">(</span><span style="color: #24909d">strpos</span><span style="color: #d0d0d0">(</span><span style="color: #ed9d13">&quot; &quot;</span> <span style="color: #d0d0d0">.</span> <span style="color: #40ffff">$record</span><span style="color: #d0d0d0">[</span><span style="color: #ed9d13">&#39;case&#39;</span><span style="color: #d0d0d0">],</span> <span style="color: #ed9d13">&quot;ZD&quot;</span><span style="color: #d0d0d0">)</span> <span style="color: #d0d0d0">&lt;</span> <span style="color: #3677a9">1</span><span style="color: #d0d0d0">)</span> <span style="color: #6ab825; font-weight: bold">continue</span><span style="color: #d0d0d0">;</span>
			<span style="color: #40ffff">$replace</span> <span style="color: #d0d0d0">=</span> <span style="color: #6ab825; font-weight: bold">array</span><span style="color: #d0d0d0">(</span><span style="color: #ed9d13">&quot;ZDCase# &quot;</span><span style="color: #d0d0d0">,</span><span style="color: #ed9d13">&quot;ZDC# &quot;</span><span style="color: #d0d0d0">,</span><span style="color: #ed9d13">&quot;ZD# &quot;</span><span style="color: #d0d0d0">);</span>
			<span style="color: #40ffff">$record</span><span style="color: #d0d0d0">[</span><span style="color: #ed9d13">&#39;case&#39;</span><span style="color: #d0d0d0">]</span> <span style="color: #d0d0d0">=</span> <span style="color: #24909d">str_replace</span><span style="color: #d0d0d0">(</span><span style="color: #40ffff">$replace</span><span style="color: #d0d0d0">,</span><span style="color: #ed9d13">&quot;&quot;</span><span style="color: #d0d0d0">,</span><span style="color: #40ffff">$record</span><span style="color: #d0d0d0">[</span><span style="color: #ed9d13">&#39;case&#39;</span><span style="color: #d0d0d0">]);</span>			

			<span style="color: #40ffff">$track</span> <span style="color: #d0d0d0">=</span> <span style="color: #40ffff">$record</span><span style="color: #d0d0d0">[</span><span style="color: #ed9d13">&#39;item&#39;</span><span style="color: #d0d0d0">]</span> <span style="color: #d0d0d0">.</span> <span style="color: #ed9d13">&quot;: Tracking# &quot;</span><span style="color: #d0d0d0">.</span> <span style="color: #40ffff">$record</span><span style="color: #d0d0d0">[</span><span style="color: #ed9d13">&#39;track&#39;</span><span style="color: #d0d0d0">];</span>
			<span style="color: #40ffff">$data_string</span> <span style="color: #d0d0d0">=</span> <span style="color: #ed9d13">&quot;{\&quot;</span><span style="color: #d0d0d0">ticket\</span><span style="color: #ed9d13">&quot;: {</span>
<span style="color: #ed9d13">			 \&quot;comment\&quot;:{\&quot;</span><span style="color: #6ab825; font-weight: bold">public</span><span style="color: #d0d0d0">\</span><span style="color: #ed9d13">&quot;:false, \&quot;body\&quot;: \&quot;$track\&quot;, \&quot;author_id\&quot;: 416847189}}}&quot;</span><span style="color: #d0d0d0">;</span>
			<span style="color: #40ffff">$this</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">sendToZendesk</span><span style="color: #d0d0d0">(</span><span style="color: #40ffff">$data_string</span><span style="color: #d0d0d0">,</span> <span style="color: #40ffff">$record</span><span style="color: #d0d0d0">[</span><span style="color: #ed9d13">&#39;case&#39;</span><span style="color: #d0d0d0">]);</span>
		<span style="color: #d0d0d0">}</span>    
		<span style="color: #40ffff">$this</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">returnJson</span><span style="color: #d0d0d0">(</span><span style="color: #ed9d13">&quot;success&quot;</span><span style="color: #d0d0d0">);</span>
	<span style="color: #d0d0d0">}</span>

   <span style="color: #6ab825; font-weight: bold">private</span> <span style="color: #6ab825; font-weight: bold">function</span> <span style="color: #447fcf">registerContracts</span><span style="color: #d0d0d0">(</span><span style="color: #40ffff">$contracts</span><span style="color: #d0d0d0">,</span><span style="color: #40ffff">$serial</span><span style="color: #d0d0d0">,</span><span style="color: #40ffff">$email</span><span style="color: #d0d0d0">)</span>
   <span style="color: #d0d0d0">{</span>
		<span style="color: #40ffff">$ewCodes</span><span style="color: #d0d0d0">=</span><span style="color: #6ab825; font-weight: bold">array</span><span style="color: #d0d0d0">();</span>

		<span style="color: #999999; font-style: italic">//Check each key</span>
		<span style="color: #40ffff">$type</span> <span style="color: #d0d0d0">=</span> <span style="color: #d0d0d0">strtolower(craft()-&gt;</span><span style="color: #bbbbbb">request</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">getPost</span><span style="color: #d0d0d0">(</span><span style="color: #ed9d13">&#39;type&#39;</span><span style="color: #d0d0d0">));</span>
		<span style="color: #40ffff">$type</span> <span style="color: #d0d0d0">=</span> <span style="color: #40ffff">$this</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">keyType</span><span style="color: #d0d0d0">(</span><span style="color: #40ffff">$type</span><span style="color: #d0d0d0">);</span>
		<span style="color: #6ab825; font-weight: bold">foreach</span><span style="color: #d0d0d0">(</span><span style="color: #40ffff">$contracts</span> <span style="color: #6ab825; font-weight: bold">as</span> <span style="color: #40ffff">$key</span><span style="color: #d0d0d0">){</span>
				<span style="color: #40ffff">$result</span> <span style="color: #d0d0d0">=</span> <span style="color: #40ffff">$this</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">mysqli</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">query</span><span style="color: #d0d0d0">(</span><span style="color: #ed9d13">&quot;SELECT redeemed FROM `contracts_view` WHERE REPLACE(`key`,&#39;-&#39;,&#39;&#39;) = REPLACE(&#39;$key&#39;,&#39;-&#39;,&#39;&#39;) $type&quot;</span><span style="color: #d0d0d0">);</span>
				<span style="color: #6ab825; font-weight: bold">if</span><span style="color: #d0d0d0">(</span><span style="color: #40ffff">$result</span> <span style="color: #d0d0d0">!=</span> <span style="color: #6ab825; font-weight: bold">false</span><span style="color: #d0d0d0">){</span>
					<span style="color: #6ab825; font-weight: bold">if</span><span style="color: #d0d0d0">(</span><span style="color: #40ffff">$result</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">num_rows</span><span style="color: #d0d0d0">&gt;</span><span style="color: #3677a9">0</span><span style="color: #d0d0d0">){</span>
						<span style="color: #6ab825; font-weight: bold">while</span><span style="color: #d0d0d0">(</span><span style="color: #40ffff">$row</span> <span style="color: #d0d0d0">=</span> <span style="color: #40ffff">$result</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">fetch_assoc</span><span style="color: #d0d0d0">()){</span>
							<span style="color: #6ab825; font-weight: bold">if</span><span style="color: #d0d0d0">(</span><span style="color: #40ffff">$row</span><span style="color: #d0d0d0">[</span><span style="color: #ed9d13">&#39;redeemed&#39;</span><span style="color: #d0d0d0">]</span> <span style="color: #d0d0d0">==</span> <span style="color: #6ab825; font-weight: bold">null</span><span style="color: #d0d0d0">)</span> <span style="color: #24909d">array_push</span><span style="color: #d0d0d0">(</span><span style="color: #40ffff">$ewCodes</span><span style="color: #d0d0d0">,</span><span style="color: #40ffff">$key</span><span style="color: #d0d0d0">);</span>
							<span style="color: #d0d0d0">}</span>
						<span style="color: #d0d0d0">}</span>
					<span style="color: #d0d0d0">}</span>
				<span style="color: #d0d0d0">}</span>

			<span style="color: #999999; font-style: italic">//Update keys as expended and add contract record associated with SN</span>
			<span style="color: #6ab825; font-weight: bold">foreach</span><span style="color: #d0d0d0">(</span><span style="color: #40ffff">$ewCodes</span> <span style="color: #6ab825; font-weight: bold">as</span> <span style="color: #40ffff">$key</span><span style="color: #d0d0d0">)</span> <span style="color: #40ffff">$result</span> <span style="color: #d0d0d0">=</span> <span style="color: #40ffff">$this</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">mysqli</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">query</span><span style="color: #d0d0d0">(</span><span style="color: #ed9d13">&quot;UPDATE `contracts` SET redeemed = CURDATE(), serial_number = &#39;$serial&#39;, email = &#39;$email&#39; WHERE REPLACE(`key`,&#39;-&#39;,&#39;&#39;) = REPLACE(&#39;$key&#39;,&#39;-&#39;,&#39;&#39;)&quot;</span><span style="color: #d0d0d0">);</span>
   <span style="color: #d0d0d0">}</span>

	<span style="color: #6ab825; font-weight: bold">private</span> <span style="color: #6ab825; font-weight: bold">function</span> <span style="color: #447fcf">sendEmail</span><span style="color: #d0d0d0">(</span><span style="color: #40ffff">$email_to</span><span style="color: #d0d0d0">,</span> <span style="color: #40ffff">$email_subject</span><span style="color: #d0d0d0">,</span> <span style="color: #40ffff">$email_html_msg</span><span style="color: #d0d0d0">)</span> 
	<span style="color: #d0d0d0">{</span>
		<span style="color: #40ffff">$email</span> <span style="color: #d0d0d0">=</span> <span style="color: #6ab825; font-weight: bold">new</span> <span style="color: #d0d0d0">EmailModel();</span>
		<span style="color: #40ffff">$email</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">toEmail</span> 	<span style="color: #d0d0d0">=</span> <span style="color: #40ffff">$email_to</span><span style="color: #d0d0d0">;</span>
		<span style="color: #40ffff">$email</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">subject</span> 	<span style="color: #d0d0d0">=</span> <span style="color: #40ffff">$email_subject</span><span style="color: #d0d0d0">;</span>
		<span style="color: #40ffff">$email</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">body</span>    	<span style="color: #d0d0d0">=</span> <span style="color: #40ffff">$email_html_msg</span><span style="color: #d0d0d0">;</span>
		<span style="color: #40ffff">$email</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">htmlBody</span>    <span style="color: #d0d0d0">=</span> <span style="color: #40ffff">$email_html_msg</span><span style="color: #d0d0d0">;</span>
		<span style="color: #d0d0d0">craft()-&gt;</span><span style="color: #bbbbbb">email</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">sendEmail</span><span style="color: #d0d0d0">(</span><span style="color: #40ffff">$email</span><span style="color: #d0d0d0">);</span>
	<span style="color: #d0d0d0">}</span>

   <span style="color: #6ab825; font-weight: bold">public</span> <span style="color: #6ab825; font-weight: bold">function</span> <span style="color: #447fcf">actionGetRMAs</span><span style="color: #d0d0d0">(){</span>
		<span style="color: #6ab825; font-weight: bold">if</span><span style="color: #d0d0d0">(craft()-&gt;</span><span style="color: #bbbbbb">request</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">getPost</span><span style="color: #d0d0d0">(</span><span style="color: #ed9d13">&#39;token&#39;</span><span style="color: #d0d0d0">)</span> <span style="color: #d0d0d0">!=</span> <span style="color: #d0d0d0">IFCAPIKEY)</span> <span style="color: #40ffff">$this</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">returnJson</span><span style="color: #d0d0d0">(</span><span style="color: #ed9d13">&quot;Access Denied&quot;</span><span style="color: #d0d0d0">);</span>
   		
   		<span style="color: #40ffff">$sql</span> <span style="color: #d0d0d0">=</span> <span style="color: #ed9d13">&quot;SELECT *  FROM NewRMAs&quot;</span><span style="color: #d0d0d0">;</span>
	    <span style="color: #40ffff">$result</span> <span style="color: #d0d0d0">=</span> <span style="color: #40ffff">$this</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">mysqli</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">query</span><span style="color: #d0d0d0">(</span><span style="color: #40ffff">$sql</span><span style="color: #d0d0d0">);</span>
	    <span style="color: #40ffff">$cr</span> <span style="color: #d0d0d0">=</span> <span style="color: #ed9d13">&quot;\r\n&quot;</span><span style="color: #d0d0d0">;</span>
	    <span style="color: #999999; font-style: italic">// $csvdata = &quot;&quot;;</span>
	    <span style="color: #999999; font-style: italic">// if($result-&gt;num_rows&gt;0) $csvdata = &#39;&quot;Order&quot;,&quot;Line Number&quot;&#39; .  $cr;</span>
	    <span style="color: #40ffff">$csvdata</span> <span style="color: #d0d0d0">=</span> <span style="color: #ed9d13">&quot;Order&quot;</span> <span style="color: #d0d0d0">.</span> <span style="color: #ed9d13">&#39;,&#39;</span> <span style="color: #d0d0d0">.</span> <span style="color: #ed9d13">&quot;Line Number&quot;</span>  <span style="color: #d0d0d0">.</span>  <span style="color: #40ffff">$cr</span><span style="color: #d0d0d0">;</span>
		<span style="color: #6ab825; font-weight: bold">while</span><span style="color: #d0d0d0">(</span><span style="color: #40ffff">$row</span> <span style="color: #d0d0d0">=</span> <span style="color: #40ffff">$result</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">fetch_array</span><span style="color: #d0d0d0">(MYSQL_NUM))</span> <span style="color: #40ffff">$csvdata</span> <span style="color: #d0d0d0">.=</span>  <span style="color: #ed9d13">&#39;&quot;&#39;</span> <span style="color: #d0d0d0">.</span> <span style="color: #24909d">implode</span><span style="color: #d0d0d0">(</span><span style="color: #ed9d13">&#39;&quot;,&quot;&#39;</span><span style="color: #d0d0d0">,</span> <span style="color: #40ffff">$row</span><span style="color: #d0d0d0">)</span> <span style="color: #d0d0d0">.</span> <span style="color: #ed9d13">&#39;&quot;&#39;</span>  <span style="color: #d0d0d0">.</span> <span style="color: #40ffff">$cr</span><span style="color: #d0d0d0">;</span>
		<span style="color: #40ffff">$this</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">returnJson</span><span style="color: #d0d0d0">(utf8_encode(</span><span style="color: #40ffff">$csvdata</span><span style="color: #d0d0d0">));</span>
		<span style="color: #999999; font-style: italic">// $sql = &quot;UPDATE virtual_transactions SET `status` = &#39;closed&#39; WHERE `status` = &#39;processed&#39;&quot;;</span>
	 <span style="color: #999999; font-style: italic">//    $result = $this-&gt;mysqli-&gt;query($sql);</span>
   <span style="color: #d0d0d0">}</span>

   <span style="color: #6ab825; font-weight: bold">public</span> <span style="color: #6ab825; font-weight: bold">function</span> <span style="color: #447fcf">actionGetSOs</span><span style="color: #d0d0d0">(){</span>
		<span style="color: #6ab825; font-weight: bold">if</span><span style="color: #d0d0d0">(craft()-&gt;</span><span style="color: #bbbbbb">request</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">getPost</span><span style="color: #d0d0d0">(</span><span style="color: #ed9d13">&#39;token&#39;</span><span style="color: #d0d0d0">)</span> <span style="color: #d0d0d0">!=</span> <span style="color: #d0d0d0">IFCAPIKEY)</span> <span style="color: #40ffff">$this</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">returnJson</span><span style="color: #d0d0d0">(</span><span style="color: #ed9d13">&quot;Access Denied&quot;</span><span style="color: #d0d0d0">);</span>
   		
   		<span style="color: #40ffff">$sql</span> <span style="color: #d0d0d0">=</span> <span style="color: #ed9d13">&quot;SELECT *  FROM NewSOs&quot;</span><span style="color: #d0d0d0">;</span>
	    <span style="color: #40ffff">$result</span> <span style="color: #d0d0d0">=</span> <span style="color: #40ffff">$this</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">mysqli</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">query</span><span style="color: #d0d0d0">(</span><span style="color: #40ffff">$sql</span><span style="color: #d0d0d0">);</span>
	    <span style="color: #40ffff">$cr</span> <span style="color: #d0d0d0">=</span> <span style="color: #ed9d13">&quot;\r\n&quot;</span><span style="color: #d0d0d0">;</span>
	    <span style="color: #999999; font-style: italic">// $csvdata = &quot;&quot;;</span>
	    <span style="color: #999999; font-style: italic">// if($result-&gt;num_rows&gt;0) $csvdata = &#39;&quot;Order&quot;,&quot;Line Number&quot;&#39; .  $cr;</span>
	    <span style="color: #40ffff">$csvdata</span> <span style="color: #d0d0d0">=</span> <span style="color: #ed9d13">&quot;Order&quot;</span> <span style="color: #d0d0d0">.</span> <span style="color: #ed9d13">&#39;,&#39;</span> <span style="color: #d0d0d0">.</span> <span style="color: #ed9d13">&quot;Line Number&quot;</span>  <span style="color: #d0d0d0">.</span>  <span style="color: #40ffff">$cr</span><span style="color: #d0d0d0">;</span>
		<span style="color: #6ab825; font-weight: bold">while</span><span style="color: #d0d0d0">(</span><span style="color: #40ffff">$row</span> <span style="color: #d0d0d0">=</span> <span style="color: #40ffff">$result</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">fetch_array</span><span style="color: #d0d0d0">(MYSQL_NUM))</span> <span style="color: #40ffff">$csvdata</span> <span style="color: #d0d0d0">.=</span>  <span style="color: #ed9d13">&#39;&quot;&#39;</span> <span style="color: #d0d0d0">.</span> <span style="color: #24909d">implode</span><span style="color: #d0d0d0">(</span><span style="color: #ed9d13">&#39;&quot;,&quot;&#39;</span><span style="color: #d0d0d0">,</span> <span style="color: #40ffff">$row</span><span style="color: #d0d0d0">)</span> <span style="color: #d0d0d0">.</span> <span style="color: #ed9d13">&#39;&quot;&#39;</span>  <span style="color: #d0d0d0">.</span> <span style="color: #40ffff">$cr</span><span style="color: #d0d0d0">;</span>
		<span style="color: #40ffff">$this</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">returnJson</span><span style="color: #d0d0d0">(utf8_encode(</span><span style="color: #40ffff">$csvdata</span><span style="color: #d0d0d0">));</span>
		<span style="color: #999999; font-style: italic">// $sql = &quot;UPDATE virtual_transactions SET `status` = &#39;closed&#39; WHERE `status` = &#39;processed&#39;&quot;;</span>
	 <span style="color: #999999; font-style: italic">//    $result = $this-&gt;mysqli-&gt;query($sql);</span>
   <span style="color: #d0d0d0">}</span>


   <span style="color: #6ab825; font-weight: bold">public</span> <span style="color: #6ab825; font-weight: bold">function</span> <span style="color: #447fcf">actionGetOpenOrders</span><span style="color: #d0d0d0">(){</span>
		<span style="color: #6ab825; font-weight: bold">if</span><span style="color: #d0d0d0">(craft()-&gt;</span><span style="color: #bbbbbb">request</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">getPost</span><span style="color: #d0d0d0">(</span><span style="color: #ed9d13">&#39;token&#39;</span><span style="color: #d0d0d0">)</span> <span style="color: #d0d0d0">!=</span> <span style="color: #d0d0d0">IFCAPIKEY)</span> <span style="color: #40ffff">$this</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">returnJson</span><span style="color: #d0d0d0">(</span><span style="color: #ed9d13">&quot;Access Denied&quot;</span><span style="color: #d0d0d0">);</span>
		<span style="color: #40ffff">$this</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">mysqli</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">select_db</span><span style="color: #d0d0d0">(</span><span style="color: #ed9d13">&#39;infocus_internal&#39;</span><span style="color: #d0d0d0">);</span>
   		
   		<span style="color: #40ffff">$sql</span> <span style="color: #d0d0d0">=</span> <span style="color: #ed9d13">&quot;SELECT * FROM order_set&quot;</span><span style="color: #d0d0d0">;</span>
	    <span style="color: #40ffff">$result</span> <span style="color: #d0d0d0">=</span> <span style="color: #40ffff">$this</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">mysqli</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">query</span><span style="color: #d0d0d0">(</span><span style="color: #40ffff">$sql</span><span style="color: #d0d0d0">);</span>
		<span style="color: #6ab825; font-weight: bold">while</span><span style="color: #d0d0d0">(</span><span style="color: #40ffff">$row</span> <span style="color: #d0d0d0">=</span> <span style="color: #40ffff">$result</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">fetch_array</span><span style="color: #d0d0d0">(MYSQL_NUM))</span> <span style="color: #40ffff">$return_data</span> <span style="color: #d0d0d0">=</span>  <span style="color: #40ffff">$row</span><span style="color: #d0d0d0">[</span><span style="color: #3677a9">0</span><span style="color: #d0d0d0">];</span>
		<span style="color: #40ffff">$this</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">returnJson</span><span style="color: #d0d0d0">(utf8_encode(</span><span style="color: #40ffff">$return_data</span><span style="color: #d0d0d0">));</span>
   <span style="color: #d0d0d0">}</span>

   <span style="color: #6ab825; font-weight: bold">public</span> <span style="color: #6ab825; font-weight: bold">function</span> <span style="color: #447fcf">actionPutAXTransUpdate</span><span style="color: #d0d0d0">()</span>
   <span style="color: #d0d0d0">{</span>
		<span style="color: #40ffff">$data</span> <span style="color: #d0d0d0">=</span> <span style="color: #d0d0d0">craft()-&gt;</span><span style="color: #bbbbbb">request</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">getRestParams</span><span style="color: #d0d0d0">();</span>
		<span style="color: #40ffff">$this</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">mysqli</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">select_db</span><span style="color: #d0d0d0">(</span><span style="color: #ed9d13">&#39;infocus_internal&#39;</span><span style="color: #d0d0d0">);</span>

   		<span style="color: #40ffff">$sql</span> <span style="color: #d0d0d0">=</span> <span style="color: #ed9d13">&quot;CREATE TABLE IF NOT EXISTS `orderModify` (</span>
<span style="color: #ed9d13">				  `case` VARCHAR(45) DEFAULT NULL,</span>
<span style="color: #ed9d13">				  `so` VARCHAR(255) DEFAULT NULL,</span>
<span style="color: #ed9d13">				  `rma` VARCHAR(45) DEFAULT NULL,</span>
<span style="color: #ed9d13">				  `account` VARCHAR(45) DEFAULT NULL,</span>
<span style="color: #ed9d13">				  `tracking` VARCHAR(90) DEFAULT NULL,</span>
<span style="color: #ed9d13">				  `error` VARCHAR(255) DEFAULT NULL,</span>
<span style="color: #ed9d13">				  PRIMARY KEY (`case`));&quot;</span><span style="color: #d0d0d0">;</span>
	    <span style="color: #40ffff">$this</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">mysqli</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">query</span><span style="color: #d0d0d0">(</span><span style="color: #40ffff">$sql</span><span style="color: #d0d0d0">);</span>

		<span style="color: #40ffff">$fields</span> <span style="color: #d0d0d0">=</span> <span style="color: #6ab825; font-weight: bold">array</span><span style="color: #d0d0d0">(</span><span style="color: #ed9d13">&#39;case&#39;</span><span style="color: #d0d0d0">,</span> <span style="color: #ed9d13">&#39;so&#39;</span><span style="color: #d0d0d0">,</span> <span style="color: #ed9d13">&#39;rma&#39;</span><span style="color: #d0d0d0">,</span> <span style="color: #ed9d13">&#39;account&#39;</span><span style="color: #d0d0d0">,</span> <span style="color: #ed9d13">&#39;tracking&#39;</span><span style="color: #d0d0d0">,</span><span style="color: #ed9d13">&#39;error&#39;</span><span style="color: #d0d0d0">);</span>
		<span style="color: #40ffff">$sql</span> <span style="color: #d0d0d0">=</span> <span style="color: #ed9d13">&quot;INSERT IGNORE INTO orderModify SET&quot;</span><span style="color: #d0d0d0">;</span>
		<span style="color: #40ffff">$this</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">bindAndExecute</span><span style="color: #d0d0d0">(</span><span style="color: #40ffff">$fields</span><span style="color: #d0d0d0">,</span> <span style="color: #40ffff">$sql</span><span style="color: #d0d0d0">,</span> <span style="color: #40ffff">$data</span><span style="color: #d0d0d0">);</span>

   		<span style="color: #40ffff">$sql</span> <span style="color: #d0d0d0">=</span> <span style="color: #ed9d13">&quot;UPDATE orderModify SET so = if(so IN(&#39;NULL&#39;,&#39;&#39;),NULL,so),rma = if(rma IN(&#39;NULL&#39;,&#39;&#39;),NULL,rma),account = if(account IN(&#39;NULL&#39;,&#39;&#39;),NULL,account),tracking = if(tracking IN(&#39;NULL&#39;,&#39;&#39;),NULL,tracking), `error` = if(`error` IN(&#39;NULL&#39;,&#39;&#39;),NULL,`error`) WHERE `case` IS NOT NULL&quot;</span><span style="color: #d0d0d0">;</span>
	    <span style="color: #40ffff">$this</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">mysqli</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">query</span><span style="color: #d0d0d0">(</span><span style="color: #40ffff">$sql</span><span style="color: #d0d0d0">);</span>

   		<span style="color: #40ffff">$sql</span> <span style="color: #d0d0d0">=</span> <span style="color: #ed9d13">&quot;UPDATE ax_transactions at JOIN (SELECT * FROM orderModify ORDER BY `error` DESC) as om ON `case` = `id`</span>
<span style="color: #ed9d13">					SET at.note = error, at.rma = if( at.rma = &#39;&#39; OR at.rma IS NULL, om.rma, at.rma), at.sales_order = if( at.sales_order = &#39;&#39; OR at.sales_order IS NULL, om.so, at.sales_order), at.account = if( at.account = &#39;&#39; OR at.account IS NULL, om.account, at.account), `status` = IF(`error` IS NULL,&#39;Processed&#39;,&#39;Err&#39;)&quot;</span><span style="color: #d0d0d0">;</span>
	    <span style="color: #40ffff">$this</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">mysqli</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">query</span><span style="color: #d0d0d0">(</span><span style="color: #40ffff">$sql</span><span style="color: #d0d0d0">);</span>

   		<span style="color: #40ffff">$sql</span> <span style="color: #d0d0d0">=</span> <span style="color: #ed9d13">&quot;DROP TABLE `orderModify`&quot;</span><span style="color: #d0d0d0">;</span>
	    <span style="color: #40ffff">$this</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">mysqli</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">query</span><span style="color: #d0d0d0">(</span><span style="color: #40ffff">$sql</span><span style="color: #d0d0d0">);</span>
	    <span style="color: #40ffff">$this</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">actionUpdateZendesk</span><span style="color: #d0d0d0">();</span>
		<span style="color: #40ffff">$this</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">returnJson</span><span style="color: #d0d0d0">(</span><span style="color: #ed9d13">&quot;success&quot;</span><span style="color: #d0d0d0">);</span>

   <span style="color: #d0d0d0">}</span>

   <span style="color: #6ab825; font-weight: bold">public</span> <span style="color: #6ab825; font-weight: bold">function</span> <span style="color: #447fcf">actionGetReturnOrders</span><span style="color: #d0d0d0">(){</span>
		<span style="color: #6ab825; font-weight: bold">if</span><span style="color: #d0d0d0">(craft()-&gt;</span><span style="color: #bbbbbb">request</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">getPost</span><span style="color: #d0d0d0">(</span><span style="color: #ed9d13">&#39;token&#39;</span><span style="color: #d0d0d0">)</span> <span style="color: #d0d0d0">!=</span> <span style="color: #d0d0d0">IFCAPIKEY)</span> <span style="color: #40ffff">$this</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">returnJson</span><span style="color: #d0d0d0">(</span><span style="color: #ed9d13">&quot;Access Denied&quot;</span><span style="color: #d0d0d0">);</span>
 		<span style="color: #40ffff">$this</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">mysqli</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">select_db</span><span style="color: #d0d0d0">(</span><span style="color: #ed9d13">&#39;infocus_internal&#39;</span><span style="color: #d0d0d0">);</span>
  		
   		<span style="color: #40ffff">$sql</span> <span style="color: #d0d0d0">=</span> <span style="color: #ed9d13">&quot;UPDATE ax_transactions SET `status` = &#39;Processing&#39; WHERE `order_pool` NOT IN(&#39;NCO SVC&#39;,&#39;STANDARD&#39;)</span>
<span style="color: #ed9d13">            AND `org` != &#39;test&#39; AND `status` IN(&#39;Created&#39;,&#39;Updated&#39;)&quot;</span><span style="color: #d0d0d0">;</span>
	    <span style="color: #40ffff">$result</span> <span style="color: #d0d0d0">=</span> <span style="color: #40ffff">$this</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">mysqli</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">query</span><span style="color: #d0d0d0">(</span><span style="color: #40ffff">$sql</span><span style="color: #d0d0d0">);</span>

   		<span style="color: #40ffff">$sql</span> <span style="color: #d0d0d0">=</span> <span style="color: #ed9d13">&quot;SELECT * FROM new_rma&quot;</span><span style="color: #d0d0d0">;</span>
	    <span style="color: #40ffff">$result</span> <span style="color: #d0d0d0">=</span> <span style="color: #40ffff">$this</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">mysqli</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">query</span><span style="color: #d0d0d0">(</span><span style="color: #40ffff">$sql</span><span style="color: #d0d0d0">);</span>
	    <span style="color: #40ffff">$cr</span> <span style="color: #d0d0d0">=</span> <span style="color: #ed9d13">&quot;\r\n&quot;</span><span style="color: #d0d0d0">;</span>
	    <span style="color: #40ffff">$delimiter</span> <span style="color: #d0d0d0">=</span> <span style="color: #ed9d13">&quot;^&quot;</span><span style="color: #d0d0d0">;</span>
	    <span style="color: #40ffff">$fields</span><span style="color: #d0d0d0">=[];</span>
		<span style="color: #6ab825; font-weight: bold">for</span> <span style="color: #d0d0d0">(</span><span style="color: #40ffff">$i</span><span style="color: #d0d0d0">=</span><span style="color: #3677a9">0</span><span style="color: #d0d0d0">;</span> <span style="color: #40ffff">$i</span> <span style="color: #d0d0d0">&lt;</span> <span style="color: #40ffff">$result</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">field_count</span><span style="color: #d0d0d0">;</span> <span style="color: #40ffff">$i</span><span style="color: #d0d0d0">++)</span> <span style="color: #40ffff">$fields</span><span style="color: #d0d0d0">[]</span> <span style="color: #d0d0d0">=</span> <span style="color: #40ffff">$result</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">fetch_field_direct</span><span style="color: #d0d0d0">(</span><span style="color: #40ffff">$i</span><span style="color: #d0d0d0">)-&gt;</span><span style="color: #bbbbbb">name</span><span style="color: #d0d0d0">;</span>
	    <span style="color: #40ffff">$csvdata</span> <span style="color: #d0d0d0">=</span>  <span style="color: #ed9d13">&#39;&quot;&#39;</span><span style="color: #d0d0d0">.</span><span style="color: #24909d">implode</span><span style="color: #d0d0d0">(</span><span style="color: #ed9d13">&#39;&quot;&#39;</span><span style="color: #d0d0d0">.</span><span style="color: #40ffff">$delimiter</span><span style="color: #d0d0d0">.</span><span style="color: #ed9d13">&#39;&quot;&#39;</span><span style="color: #d0d0d0">,</span> <span style="color: #40ffff">$fields</span><span style="color: #d0d0d0">)</span> <span style="color: #d0d0d0">.</span>  <span style="color: #ed9d13">&#39;&quot;&#39;</span><span style="color: #d0d0d0">.</span><span style="color: #40ffff">$cr</span><span style="color: #d0d0d0">;</span>
		<span style="color: #6ab825; font-weight: bold">while</span><span style="color: #d0d0d0">(</span><span style="color: #40ffff">$row</span> <span style="color: #d0d0d0">=</span> <span style="color: #40ffff">$result</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">fetch_array</span><span style="color: #d0d0d0">(MYSQL_NUM))</span> <span style="color: #40ffff">$csvdata</span> <span style="color: #d0d0d0">.=</span>  <span style="color: #ed9d13">&#39;&quot;&#39;</span> <span style="color: #d0d0d0">.</span> <span style="color: #24909d">implode</span><span style="color: #d0d0d0">(</span><span style="color: #ed9d13">&#39;&quot;&#39;</span><span style="color: #d0d0d0">.</span><span style="color: #40ffff">$delimiter</span><span style="color: #d0d0d0">.</span><span style="color: #ed9d13">&#39;&quot;&#39;</span><span style="color: #d0d0d0">,</span> <span style="color: #40ffff">$row</span><span style="color: #d0d0d0">)</span> <span style="color: #d0d0d0">.</span> <span style="color: #ed9d13">&#39;&quot;&#39;</span>  <span style="color: #d0d0d0">.</span> <span style="color: #40ffff">$cr</span><span style="color: #d0d0d0">;</span>
		<span style="color: #40ffff">$this</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">returnJson</span><span style="color: #d0d0d0">(utf8_encode(</span><span style="color: #40ffff">$csvdata</span><span style="color: #d0d0d0">));</span>
   <span style="color: #d0d0d0">}</span>

   <span style="color: #6ab825; font-weight: bold">public</span> <span style="color: #6ab825; font-weight: bold">function</span> <span style="color: #447fcf">actionGetSalesOrders</span><span style="color: #d0d0d0">(){</span>
		<span style="color: #6ab825; font-weight: bold">if</span><span style="color: #d0d0d0">(craft()-&gt;</span><span style="color: #bbbbbb">request</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">getPost</span><span style="color: #d0d0d0">(</span><span style="color: #ed9d13">&#39;token&#39;</span><span style="color: #d0d0d0">)</span> <span style="color: #d0d0d0">!=</span> <span style="color: #d0d0d0">IFCAPIKEY)</span> <span style="color: #40ffff">$this</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">returnJson</span><span style="color: #d0d0d0">(</span><span style="color: #ed9d13">&quot;Access Denied&quot;</span><span style="color: #d0d0d0">);</span>
 		<span style="color: #40ffff">$this</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">mysqli</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">select_db</span><span style="color: #d0d0d0">(</span><span style="color: #ed9d13">&#39;infocus_internal&#39;</span><span style="color: #d0d0d0">);</span>
   		
   		<span style="color: #40ffff">$sql</span> <span style="color: #d0d0d0">=</span> <span style="color: #ed9d13">&quot;UPDATE ax_transactions SET `status` = &#39;Processing&#39; WHERE `order_pool` IN(&#39;NCO SVC&#39;,&#39;STANDARD&#39;)</span>
<span style="color: #ed9d13">            AND `org` != &#39;test&#39; AND `status` IN(&#39;Created&#39;,&#39;Updated&#39;)&quot;</span><span style="color: #d0d0d0">;</span>
	    <span style="color: #40ffff">$result</span> <span style="color: #d0d0d0">=</span> <span style="color: #40ffff">$this</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">mysqli</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">query</span><span style="color: #d0d0d0">(</span><span style="color: #40ffff">$sql</span><span style="color: #d0d0d0">);</span>

   		<span style="color: #40ffff">$sql</span> <span style="color: #d0d0d0">=</span> <span style="color: #ed9d13">&quot;SELECT * FROM new_so&quot;</span><span style="color: #d0d0d0">;</span>
	    <span style="color: #40ffff">$result</span> <span style="color: #d0d0d0">=</span> <span style="color: #40ffff">$this</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">mysqli</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">query</span><span style="color: #d0d0d0">(</span><span style="color: #40ffff">$sql</span><span style="color: #d0d0d0">);</span>
	    <span style="color: #40ffff">$cr</span> <span style="color: #d0d0d0">=</span> <span style="color: #ed9d13">&quot;\r\n&quot;</span><span style="color: #d0d0d0">;</span>
	    <span style="color: #40ffff">$delimiter</span> <span style="color: #d0d0d0">=</span> <span style="color: #ed9d13">&quot;^&quot;</span><span style="color: #d0d0d0">;</span>
	    <span style="color: #40ffff">$fields</span><span style="color: #d0d0d0">=[];</span>
		<span style="color: #6ab825; font-weight: bold">for</span> <span style="color: #d0d0d0">(</span><span style="color: #40ffff">$i</span><span style="color: #d0d0d0">=</span><span style="color: #3677a9">0</span><span style="color: #d0d0d0">;</span> <span style="color: #40ffff">$i</span> <span style="color: #d0d0d0">&lt;</span> <span style="color: #40ffff">$result</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">field_count</span><span style="color: #d0d0d0">;</span> <span style="color: #40ffff">$i</span><span style="color: #d0d0d0">++)</span> <span style="color: #40ffff">$fields</span><span style="color: #d0d0d0">[]</span> <span style="color: #d0d0d0">=</span> <span style="color: #40ffff">$result</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">fetch_field_direct</span><span style="color: #d0d0d0">(</span><span style="color: #40ffff">$i</span><span style="color: #d0d0d0">)-&gt;</span><span style="color: #bbbbbb">name</span><span style="color: #d0d0d0">;</span>
	    <span style="color: #40ffff">$csvdata</span> <span style="color: #d0d0d0">=</span>  <span style="color: #24909d">implode</span><span style="color: #d0d0d0">(</span><span style="color: #ed9d13">&#39;&quot;&#39;</span><span style="color: #d0d0d0">.</span><span style="color: #40ffff">$delimiter</span><span style="color: #d0d0d0">.</span><span style="color: #ed9d13">&#39;&quot;&#39;</span><span style="color: #d0d0d0">,</span> <span style="color: #40ffff">$fields</span><span style="color: #d0d0d0">)</span> <span style="color: #d0d0d0">.</span>  <span style="color: #40ffff">$cr</span><span style="color: #d0d0d0">;</span>
		<span style="color: #6ab825; font-weight: bold">while</span><span style="color: #d0d0d0">(</span><span style="color: #40ffff">$row</span> <span style="color: #d0d0d0">=</span> <span style="color: #40ffff">$result</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">fetch_array</span><span style="color: #d0d0d0">(MYSQL_NUM))</span> <span style="color: #40ffff">$csvdata</span> <span style="color: #d0d0d0">.=</span>  <span style="color: #ed9d13">&#39;&quot;&#39;</span> <span style="color: #d0d0d0">.</span> <span style="color: #24909d">implode</span><span style="color: #d0d0d0">(</span><span style="color: #ed9d13">&#39;&quot;&#39;</span><span style="color: #d0d0d0">.</span><span style="color: #40ffff">$delimiter</span><span style="color: #d0d0d0">.</span><span style="color: #ed9d13">&#39;&quot;&#39;</span><span style="color: #d0d0d0">,</span> <span style="color: #40ffff">$row</span><span style="color: #d0d0d0">)</span> <span style="color: #d0d0d0">.</span> <span style="color: #ed9d13">&#39;&quot;&#39;</span>  <span style="color: #d0d0d0">.</span> <span style="color: #40ffff">$cr</span><span style="color: #d0d0d0">;</span>
		<span style="color: #40ffff">$this</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">returnJson</span><span style="color: #d0d0d0">(utf8_encode(</span><span style="color: #40ffff">$csvdata</span><span style="color: #d0d0d0">));</span>
   <span style="color: #d0d0d0">}</span>

   <span style="color: #6ab825; font-weight: bold">private</span> <span style="color: #6ab825; font-weight: bold">function</span> <span style="color: #447fcf">bindAndExecute</span><span style="color: #d0d0d0">(</span><span style="color: #40ffff">$fields</span><span style="color: #d0d0d0">,</span> <span style="color: #40ffff">$sql</span><span style="color: #d0d0d0">,</span> <span style="color: #40ffff">$data</span><span style="color: #d0d0d0">)</span>
   <span style="color: #d0d0d0">{</span>
   		<span style="color: #40ffff">$sql</span> <span style="color: #d0d0d0">.=</span> <span style="color: #ed9d13">&quot;`&quot;</span> <span style="color: #d0d0d0">.</span> <span style="color: #24909d">implode</span><span style="color: #d0d0d0">(</span><span style="color: #ed9d13">&quot;` = ?, `&quot;</span><span style="color: #d0d0d0">,</span> <span style="color: #40ffff">$fields</span><span style="color: #d0d0d0">)</span> <span style="color: #d0d0d0">.</span> <span style="color: #ed9d13">&quot;` = ?&quot;</span><span style="color: #d0d0d0">;</span>
		<span style="color: #40ffff">$param_binding</span> <span style="color: #d0d0d0">=</span> <span style="color: #d0d0d0">substr(</span><span style="color: #ed9d13">&quot;ssssssssssssssssssssssssssssssssssssss&quot;</span><span style="color: #d0d0d0">,</span> <span style="color: #3677a9">0</span><span style="color: #d0d0d0">,</span> <span style="color: #d0d0d0">COUNT(</span><span style="color: #40ffff">$fields</span><span style="color: #d0d0d0">));</span>
		<span style="color: #40ffff">$update</span> <span style="color: #d0d0d0">=</span> <span style="color: #40ffff">$this</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">mysqli</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">prepare</span><span style="color: #d0d0d0">(</span><span style="color: #40ffff">$sql</span><span style="color: #d0d0d0">);</span>
		<span style="color: #6ab825; font-weight: bold">foreach</span><span style="color: #d0d0d0">(</span><span style="color: #40ffff">$data</span> <span style="color: #6ab825; font-weight: bold">as</span> <span style="color: #40ffff">$record</span><span style="color: #d0d0d0">)</span> <span style="color: #d0d0d0">{</span>
			<span style="color: #6ab825; font-weight: bold">if</span><span style="color: #d0d0d0">(substr(</span><span style="color: #40ffff">$record</span><span style="color: #d0d0d0">[</span><span style="color: #40ffff">$fields</span><span style="color: #d0d0d0">[</span><span style="color: #3677a9">0</span><span style="color: #d0d0d0">]],</span> <span style="color: #3677a9">0</span><span style="color: #d0d0d0">,</span><span style="color: #3677a9">1</span><span style="color: #d0d0d0">)</span> <span style="color: #d0d0d0">==</span> <span style="color: #ed9d13">&quot;(&quot;</span> <span style="color: #6ab825; font-weight: bold">OR</span> <span style="color: #d0d0d0">!</span><span style="color: #40ffff">$record</span><span style="color: #d0d0d0">[</span><span style="color: #40ffff">$fields</span><span style="color: #d0d0d0">[</span><span style="color: #3677a9">0</span><span style="color: #d0d0d0">]])</span> <span style="color: #6ab825; font-weight: bold">continue</span><span style="color: #d0d0d0">;</span>
			<span style="color: #40ffff">$param</span> <span style="color: #d0d0d0">=</span> <span style="color: #d0d0d0">[];</span>
			<span style="color: #40ffff">$param</span><span style="color: #d0d0d0">[]</span> <span style="color: #d0d0d0">=</span> <span style="color: #40ffff">$param_binding</span><span style="color: #d0d0d0">;</span>
			<span style="color: #6ab825; font-weight: bold">foreach</span> <span style="color: #d0d0d0">(</span><span style="color: #40ffff">$fields</span> <span style="color: #6ab825; font-weight: bold">as</span> <span style="color: #40ffff">$key</span><span style="color: #d0d0d0">)</span> <span style="color: #40ffff">$param</span><span style="color: #d0d0d0">[]</span> <span style="color: #d0d0d0">=</span> <span style="color: #d0d0d0">&amp;</span><span style="color: #40ffff">$record</span><span style="color: #d0d0d0">[</span><span style="color: #40ffff">$key</span><span style="color: #d0d0d0">];</span> 
			<span style="color: #24909d">call_user_func_array</span><span style="color: #d0d0d0">(</span><span style="color: #6ab825; font-weight: bold">array</span><span style="color: #d0d0d0">(</span><span style="color: #40ffff">$update</span><span style="color: #d0d0d0">,</span> <span style="color: #ed9d13">&#39;bind_param&#39;</span><span style="color: #d0d0d0">),</span> <span style="color: #40ffff">$param</span><span style="color: #d0d0d0">);</span>
			<span style="color: #40ffff">$update</span><span style="color: #d0d0d0">-&gt;</span><span style="color: #bbbbbb">execute</span><span style="color: #d0d0d0">();</span>
		<span style="color: #d0d0d0">}</span>    
   <span style="color: #d0d0d0">}</span>

   <span style="color: #6ab825; font-weight: bold">private</span> <span style="color: #6ab825; font-weight: bold">function</span> <span style="color: #447fcf">sendToZendesk</span><span style="color: #d0d0d0">(</span><span style="color: #40ffff">$data_string</span><span style="color: #d0d0d0">,</span> <span style="color: #40ffff">$case</span><span style="color: #d0d0d0">)</span>
   <span style="color: #d0d0d0">{</span>
			<span style="color: #40ffff">$ch</span> <span style="color: #d0d0d0">=</span> <span style="color: #24909d">curl_init</span><span style="color: #d0d0d0">(</span><span style="color: #ed9d13">&quot;https://infocuscorp.zendesk.com/api/v2/tickets/$case.json&quot;</span><span style="color: #d0d0d0">);</span>                                                                      
			<span style="color: #24909d">curl_setopt</span><span style="color: #d0d0d0">(</span><span style="color: #40ffff">$ch</span><span style="color: #d0d0d0">,</span> <span style="color: #d0d0d0">CURLOPT_CUSTOMREQUEST,</span> <span style="color: #ed9d13">&quot;PUT&quot;</span><span style="color: #d0d0d0">);</span>                                                                     
			<span style="color: #24909d">curl_setopt</span><span style="color: #d0d0d0">(</span><span style="color: #40ffff">$ch</span><span style="color: #d0d0d0">,</span> <span style="color: #d0d0d0">CURLOPT_USERPWD,</span> <span style="color: #d0d0d0">ZDUSER.</span><span style="color: #ed9d13">&quot;/token:&quot;</span><span style="color: #d0d0d0">.ZDAPIKEY);</span>
			<span style="color: #24909d">curl_setopt</span><span style="color: #d0d0d0">(</span><span style="color: #40ffff">$ch</span><span style="color: #d0d0d0">,</span> <span style="color: #d0d0d0">CURLOPT_POSTFIELDS,</span> <span style="color: #40ffff">$data_string</span><span style="color: #d0d0d0">);</span>                                                                  
			<span style="color: #24909d">curl_setopt</span><span style="color: #d0d0d0">(</span><span style="color: #40ffff">$ch</span><span style="color: #d0d0d0">,</span> <span style="color: #d0d0d0">CURLOPT_RETURNTRANSFER,</span> <span style="color: #6ab825; font-weight: bold">true</span><span style="color: #d0d0d0">);</span>                                                                      
			<span style="color: #24909d">curl_setopt</span><span style="color: #d0d0d0">(</span><span style="color: #40ffff">$ch</span><span style="color: #d0d0d0">,</span> <span style="color: #d0d0d0">CURLOPT_HTTPHEADER,</span> <span style="color: #6ab825; font-weight: bold">array</span><span style="color: #d0d0d0">(</span>                                                                          
			    <span style="color: #ed9d13">&#39;Content-Type: application/json&#39;</span><span style="color: #d0d0d0">,</span>                                                                                
			    <span style="color: #ed9d13">&#39;Content-Length: &#39;</span> <span style="color: #d0d0d0">.</span> <span style="color: #24909d">strlen</span><span style="color: #d0d0d0">(</span><span style="color: #40ffff">$data_string</span><span style="color: #d0d0d0">))</span>                                                                       
			<span style="color: #d0d0d0">);</span>                                                                                                                   

			<span style="color: #40ffff">$chresult</span> <span style="color: #d0d0d0">=</span> <span style="color: #24909d">curl_exec</span><span style="color: #d0d0d0">(</span><span style="color: #40ffff">$ch</span><span style="color: #d0d0d0">);</span>
			<span style="color: #40ffff">$info</span> <span style="color: #d0d0d0">=</span> <span style="color: #24909d">curl_getinfo</span><span style="color: #d0d0d0">(</span><span style="color: #40ffff">$ch</span><span style="color: #d0d0d0">);</span>

			<span style="color: #6ab825; font-weight: bold">if</span><span style="color: #d0d0d0">(</span><span style="color: #40ffff">$info</span><span style="color: #d0d0d0">[</span><span style="color: #ed9d13">&#39;http_code&#39;</span><span style="color: #d0d0d0">]</span> <span style="color: #d0d0d0">==</span> <span style="color: #3677a9">422</span><span style="color: #d0d0d0">){</span>
				<span style="color: #999999; font-style: italic">//print_r($data_string);</span>
				<span style="color: #999999; font-style: italic">//exit();</span>
				<span style="color: #999999; font-style: italic">//$data_string = json_decode($data_string);</span>
				<span style="color: #999999; font-style: italic">//$this-&gt;returnJson($data_string);</span>
			<span style="color: #d0d0d0">}</span>
			<span style="color: #6ab825; font-weight: bold">return</span> <span style="color: #40ffff">$info</span><span style="color: #d0d0d0">;</span>
   <span style="color: #d0d0d0">}</span>

<span style="color: #d0d0d0">}</span>
</pre></div>
